{% extends "base.html" %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="{{ url_for('main.packing_jobs') }}">Packing Jobs</a></li>
    <li class="breadcrumb-item active" aria-current="page">Create New Job</li>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="bi bi-plus-circle"></i> Create New Packing Job</h4>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('main.add_packing_job') }}" id="packingJobForm" novalidate>
        <div class="mb-3">
            <label for="name" class="form-label">Job Name</label>
            <input type="text" class="form-control" id="name" name="name" required>
        </div>
        <div class="mb-3">
            <label class="form-label">Specify Quantity for Each Truck Type</label>
            {% for truck in truck_types %}
            <div class="input-group mb-2">
                <span class="input-group-text" style="width: 300px;">{{ truck.name }} ({{ truck.length }}x{{ truck.width }}x{{ truck.height }})</span>
                <input type="number" class="form-control" name="truck_{{ truck.id }}" value="0" min="0">
            </div>
            {% endfor %}
        </div>
        <div class="mb-3">
            <label for="optimization_goal" class="form-label">Optimization Goal</label>
            <select class="form-select" id="optimization_goal" name="optimization_goal">
                <option value="space">Maximize Space Utilization</option>
                <option value="cost">Minimize Cost</option>
                <option value="weight">Balance Weight</option>
                <option value="min_trucks">Minimize Number of Trucks</option>
            </select>
        </div>
        <hr>
        <h5>Cartons</h5>
        <div id="carton-fields">
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Carton Type</label>
                    <select class="form-select carton-type-select" name="carton_type_1" required>
                        {% for carton in carton_types %}
                        <option value="{{ carton.id }}" data-volume="{{ carton.length * carton.width * carton.height }}">{{ carton.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Quantity</label>
                    <input type="number" class="form-control carton-quantity" name="quantity_1" required>
                </div>
            </div>
        </div>
        <button type="button" class="btn btn-secondary" id="add-carton-field">Add Another Carton Type</button>
        <hr>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary"><i class="bi bi-check-circle"></i> Create Job</button>
                            <a href="{{ url_for('main.packing_jobs') }}" class="btn btn-secondary"><i class="bi bi-x-circle"></i> Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add progress bar to packing job form
        $('#packingJobForm').on('submit', function(e) {
            const steps = [
                'Validating job parameters...',
                'Loading truck fleet data...',
                'Processing carton specifications...',
                'Initializing optimization engine...',
                'Running 3D bin packing algorithm...',
                'Calculating optimal arrangements...',
                'Performing cost analysis...',
                'Generating detailed reports...',
                'Creating 3D visualizations...',
                'Finalizing packing job...'
            ];
            
            showProgressWithSteps('Creating Packing Job', steps);
        });
        
        let cartonCount = 1;
        document.getElementById('add-carton-field').addEventListener('click', function() {
            cartonCount++;
            let newField = `
            <div class="row mb-3 carton-row">
                <div class="col-md-6">
                    <label class="form-label">Carton Type</label>
                    <select class="form-select" name="carton_type_${cartonCount}" required>
                        {% for carton in carton_types %}
                        <option value="{{ carton.id }}">{{ carton.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Quantity</label>
                    <input type="number" class="form-control" name="quantity_${cartonCount}" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button type="button" class="btn btn-danger remove-carton-row w-100">Remove</button>
                </div>
            </div>`;
            document.getElementById('carton-fields').insertAdjacentHTML('beforeend', newField);
        });

        document.getElementById('carton-fields').addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('remove-carton-row')) {
                e.target.closest('.carton-row').remove();
            }
        });
    });
</script>
{% endblock %}