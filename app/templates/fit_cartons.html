{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <div class="card shadow mb-4">
    <div class="card-header bg-primary text-white">
      <h4 class="mb-0"><i class="bi bi-boxes"></i> Fit Cartons in Selected Trucks</h4>
    </div>
    <div class="card-body">
      <form method="post" id="fitCartonForm">
        <div class="mb-3">
            <label class="form-label">Specify Quantity for Each Truck Type</label>
            {% for truck in trucks %}
            <div class="input-group mb-2">
                <span class="input-group-text" style="width: 300px;">{{ truck.name }} ({{ truck.length }}x{{ truck.width }}x{{ truck.height }})</span>
                <input type="number" class="form-control" name="truck_{{ truck.id }}" value="0" min="0">
            </div>
            {% endfor %}
        </div>
        <div id="fitCartonRows">
          <div class="row mb-2 carton-row align-items-end">
            <div class="col-md-6">
              <label class="form-label">Carton Type</label>
              <select name="carton_type_1" class="form-select carton-type-select" required>
                <option value="" disabled selected>Select Carton Type</option>
                {% for carton in cartons %}
                <option value="{{ carton.id }}" data-size="{{ carton.length }}x{{ carton.width }}x{{ carton.height }}">
                  {{ carton.name }} ({{ carton.length }}x{{ carton.width }}x{{ carton.height }} cm)
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Quantity</label>
              <input type="number" name="carton_qty_1" class="form-control" min="1" placeholder="Quantity" required>
            </div>
            <div class="col-md-3">
              <button type="button" class="btn btn-danger remove-row" style="display:none">Remove</button>
            </div>
          </div>
        </div>
        <div class="d-flex gap-2 mb-3">
          <button type="button" class="btn btn-outline-secondary" id="addFitRow"><i class="bi bi-plus-lg"></i> Add Carton</button>
          <button type="submit" class="btn btn-success" id="fitCartonBtn"><i class="bi bi-search"></i> Fit Cartons</button>
        </div>
      </form>
    </div>
  </div>

  {% if fit_results %}
  <div class="card shadow">
    <div class="card-header bg-info text-white">
      <h5 class="mb-0"><i class="bi bi-truck"></i> Fit Results</h5>
    </div>
    <div class="card-body">
      <table id="fitTable" class="table table-bordered table-hover">
        <thead class="table-light">
          <tr><th>Truck</th><th>Utilization</th><th>Cartons Fitted</th><th>Unfitted</th></tr>
        </thead>
        <tbody>
        {% for r in fit_results %}
        <tr>
          <td>{{ r.bin_name }}</td>
          <td>{{ (r.utilization*100)|round(2) }}%</td>
          <td>{{ r.fitted_items|length }}</td>
          <td>{{ r.unfitted_items|length }}</td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
      
      <!-- 3D Visualizations -->
      {% for r in fit_results %}
        {% if r.fitted_items %}
        <div class="mt-4">
          <h6>3D Visualization - {{ r.bin_name }}</h6>
          <div id="fit-visualization-{{ loop.index }}" style="width:100%;height:400px;border:1px solid #ddd;position:relative;"></div>
        </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>
  {% endif %}
</div>
<!-- Results now shown in card above -->
{% endblock %}
{% block scripts %}
<script>
let fitRowCount = 1;

// Add progress bar to fit cartons form submission
document.getElementById('fitCartonForm').addEventListener('submit', function(e) {
    const steps = [
        'Validating truck and carton data...',
        'Initializing 3D packing algorithm...',
        'Fitting cartons into selected trucks...',
        'Calculating space utilization...',
        'Generating 3D visualization...',
        'Preparing results...'
    ];
    
    showProgressWithSteps('Fitting Cartons into Trucks', steps);
});

document.getElementById('addFitRow').onclick = function() {
  fitRowCount++;
  const row = document.createElement('div');
  row.className = 'row mb-2 carton-row';
  row.innerHTML = `
    <div class="col-md-6">
      <select name="carton_type_${fitRowCount}" class="form-select carton-type-select" required>
        <option value="" disabled selected>Select Carton Type</option>
        {% for carton in cartons %}
        <option value="{{ carton.id }}" data-size="{{ carton.length }}x{{ carton.width }}x{{ carton.height }}">
          {{ carton.name }} ({{ carton.length }}x{{ carton.width }}x{{ carton.height }} cm)
        </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <input type="number" name="carton_qty_${fitRowCount}" class="form-control" min="1" placeholder="Quantity" required>
    </div>
    <div class="col-md-3">
      <button type="button" class="btn btn-danger remove-row">Remove</button>
    </div>
  `;
  document.getElementById('fitCartonRows').appendChild(row);
  updateFitRemoveButtons();
};

function updateFitRemoveButtons() {
  const rows = document.querySelectorAll('#fitCartonRows .carton-row');
  rows.forEach((row, idx) => {
    const btn = row.querySelector('.remove-row');
    btn.style.display = rows.length > 1 ? '' : 'none';
    btn.onclick = function() {
      row.remove();
      updateFitRemoveButtons();
    };
  });
}
updateFitRemoveButtons();
</script>

{% if fit_results %}
<script>
$(document).ready(function() {
    $('#fitTable').DataTable({
        dom: "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
             "<'row'<'col-sm-12'B>>" +
             "<'row'<'col-sm-12'tr>>" +
             "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
        buttons: [
            {
                extend: 'copy',
                className: 'btn btn-secondary btn-sm',
                text: 'Copy'
            },
            {
                extend: 'csv',
                className: 'btn btn-secondary btn-sm',
                text: 'CSV'
            },
            {
                extend: 'excel',
                className: 'btn btn-secondary btn-sm',
                text: 'Excel'
            },
            {
                extend: 'pdf',
                className: 'btn btn-secondary btn-sm',
                text: 'PDF'
            },
            {
                extend: 'print',
                className: 'btn btn-secondary btn-sm',
                text: 'Print'
            }
        ],
        pageLength: 10,
        responsive: true,
        order: [[1, 'desc']], // Sort by utilization (highest first)
        language: {
            search: "Search results:",
            lengthMenu: "Show _MENU_ results per page",
            info: "Showing _START_ to _END_ of _TOTAL_ results"
        }
    });
});
</script>

<script type="module">
    import { renderTruckVisualizationEnhanced } from "/static/js/truck_3d_enhanced.js";
    const fitResults = {{ fit_results|tojson }};
    
    if (fitResults && fitResults.length > 0) {
        showProgress('Loading 3D Visualizations', 'Preparing interactive 3D views...', true);
        
        let loadedCount = 0;
        const totalVisualizations = fitResults.filter(r => r.fitted_items && r.fitted_items.length > 0).length;
        
        fitResults.forEach((result, index) => {
            if (result.fitted_items && result.fitted_items.length > 0) {
                const containerId = `fit-visualization-${index + 1}`;
                
                setTimeout(() => {
                    try {
                        renderTruckVisualizationEnhanced(containerId, [result]);
                        loadedCount++;
                        
                        const percentage = Math.round((loadedCount / totalVisualizations) * 100);
                        updateProgress(percentage);
                        
                        if (loadedCount === totalVisualizations) {
                            setTimeout(() => {
                                hideProgress();
                            }, 500);
                        }
                    } catch (error) {
                        console.error('Error loading 3D visualization:', error);
                        loadedCount++;
                        if (loadedCount === totalVisualizations) {
                            hideProgress();
                        }
                    }
                }, index * 300); // Stagger loading
            }
        });
    }
</script>
{% endif %}
{% endblock %}
