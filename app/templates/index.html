{% extends "base.html" %}

{% block title %}Dashboard - TruckOpti{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mt-4 mb-3">Logistics Agency Dashboard</h1>
            <p class="lead">Manage your logistics operations and partner vehicles from one central hub.</p>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card bg-primary text-white mb-4 shadow drill-down-card" 
                 onclick="showDrillDown('trucks', 'Available Vehicles')" 
                 style="cursor: pointer;" 
                 data-bs-toggle="tooltip" 
                 title="Click to view detailed truck data">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <i class="bi bi-truck fs-2"></i>
                        <div class="text-end">
                            <div class="fs-3">{{ stats.total_trucks }}</div>
                            <div>Available Vehicles</div>
                        </div>
                    </div>
                    <div class="drill-down-indicator">
                        <i class="bi bi-arrow-down-circle-fill opacity-75"></i>
                        <small>Click to drill down</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-warning text-white mb-4 shadow drill-down-card" 
                 onclick="showDrillDown('bookings', 'Active Bookings')" 
                 style="cursor: pointer;" 
                 data-bs-toggle="tooltip" 
                 title="Click to view detailed booking data">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <i class="bi bi-box-seam fs-2"></i>
                        <div class="text-end">
                            <div class="fs-3">{{ stats.total_shipments }}</div>
                            <div>Active Bookings</div>
                        </div>
                    </div>
                    <div class="drill-down-indicator">
                        <i class="bi bi-arrow-down-circle-fill opacity-75"></i>
                        <small>Click to drill down</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-success text-white mb-4 shadow drill-down-card" 
                 onclick="showDrillDown('jobs', 'Optimization Jobs')" 
                 style="cursor: pointer;" 
                 data-bs-toggle="tooltip" 
                 title="Click to view detailed job data">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <i class="bi bi-bar-chart fs-2"></i>
                        <div class="text-end">
                            <div class="fs-3">{{ stats.total_jobs }}</div>
                            <div>Optimization Jobs</div>
                        </div>
                    </div>
                    <div class="drill-down-indicator">
                        <i class="bi bi-arrow-down-circle-fill opacity-75"></i>
                        <small>Click to drill down</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-info text-white mb-4 shadow drill-down-card" 
                 onclick="showDrillDown('items', 'Item Categories')" 
                 style="cursor: pointer;" 
                 data-bs-toggle="tooltip" 
                 title="Click to view detailed item data">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <i class="bi bi-truck-flatbed fs-2"></i>
                        <div class="text-end">
                            <div class="fs-3">{{ stats.total_cartons }}</div>
                            <div>Item Categories</div>
                        </div>
                    </div>
                    <div class="drill-down-indicator">
                        <i class="bi bi-arrow-down-circle-fill opacity-75"></i>
                        <small>Click to drill down</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Enhanced KPI Row -->
    <div class="row mb-4">
        <div class="col-xl-2 col-md-4">
            <div class="card bg-gradient-primary text-white mb-4 shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="fs-6 fw-bold">{{ stats.avg_utilization|round(1) }}%</div>
                            <div class="small">Avg. Utilization</div>
                        </div>
                        <i class="bi bi-graph-up fs-4"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-md-4">
            <div class="card bg-gradient-success text-white mb-4 shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="fs-6 fw-bold">â‚¹{{ stats.total_cost|round(0) }}</div>
                            <div class="small">Cost Optimized</div>
                        </div>
                        <i class="bi bi-currency-rupee fs-4"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-md-4">
            <div class="card bg-gradient-warning text-white mb-4 shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="fs-6 fw-bold">{{ stats.efficiency_score|default(87) }}%</div>
                            <div class="small">Efficiency</div>
                        </div>
                        <i class="bi bi-speedometer2 fs-4"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions Grid -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card mb-4 shadow">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-lightning-fill"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <a href="{{ url_for('main.add_packing_job') }}" class="btn btn-outline-primary w-100 h-100 d-flex flex-column justify-content-center align-items-center p-3">
                                <i class="bi bi-plus-circle fs-2 mb-2"></i>
                                <span>New Booking</span>
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('main.recommend_truck') }}" class="btn btn-outline-success w-100 h-100 d-flex flex-column justify-content-center align-items-center p-3">
                                <i class="bi bi-lightbulb fs-2 mb-2"></i>
                                <span>Vehicle Matching</span>
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('main.fleet_optimization') }}" class="btn btn-outline-warning w-100 h-100 d-flex flex-column justify-content-center align-items-center p-3">
                                <i class="bi bi-gear-wide-connected fs-2 mb-2"></i>
                                <span>Multi-Order Planning</span>
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('main.truck_types') }}" class="btn btn-outline-info w-100 h-100 d-flex flex-column justify-content-center align-items-center p-3">
                                <i class="bi bi-truck fs-2 mb-2"></i>
                                <span>Partner Vehicles</span>
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('main.carton_types') }}" class="btn btn-outline-secondary w-100 h-100 d-flex flex-column justify-content-center align-items-center p-3">
                                <i class="bi bi-box fs-2 mb-2"></i>
                                <span>Item Types</span>
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('main.analytics') }}" class="btn btn-outline-dark w-100 h-100 d-flex flex-column justify-content-center align-items-center p-3">
                                <i class="bi bi-bar-chart fs-2 mb-2"></i>
                                <span>Analytics</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card mb-4 shadow">
                <div class="card-header bg-gradient-info text-white">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Activity</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item mb-3">
                            <div class="timeline-marker bg-success"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Booking optimization completed</h6>
                                <p class="text-muted small mb-0">15 minutes ago</p>
                            </div>
                        </div>
                        <div class="timeline-item mb-3">
                            <div class="timeline-marker bg-primary"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">New partner vehicle registered</h6>
                                <p class="text-muted small mb-0">2 hours ago</p>
                            </div>
                        </div>
                        <div class="timeline-item mb-3">
                            <div class="timeline-marker bg-warning"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Multi-order consolidation processed</h6>
                                <p class="text-muted small mb-0">4 hours ago</p>
                            </div>
                        </div>
                    </div>
                    <a href="{{ url_for('main.packing_jobs') }}" class="btn btn-outline-primary btn-sm w-100 mt-2">View All Bookings</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Analytics Charts with Professional Design -->
    <div class="row">
        <div class="col-xl-6 col-lg-12">
            <div class="card dashboard-card mb-4 shadow-lg">
                <div class="card-header bg-gradient-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-bar-chart-line-fill me-2"></i>Monthly Bookings Trend</h5>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-light" onclick="exportChart('shipments', 'excel')" title="Export to Excel">
                                <i class="bi bi-file-earmark-spreadsheet"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-light" onclick="exportChart('shipments', 'pdf')" title="Export to PDF">
                                <i class="bi bi-file-earmark-pdf"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="professional-chart-container" onclick="showChartDrillDown('shipments', 'Monthly Bookings Trend')" style="cursor: pointer;">
                        <canvas id="shipmentsChart" style="height: 350px; width: 100%;"></canvas>
                        <div class="chart-drill-down-overlay">
                            <div class="drill-down-hint">
                                <i class="bi bi-search"></i> Click to view actual data
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-6 col-lg-12">
            <div class="card dashboard-card mb-4 shadow-lg">
                <div class="card-header bg-gradient-info text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-pie-chart-fill me-2"></i>Partner Vehicle Categories</h5>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-light" onclick="exportChart('trucks', 'excel')" title="Export to Excel">
                                <i class="bi bi-file-earmark-spreadsheet"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-light" onclick="exportChart('trucks', 'pdf')" title="Export to PDF">
                                <i class="bi bi-file-earmark-pdf"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="professional-chart-container" onclick="showChartDrillDown('trucks', 'Partner Vehicle Categories')" style="cursor: pointer;">
                        <canvas id="trucksChart" style="height: 350px; width: 100%;"></canvas>
                        <div class="chart-drill-down-overlay">
                            <div class="drill-down-hint">
                                <i class="bi bi-search"></i> Click to view actual data
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Additional Analytics Row -->
    <div class="row">
        <div class="col-xl-8">
            <div class="card dashboard-card mb-4 shadow-lg">
                <div class="card-header bg-gradient-success text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Cost Optimization Analysis</h5>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-light" onclick="exportChart('costs', 'excel')" title="Export to Excel">
                                <i class="bi bi-file-earmark-spreadsheet"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="professional-chart-container" onclick="showChartDrillDown('costs', 'Cost Optimization Analysis')" style="cursor: pointer;">
                        <canvas id="costsChart" style="height: 300px; width: 100%;"></canvas>
                        <div class="chart-drill-down-overlay">
                            <div class="drill-down-hint">
                                <i class="bi bi-search"></i> Click to view cost breakdown
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4">
            <div class="card dashboard-card mb-4 shadow-lg">
                <div class="card-header bg-gradient-warning text-white">
                    <h5 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>Performance Metrics</h5>
                </div>
                <div class="card-body">
                    <div class="metric-item mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="metric-label">Average Load Efficiency</span>
                            <span class="metric-value text-success fw-bold">{{ stats.avg_utilization|round(1) }}%</span>
                        </div>
                        <div class="progress mt-2" style="height: 6px;">
                            <div class="progress-bar bg-success" style="width: {{ stats.avg_utilization|round(1) }}%"></div>
                        </div>
                    </div>
                    <div class="metric-item mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="metric-label">Cost Savings</span>
                            <span class="metric-value text-primary fw-bold">â‚¹{{ (stats.total_cost * 0.15)|round(0) }}</span>
                        </div>
                        <small class="text-muted">Monthly optimization savings</small>
                    </div>
                    <div class="metric-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="metric-label">Fleet Utilization</span>
                            <span class="metric-value text-info fw-bold">{{ stats.efficiency_score|default(87) }}%</span>
                        </div>
                        <div class="progress mt-2" style="height: 6px;">
                            <div class="progress-bar bg-info" style="width: {{ stats.efficiency_score|default(87) }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Drill-Down Modal -->
<div class="modal fade" id="drillDownModal" tabindex="-1" aria-labelledby="drillDownModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-fullscreen-lg-down">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="drillDownModalLabel">
                    <i class="bi bi-table me-2"></i>Base Data Analysis
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6 class="text-muted">Data Source: <span id="dataSource"></span></h6>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="exportDrillDownData('excel')">
                                <i class="bi bi-file-earmark-spreadsheet"></i> Excel
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="exportDrillDownData('csv')">
                                <i class="bi bi-file-earmark-text"></i> CSV
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="exportDrillDownData('pdf')">
                                <i class="bi bi-file-earmark-pdf"></i> PDF
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Data Verification:</strong> This table shows the actual base data used to calculate the dashboard metrics. 
                            You can verify the accuracy of any chart or KPI by examining the underlying records.
                        </div>
                    </div>
                </div>

                <div id="drillDownContent">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="refreshDrillDownData()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh Data
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Export Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// Enhanced export functionality
function exportChart(chartType, format) {
    let chartData;
    
    switch(chartType) {
        case 'shipments':
            chartData = {
                labels: {{ charts.shipments.labels|tojson }},
                data: {{ charts.shipments.data|tojson }},
                title: 'Monthly Bookings Trend',
                type: 'line'
            };
            break;
        case 'trucks':
            chartData = {
                labels: {{ charts.trucks.labels|tojson }},
                data: {{ charts.trucks.data|tojson }},
                title: 'Partner Vehicle Categories',
                type: 'doughnut'
            };
            break;
        case 'costs':
            chartData = {
                labels: ['Fuel Optimization', 'Route Efficiency', 'Load Optimization', 'Fleet Utilization'],
                data: [25000, 18000, 32000, 15000],
                title: 'Cost Optimization Analysis',
                type: 'bar'
            };
            break;
        default:
            showToast('Export Error', 'Unknown chart type', 'danger');
            return;
    }
    
    if (format === 'excel') {
        exportToExcel(chartData);
    } else if (format === 'pdf') {
        exportToPDF(chartData);
    }
}

function exportToExcel(data) {
    // Create workbook and worksheet
    const wb = XLSX.utils.book_new();
    
    // Create data array for Excel
    const wsData = [
        [data.title],
        [],
        ['Category', 'Value']
    ];
    
    for (let i = 0; i < data.labels.length; i++) {
        wsData.push([data.labels[i], data.data[i]]);
    }
    
    // Add summary statistics
    wsData.push([]);
    wsData.push(['Summary Statistics:']);
    wsData.push(['Total:', data.data.reduce((a, b) => a + b, 0)]);
    wsData.push(['Average:', Math.round(data.data.reduce((a, b) => a + b, 0) / data.data.length * 100) / 100]);
    wsData.push(['Maximum:', Math.max(...data.data)]);
    wsData.push(['Minimum:', Math.min(...data.data)]);
    
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    
    // Style the header
    if (!ws['!merges']) ws['!merges'] = [];
    ws['!merges'].push({s: {r: 0, c: 0}, e: {r: 0, c: 1}});
    
    // Add the worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, data.title.replace(/[^a-zA-Z0-9]/g, '_'));
    
    // Save the file
    const filename = `TruckOpti_${data.title.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().slice(0, 10)}.xlsx`;
    XLSX.writeFile(wb, filename);
    
    // Show success message
    showToast('Excel Export', `Data exported successfully as ${filename}`, 'success');
}

function exportToPDF(data) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Add title
    doc.setFontSize(20);
    doc.setFont('helvetica', 'bold');
    doc.text('TruckOpti Logistics Dashboard', 20, 20);
    
    doc.setFontSize(16);
    doc.setFont('helvetica', 'normal');
    doc.text(data.title, 20, 35);
    
    // Add export date
    doc.setFontSize(10);
    doc.text(`Generated on: ${new Date().toLocaleDateString('en-IN')}`, 20, 45);
    
    // Add table header
    let y = 60;
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text('Category', 20, y);
    doc.text('Value', 80, y);
    
    // Add data rows
    doc.setFont('helvetica', 'normal');
    y += 10;
    for (let i = 0; i < data.labels.length; i++) {
        doc.text(data.labels[i], 20, y);
        doc.text(data.data[i].toString(), 80, y);
        y += 8;
    }
    
    // Add summary statistics
    y += 10;
    doc.setFont('helvetica', 'bold');
    doc.text('Summary Statistics:', 20, y);
    y += 8;
    
    doc.setFont('helvetica', 'normal');
    const total = data.data.reduce((a, b) => a + b, 0);
    const average = Math.round(total / data.data.length * 100) / 100;
    const maximum = Math.max(...data.data);
    const minimum = Math.min(...data.data);
    
    doc.text(`Total: ${total}`, 20, y);
    y += 6;
    doc.text(`Average: ${average}`, 20, y);
    y += 6;
    doc.text(`Maximum: ${maximum}`, 20, y);
    y += 6;
    doc.text(`Minimum: ${minimum}`, 20, y);
    
    // Save the PDF
    const filename = `TruckOpti_${data.title.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().slice(0, 10)}.pdf`;
    doc.save(filename);
    
    // Show success message
    showToast('PDF Export', `Report exported successfully as ${filename}`, 'success');
}

function showToast(title, message, type = 'info') {
    // Create toast element
    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'primary'} border-0" 
             role="alert" aria-live="assertive" aria-atomic="true" id="${toastId}"
             style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
            <div class="d-flex">
                <div class="toast-body">
                    <strong>${title}</strong><br>${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" 
                        data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    $('body').append(toastHtml);
    const toastElement = new bootstrap.Toast(document.getElementById(toastId));
    toastElement.show();
    
    // Remove toast after it's hidden
    document.getElementById(toastId).addEventListener('hidden.bs.toast', () => {
        document.getElementById(toastId).remove();
    });
}

$(document).ready(function() {
    // Professional chart initialization with improved sizing
    setTimeout(function() {
        // Shipments Chart - Enhanced Line Chart
        var ctxShipments = document.getElementById('shipmentsChart').getContext('2d');
        var shipmentsChart = new Chart(ctxShipments, {
            type: 'line',
            data: {
                labels: {{ charts.shipments.labels|tojson }},
                datasets: [{
                    label: 'Monthly Bookings',
                    data: {{ charts.shipments.data|tojson }},
                    backgroundColor: 'rgba(25, 118, 210, 0.1)',
                    borderColor: 'rgba(25, 118, 210, 1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: 'rgba(25, 118, 210, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: 20
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0,0,0,0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            font: {
                                size: 12
                            },
                            color: '#666'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 12
                            },
                            color: '#666'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            font: {
                                size: 13,
                                weight: 'bold'
                            },
                            color: '#333',
                            usePointStyle: true,
                            padding: 20
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        cornerRadius: 8,
                        displayColors: false
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });

        // Trucks Chart - Enhanced Doughnut Chart
        var ctxTrucks = document.getElementById('trucksChart').getContext('2d');
        var trucksChart = new Chart(ctxTrucks, {
            type: 'doughnut',
            data: {
                labels: {{ charts.trucks.labels|tojson }},
                datasets: [{
                    label: 'Vehicle Types',
                    data: {{ charts.trucks.data|tojson }},
                    backgroundColor: [
                        '#1976d2',
                        '#4caf50',
                        '#ff9800',
                        '#9c27b0',
                        '#f44336',
                        '#00bcd4'
                    ],
                    borderWidth: 3,
                    borderColor: '#fff',
                    hoverBorderWidth: 4,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: 20
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            font: {
                                size: 12,
                                weight: 'bold'
                            },
                            color: '#333',
                            usePointStyle: true,
                            padding: 15,
                            boxWidth: 12
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((context.parsed / total) * 100);
                                return `${context.label}: ${context.parsed} (${percentage}%)`;
                            }
                        }
                    }
                },
                cutout: '60%'
            }
        });

        // Cost Analysis Chart
        var ctxCosts = document.getElementById('costsChart').getContext('2d');
        var costData = {
            labels: ['Fuel Optimization', 'Route Efficiency', 'Load Optimization', 'Fleet Utilization'],
            datasets: [{
                label: 'Cost Savings (â‚¹)',
                data: [25000, 18000, 32000, 15000],
                backgroundColor: [
                    'rgba(76, 175, 80, 0.8)',
                    'rgba(33, 150, 243, 0.8)',
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(156, 39, 176, 0.8)'
                ],
                borderColor: [
                    'rgba(76, 175, 80, 1)',
                    'rgba(33, 150, 243, 1)',
                    'rgba(255, 193, 7, 1)',
                    'rgba(156, 39, 176, 1)'
                ],
                borderWidth: 2
            }]
        };
        
        var costsChart = new Chart(ctxCosts, {
            type: 'bar',
            data: costData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: 20
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0,0,0,0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            font: {
                                size: 11
                            },
                            color: '#666',
                            callback: function(value) {
                                return 'â‚¹' + (value / 1000) + 'k';
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 11
                            },
                            color: '#666',
                            maxRotation: 45
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                return `Savings: â‚¹${context.parsed.y.toLocaleString()}`;
                            }
                        }
                    }
                }
            }
        });

        // Store chart instances globally for resize
        window.dashboardCharts = {
            shipments: shipmentsChart,
            trucks: trucksChart,
            costs: costsChart
        };

        // Resize charts when sidebar is toggled
        $('#sidebarToggle').on('click', function() {
            setTimeout(function() {
                Object.values(window.dashboardCharts).forEach(chart => {
                    if (chart) chart.resize();
                });
            }, 350);
        });
        
        // Handle window resize
        $(window).on('resize', function() {
            setTimeout(function() {
                Object.values(window.dashboardCharts).forEach(chart => {
                    if (chart) chart.resize();
                });
            }, 100);
        });
        
    }, 100);
});

// Global variables for drill-down functionality
let currentDrillDownData = null;
let currentDataType = null;

// Drill-down functionality for dashboard widgets
function showDrillDown(dataType, title) {
    currentDataType = dataType;
    document.getElementById('dataSource').textContent = title;
    document.getElementById('drillDownModalLabel').innerHTML = 
        `<i class="bi bi-table me-2"></i>${title} - Base Data Analysis`;
    
    // Show loading state
    document.getElementById('drillDownContent').innerHTML = `
        <div class="text-center p-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading base data...</p>
        </div>
    `;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('drillDownModal'));
    modal.show();
    
    // Fetch data
    fetch(`/api/drill-down/${dataType}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            currentDrillDownData = data;
            renderDrillDownTable(data);
        })
        .catch(error => {
            console.error('Error fetching drill-down data:', error);
            document.getElementById('drillDownContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Error loading data: ${error.message}
                </div>
            `;
        });
}

// Chart drill-down functionality
function showChartDrillDown(chartType, title) {
    const dataTypeMap = {
        'shipments': 'shipments',
        'trucks': 'trucks'
    };
    
    showDrillDown(dataTypeMap[chartType], title);
}

// Render drill-down data table
function renderDrillDownTable(data) {
    const content = document.getElementById('drillDownContent');
    
    if (!data.data || data.data.length === 0) {
        content.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-info-circle me-2"></i>
                No data available for this category.
            </div>
        `;
        return;
    }
    
    // Create summary stats
    const statsHtml = `
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card bg-light">
                    <div class="card-body p-3">
                        <h6 class="card-title mb-1">Total Records</h6>
                        <h4 class="text-primary mb-0">${data.total_count}</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card bg-light">
                    <div class="card-body p-3">
                        <h6 class="card-title mb-1">Data Source</h6>
                        <h6 class="text-muted mb-0">${data.data_type}</h6>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Create searchable, sortable table
    const tableHtml = `
        <div class="row mb-3">
            <div class="col-md-6">
                <input type="text" class="form-control" id="drillDownSearch" 
                       placeholder="ðŸ” Search in data..." onkeyup="filterDrillDownTable()">
            </div>
            <div class="col-md-6">
                <select class="form-select" id="drillDownSort" onchange="sortDrillDownTable()">
                    <option value="">Sort by...</option>
                    ${data.columns.map((col, index) => `<option value="${index}">${col}</option>`).join('')}
                </select>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="drillDownTable">
                <thead class="table-dark">
                    <tr>
                        ${data.columns.map(col => `<th>${col}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
                    ${renderTableRows(data.data)}
                </tbody>
            </table>
        </div>
    `;
    
    content.innerHTML = statsHtml + tableHtml;
}

// Render table rows
function renderTableRows(data) {
    return data.map(row => {
        const values = Object.values(row).slice(1); // Skip ID
        return `
            <tr>
                ${values.map(value => `<td>${formatCellValue(value)}</td>`).join('')}
            </tr>
        `;
    }).join('');
}

// Format cell values for display
function formatCellValue(value) {
    if (typeof value === 'boolean') {
        return value ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-secondary">No</span>';
    }
    if (typeof value === 'number' && value > 1000000) {
        return (value / 1000000).toFixed(2) + 'M';
    }
    if (typeof value === 'string' && value.includes('%')) {
        const num = parseFloat(value);
        if (num >= 80) return `<span class="text-success fw-bold">${value}</span>`;
        if (num >= 60) return `<span class="text-warning fw-bold">${value}</span>`;
        if (num < 60) return `<span class="text-danger fw-bold">${value}</span>`;
    }
    return value || 'N/A';
}

// Filter table based on search
function filterDrillDownTable() {
    const searchTerm = document.getElementById('drillDownSearch').value.toLowerCase();
    const rows = document.querySelectorAll('#drillDownTable tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

// Sort table by column
function sortDrillDownTable() {
    const sortSelect = document.getElementById('drillDownSort');
    const columnIndex = parseInt(sortSelect.value);
    
    if (isNaN(columnIndex)) return;
    
    const tbody = document.querySelector('#drillDownTable tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    rows.sort((a, b) => {
        const aVal = a.cells[columnIndex]?.textContent || '';
        const bVal = b.cells[columnIndex]?.textContent || '';
        
        // Try numeric sort first
        const aNum = parseFloat(aVal.replace(/[^0-9.-]/g, ''));
        const bNum = parseFloat(bVal.replace(/[^0-9.-]/g, ''));
        
        if (!isNaN(aNum) && !isNaN(bNum)) {
            return bNum - aNum; // Descending numeric
        }
        
        // Alphabetic sort
        return aVal.localeCompare(bVal);
    });
    
    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
}

// Export drill-down data
function exportDrillDownData(format) {
    if (!currentDrillDownData) {
        showToast('Export Error', 'No data available to export', 'danger');
        return;
    }
    
    const data = currentDrillDownData;
    const filename = `${currentDataType}_base_data_${new Date().toISOString().split('T')[0]}`;
    
    if (format === 'excel') {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(data.data);
        XLSX.utils.book_append_sheet(wb, ws, data.data_type);
        XLSX.writeFile(wb, `${filename}.xlsx`);
        showToast('Excel Export', 'Base data exported successfully', 'success');
    } 
    else if (format === 'csv') {
        const ws = XLSX.utils.json_to_sheet(data.data);
        const csv = XLSX.utils.sheet_to_csv(ws);
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${filename}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
        showToast('CSV Export', 'Base data exported successfully', 'success');
    }
    else if (format === 'pdf') {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Add title
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text(`${data.data_type} - Base Data Report`, 20, 20);
        
        doc.setFontSize(10);
        doc.text(`Generated: ${new Date().toLocaleDateString('en-IN')}`, 20, 30);
        doc.text(`Total Records: ${data.total_count}`, 20, 40);
        
        // Add summary table (first few records)
        let y = 60;
        const maxRecords = Math.min(20, data.data.length);
        
        doc.setFont('helvetica', 'bold');
        doc.text('Sample Data (First 20 Records):', 20, 50);
        
        for (let i = 0; i < maxRecords; i++) {
            const record = data.data[i];
            const values = Object.values(record);
            const displayText = `${i + 1}. ${values.slice(1, 3).join(' - ')}`;
            
            if (y > 280) { // New page
                doc.addPage();
                y = 20;
            }
            
            doc.setFont('helvetica', 'normal');
            doc.text(displayText, 20, y);
            y += 8;
        }
        
        doc.save(`${filename}.pdf`);
        showToast('PDF Export', 'Base data report exported successfully', 'success');
    }
}

// Refresh drill-down data
function refreshDrillDownData() {
    if (currentDataType) {
        showDrillDown(currentDataType, document.getElementById('dataSource').textContent);
    }
}

// Initialize tooltips for drill-down indicators
document.addEventListener('DOMContentLoaded', function() {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}