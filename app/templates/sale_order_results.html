{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <!-- Batch Summary Header -->
  <div class="card shadow mb-4">
    <div class="card-header bg-success text-white">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h4 class="mb-0"><i class="fas fa-truck me-2"></i>Sale Order Truck Recommendations</h4>
          <small class="opacity-75">Batch: {{ batch.batch_name }}</small>
        </div>
        <div class="text-end">
          <div class="badge bg-light text-success fs-6 me-2">
            {{ batch.processed_orders }}/{{ batch.total_orders }} Orders Processed
          </div>
          {% if batch.failed_orders > 0 %}
          <div class="badge bg-warning text-dark fs-6">
            {{ batch.failed_orders }} Failed
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-3">
          <div class="stat-item">
            <div class="stat-value text-primary">{{ batch.total_orders }}</div>
            <div class="stat-label">Total Orders</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-item">
            <div class="stat-value text-success">{{ batch.processed_orders }}</div>
            <div class="stat-label">Successfully Processed</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-item">
            <div class="stat-value text-info">
              {{ sale_orders|selectattr('recommended_truck_id')|list|length }}
            </div>
            <div class="stat-label">With Recommendations</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-item">
            <div class="stat-value text-warning">
              {% if batch.failed_orders > 0 %}{{ batch.failed_orders }}{% else %}0{% endif %}
            </div>
            <div class="stat-label">Failed Orders</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sale Orders with Recommendations -->
  <div class="row">
    {% for order in sale_orders %}
    <div class="col-12 mb-4">
      <div class="card shadow">
        <div class="card-header bg-light">
          <div class="row align-items-center">
            <div class="col-md-6">
              <h5 class="mb-0">
                <i class="fas fa-shopping-cart text-primary me-2"></i>
                Order #{{ order.sale_order_number }}
              </h5>
              <small class="text-muted">
                {% if order.customer_name %}{{ order.customer_name }}{% endif %}
                {% if order.total_items %} • {{ order.total_items }} items{% endif %}
              </small>
            </div>
            <div class="col-md-6 text-end">
              {% if order.recommended_truck_id %}
                <span class="badge bg-success mb-1">
                  <i class="fas fa-check-circle me-1"></i>Optimized
                </span>
                <br>
                <small class="text-muted">
                  Utilization: {{ "%.1f"|format(order.estimated_utilization * 100) }}% • 
                  Cost: ₹{{ "%.0f"|format(order.estimated_cost) }}
                </small>
              {% else %}
                <span class="badge bg-warning">
                  <i class="fas fa-exclamation-triangle me-1"></i>Pending
                </span>
              {% endif %}
            </div>
          </div>
        </div>
        
        <div class="card-body">
          <!-- Order Details -->
          <div class="row mb-3">
            <div class="col-md-6">
              <div class="order-details">
                <h6 class="text-primary">Order Details</h6>
                <div class="row">
                  <div class="col-6">
                    <small class="text-muted">Items:</small>
                    <div class="fw-bold">{{ order.total_items }}</div>
                  </div>
                  <div class="col-6">
                    <small class="text-muted">Volume:</small>
                    <div class="fw-bold">{{ "%.2f"|format(order.total_volume) }} m³</div>
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="col-6">
                    <small class="text-muted">Weight:</small>
                    <div class="fw-bold">{{ "%.1f"|format(order.total_weight) }} kg</div>
                  </div>
                  <div class="col-6">
                    <small class="text-muted">Status:</small>
                    <div>
                      {% if order.status == 'optimized' %}
                        <span class="badge bg-success">Optimized</span>
                      {% elif order.status == 'processed' %}
                        <span class="badge bg-info">Processed</span>
                      {% else %}
                        <span class="badge bg-secondary">{{ order.status|title }}</span>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-6">
              {% if order.delivery_address %}
              <div class="delivery-info">
                <h6 class="text-primary">Delivery Information</h6>
                <small class="text-muted">Address:</small>
                <div class="fw-bold">{{ order.delivery_address }}</div>
              </div>
              {% endif %}
            </div>
          </div>

          <!-- Single Truck Recommendation (Prioritizing Space Utilization) -->
          {% set recommendations = order_recommendations.get(order.id, []) %}
          {% if recommendations %}
          <div class="truck-recommendations">
            <h6 class="text-success">
              <i class="fas fa-truck me-2"></i>Optimal Single Truck Solution
              <small class="text-muted">(Prioritizing Maximum Space Utilization for Cost Savings)</small>
            </h6>
            
            {% set best_rec = recommendations[0] %}
            <!-- Best Recommendation (Large Display) -->
            <div class="row">
              <div class="col-md-8 mb-3">
                <div class="card border-success bg-light-success">
                  <div class="card-header bg-success text-white">
                    <div class="d-flex justify-content-between align-items-center">
                      <h5 class="mb-0">
                        <i class="fas fa-trophy me-2"></i>{{ best_rec.truck_type.name }}
                      </h5>
                      <div>
                        {% if best_rec.fits_completely %}
                          <span class="badge bg-light text-success">✅ PERFECT FIT</span>
                        {% else %}
                          <span class="badge bg-warning text-dark">⚠️ OVERFLOW</span>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-6">
                        <h6 class="text-success">Space Utilization</h6>
                        <div class="progress mb-3" style="height: 25px;">
                          <div class="progress-bar bg-{% if best_rec.space_utilization > 0.8 %}success{% elif best_rec.space_utilization > 0.6 %}info{% elif best_rec.space_utilization > 0.4 %}warning{% else %}danger{% endif %}"
                               style="width: {{ best_rec.space_utilization * 100 }}%">
                            <strong>{{ "%.1f"|format(best_rec.space_utilization * 100) }}%</strong>
                          </div>
                        </div>
                        
                        <div class="truck-specs">
                          <small class="text-muted">Truck Dimensions:</small>
                          <div><strong>{{ "%.1f"|format(best_rec.truck_type.length) }} × {{ "%.1f"|format(best_rec.truck_type.width) }} × {{ "%.1f"|format(best_rec.truck_type.height) }} cm</strong></div>
                          
                          {% if best_rec.truck_type.max_weight %}
                          <small class="text-muted mt-2 d-block">Max Weight:</small>
                          <div><strong>{{ "%.0f"|format(best_rec.truck_type.max_weight) }} kg</strong></div>
                          {% endif %}
                        </div>
                      </div>
                      
                      <div class="col-md-6">
                        <h6 class="text-primary">Cost Analysis</h6>
                        <div class="cost-breakdown">
                          <div class="d-flex justify-content-between">
                            <span>Estimated Cost:</span>
                            <strong class="text-primary">₹{{ "%.0f"|format(best_rec.estimated_cost) }}</strong>
                          </div>
                          
                          <div class="d-flex justify-content-between">
                            <span>Fit Status:</span>
                            {% if best_rec.fits_completely %}
                              <strong class="text-success">✅ Complete ({{ best_rec.overflow_items }} overflow)</strong>
                            {% else %}
                              <strong class="text-danger">❌ {{ best_rec.overflow_items }} items overflow</strong>
                            {% endif %}
                          </div>
                          
                          <div class="d-flex justify-content-between">
                            <span>Cost Efficiency:</span>
                            <strong class="text-{% if best_rec.space_utilization > 0.7 %}success{% elif best_rec.space_utilization > 0.5 %}warning{% else %}danger{% endif %}">
                              {{ "Good" if best_rec.space_utilization > 0.7 else "Fair" if best_rec.space_utilization > 0.5 else "Poor" }}
                            </strong>
                          </div>
                        </div>
                        
                        {% if best_rec.fits_completely %}
                        <div class="mt-3">
                          <div class="row">
                            <div class="col-6">
                              <button class="btn btn-success btn-sm w-100" onclick="selectTruck({{ order.id }}, {{ best_rec.truck_type_id }}, 'space')">
                                <i class="fas fa-expand-arrows-alt me-1"></i>Max Space
                              </button>
                            </div>
                            <div class="col-6">
                              <button class="btn btn-outline-success btn-sm w-100" onclick="selectTruck({{ order.id }}, {{ best_rec.truck_type_id }}, 'cost')">
                                <i class="fas fa-dollar-sign me-1"></i>Min Cost
                              </button>
                            </div>
                          </div>
                        </div>
                        {% endif %}
                      </div>
                    </div>
                    
                    <!-- 3D Visualization Section -->
                    <div class="mt-3 mb-3">
                      <div class="3d-visualization-panel bg-light p-3 rounded">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <h6 class="text-muted mb-0">
                            <i class="fas fa-cube me-1"></i>3D Truck Visualization
                          </h6>
                          <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary btn-sm" onclick="toggle3DVisualization('{{ order.id }}')" id="viz-btn-{{ order.id }}">
                              <i class="fas fa-cube me-1"></i>View 3D Packing
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="optimizeSelection({{ order.id }}, 'space')">
                              <i class="fas fa-expand-arrows-alt me-1"></i>Optimize
                            </button>
                          </div>
                        </div>
                        <div id="truck-3d-{{ order.id }}" class="truck-3d-container" style="height: 200px; display: none;">
                          <div class="loading-overlay text-center pt-5">
                            <div class="spinner-border text-primary" role="status">
                              <span class="visually-hidden">Loading 3D visualization...</span>
                            </div>
                            <div class="mt-2 small text-muted">Generating 3D packing layout...</div>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Recommendation Reason -->
                    <div class="mt-3 p-3 bg-info bg-opacity-10 rounded">
                      <small class="text-info">
                        <i class="fas fa-info-circle me-1"></i>
                        <strong>Recommendation:</strong> {{ best_rec.recommendation_reason }}
                      </small>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Alternative Options (Compact) -->
              <div class="col-md-4">
                <h6 class="text-muted">Alternative Options</h6>
                {% for rec in recommendations[1:4] %}
                <div class="card mb-2 {% if not rec.fits_completely %}border-warning{% endif %}">
                  <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-start">
                      <div>
                        <strong class="small">{{ rec.truck_type.name }}</strong>
                        <br><small class="text-muted">{{ "%.1f"|format(rec.space_utilization * 100) }}% util</small>
                      </div>
                      <div class="text-end">
                        <small class="text-primary">₹{{ "%.0f"|format(rec.estimated_cost) }}</small>
                        {% if not rec.fits_completely %}
                          <br><small class="text-warning">{{ rec.overflow_items }} overflow</small>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
          
          {% if recommendations|length > 3 %}
          <div class="text-center mt-3">
            <button class="btn btn-outline-primary btn-sm" onclick="showAllRecommendations({{ order.id }})">
              <i class="fas fa-eye me-1"></i>Show All {{ recommendations|length }} Recommendations
            </button>
          </div>
          {% endif %}
          {% else %}
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>No truck recommendations available for this order.</strong>
            This might be due to oversized items or processing errors.
          </div>
          {% endif %}

          <!-- Order Cartons (Collapsible) -->
          <div class="mt-3">
            <button class="btn btn-outline-secondary btn-sm" type="button" 
                    data-bs-toggle="collapse" data-bs-target="#cartons-{{ order.id }}">
              <i class="fas fa-boxes me-1"></i>View Order Cartons ({{ order.sale_order_items|length }})
            </button>
            
            <div class="collapse mt-2" id="cartons-{{ order.id }}">
              <div class="table-responsive">
                <table class="table table-sm table-bordered">
                  <thead class="table-light">
                    <tr>
                      <th>Carton Code</th>
                      <th>Carton Name</th>
                      <th>Quantity</th>
                      <th>Dimensions (LxWxH)</th>
                      <th>Unit Weight</th>
                      <th>Total Volume</th>
                      <th>Mapping Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for carton in order.sale_order_items %}
                    <tr>
                      <td><small class="font-monospace">{{ carton.item_code }}</small></td>
                      <td>{{ carton.item_name }}</td>
                      <td class="text-center"><span class="badge bg-primary">{{ carton.quantity }}</span></td>
                      <td class="text-center">
                        <small>{{ "%.0f"|format(carton.unit_length) }} × {{ "%.0f"|format(carton.unit_width) }} × {{ "%.0f"|format(carton.unit_height) }} cm</small>
                      </td>
                      <td class="text-center"><small>{{ "%.1f"|format(carton.unit_weight) }} kg</small></td>
                      <td class="text-center"><small>{{ "%.3f"|format(carton.total_volume) }} m³</small></td>
                      <td class="text-center">
                        {% if carton.notes and 'Mapped to carton:' in carton.notes %}
                          <span class="badge bg-success" title="{{ carton.notes }}">
                            <i class="fas fa-check"></i> Mapped
                          </span>
                        {% else %}
                          <span class="badge bg-warning text-dark" title="Using default dimensions">
                            <i class="fas fa-exclamation-triangle"></i> Default
                          </span>
                        {% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              
              <div class="mt-2 p-2 bg-light rounded">
                <small class="text-muted">
                  <i class="fas fa-info-circle me-1"></i>
                  <strong>Carton Mapping:</strong> System attempts to match your carton names with existing carton types in the database. 
                  "Mapped" indicates successful match with accurate dimensions, "Default" uses estimated dimensions.
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Performance Analytics Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Batch Performance Analytics</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <!-- Performance Trends Chart -->
            <div class="col-lg-8 mb-4">
              <div class="card">
                <div class="card-header bg-primary text-white">
                  <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-trending-up me-1"></i>Performance Trends</h6>
                    <div class="btn-group btn-group-sm chart-controls">
                      <button class="btn btn-outline-light btn-sm active" onclick="updatePerformanceChart('utilization')">Utilization</button>
                      <button class="btn btn-outline-light btn-sm" onclick="updatePerformanceChart('cost')">Cost</button>
                      <button class="btn btn-outline-light btn-sm" onclick="updatePerformanceChart('efficiency')">Efficiency</button>
                    </div>
                  </div>
                </div>
                <div class="card-body chart-container">
                  <canvas id="performanceTrendsChart"></canvas>
                </div>
              </div>
            </div>
            
            <!-- Summary Statistics -->
            <div class="col-lg-4 mb-4">
              <div class="card">
                <div class="card-header bg-success text-white">
                  <h6 class="mb-0"><i class="fas fa-chart-pie me-1"></i>Order Distribution</h6>
                </div>
                <div class="card-body chart-container">
                  <canvas id="orderDistributionChart"></canvas>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Cost Analysis and Utilization Charts -->
          <div class="row">
            <div class="col-lg-6 mb-4">
              <div class="card">
                <div class="card-header bg-warning text-white">
                  <h6 class="mb-0"><i class="fas fa-dollar-sign me-1"></i>Cost Analysis</h6>
                </div>
                <div class="card-body chart-container">
                  <canvas id="costAnalysisChart"></canvas>
                </div>
              </div>
            </div>
            
            <div class="col-lg-6 mb-4">
              <div class="card">
                <div class="card-header bg-secondary text-white">
                  <h6 class="mb-0"><i class="fas fa-truck me-1"></i>Truck Utilization</h6>
                </div>
                <div class="card-body chart-container">
                  <canvas id="truckUtilizationChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="text-center mb-4">
    <a href="{{ url_for('main.sale_orders') }}" class="btn btn-primary">
      <i class="fas fa-upload me-1"></i>Process Another Batch
    </a>
    <button class="btn btn-success" onclick="exportResults()">
      <i class="fas fa-download me-1"></i>Export Results
    </button>
  </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

<style>
.stat-item {
  text-align: center;
  padding: 10px;
}
.stat-value {
  font-size: 2rem;
  font-weight: bold;
  line-height: 1;
}
.stat-label {
  font-size: 0.875rem;
  color: #666;
}
.order-details .row {
  margin-bottom: 5px;
}

/* Chart container improvements */
.chart-container canvas {
  max-height: 350px !important;
  width: 100% !important;
  height: auto !important;
}

/* Performance metrics styling */
.performance-analytics {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

/* Chart responsiveness */
@media (max-width: 768px) {
  .chart-container canvas {
    max-height: 250px !important;
  }
  
  .btn-group-sm .btn {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
  }
}

/* Real truck specifications styling */
.truck-specs-info {
  background: #f8f9fa;
  border-left: 4px solid #007bff;
  padding: 0.75rem;
  margin: 0.5rem 0;
}

/* Loading Overlay Styles */
.loading-overlay-full {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  backdrop-filter: blur(3px);
}

.loading-content {
  background: white;
  padding: 2rem;
  border-radius: 10px;
  text-align: center;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  min-width: 300px;
}

.loading-text {
  font-weight: 500;
  color: #495057;
  margin-bottom: 0.5rem;
}

/* Success Toast Styles */
.toast-success {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #d4edda;
  border: 1px solid #c3e6cb;
  color: #155724;
  padding: 1rem 1.5rem;
  border-radius: 0.375rem;
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
  z-index: 1050;
  opacity: 0;
  transform: translateX(100%);
  transition: all 0.3s ease;
  max-width: 400px;
}

.toast-success.show {
  opacity: 1;
  transform: translateX(0);
}

/* 3D Visualization Styles */
.truck-3d-container {
  border-radius: 8px;
  overflow: hidden;
  transition: all 0.3s ease;
}

.truck-3d-container:hover {
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.3d-visualization-panel {
  border: 1px solid #dee2e6;
  border-radius: 8px;
}

.optimization-options .btn-group-vertical .btn {
  margin-bottom: 0.25rem;
  border-radius: 0.375rem !important;
}

.optimization-options .btn-group-vertical .btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* Animation for 3D elements */
@keyframes truckLoad {
  0% { transform: scale(0.8); opacity: 0; }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); opacity: 1; }
}

.truck-outline {
  animation: truckLoad 1s ease-out;
}

.truck-outline > div {
  animation: truckLoad 1.2s ease-out;
  animation-delay: 0.2s;
}

/* Mobile responsive adjustments */
@media (max-width: 768px) {
  .loading-content {
    margin: 1rem;
    padding: 1.5rem;
    min-width: auto;
  }
  
  .toast-success {
    right: 10px;
    top: 10px;
    max-width: calc(100vw - 20px);
  }
  
  .truck-3d-container {
    height: 150px !important;
  }
}
</style>

<script>
// Global chart variables
let performanceTrendsChart, orderDistributionChart, costAnalysisChart, truckUtilizationChart;

// Initialize charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    loadChartData();
});

// Real truck specifications from Porter.in
const REAL_TRUCK_SPECS = {
    '3 Wheeler': { capacity: 500, baseRate: 160, dimensions: '6ft x 4ft x 4ft' },
    'Tata Ace': { capacity: 750, baseRate: 205, dimensions: '7ft x 5ft x 5ft' },
    'Pickup 8ft': { capacity: 1000, baseRate: 250, dimensions: '8ft x 5ft x 5ft' },
    'Truck 14ft': { capacity: 2500, baseRate: 400, dimensions: '14ft x 6ft x 6ft' },
    'Truck 17ft': { capacity: 4000, baseRate: 550, dimensions: '17ft x 6ft x 7ft' },
    'Truck 19ft': { capacity: 5000, baseRate: 650, dimensions: '19ft x 6ft x 7ft' }
};

function initializeCharts() {
    // Performance Trends Chart
    const performanceCtx = document.getElementById('performanceTrendsChart');
    if (performanceCtx) {
        performanceTrendsChart = new Chart(performanceCtx.getContext('2d'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Space Utilization (%)',
                    data: [],
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#007bff',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                aspectRatio: 2.5,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: '#007bff',
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
    }

    // Order Distribution Pie Chart
    const distributionCtx = document.getElementById('orderDistributionChart');
    if (distributionCtx) {
        orderDistributionChart = new Chart(distributionCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['Optimized', 'Pending', 'Failed'],
                datasets: [{
                    data: [0, 0, 0],
                    backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                    borderWidth: 3,
                    borderColor: '#fff',
                    hoverBorderWidth: 4,
                    hoverBorderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '50%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 15,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                                return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }

    // Cost Analysis Bar Chart
    const costCtx = document.getElementById('costAnalysisChart');
    if (costCtx) {
        costAnalysisChart = new Chart(costCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Estimated Cost (₹)',
                    data: [],
                    backgroundColor: 'rgba(255, 193, 7, 0.8)',
                    borderColor: '#ffc107',
                    borderWidth: 2,
                    borderRadius: 4,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            callback: function(value) {
                                return '₹' + value.toLocaleString('en-IN');
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Cost: ₹' + context.parsed.y.toLocaleString('en-IN');
                            }
                        }
                    }
                }
            }
        });
    }

    // Truck Utilization Chart
    const utilizationCtx = document.getElementById('truckUtilizationChart');
    if (utilizationCtx) {
        truckUtilizationChart = new Chart(utilizationCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Utilization %',
                    data: [],
                    backgroundColor: [
                        'rgba(0, 123, 255, 0.8)',
                        'rgba(40, 167, 69, 0.8)',
                        'rgba(255, 193, 7, 0.8)',
                        'rgba(23, 162, 184, 0.8)',
                        'rgba(108, 117, 125, 0.8)',
                        'rgba(220, 53, 69, 0.8)'
                    ],
                    borderColor: [
                        '#007bff',
                        '#28a745',
                        '#ffc107',
                        '#17a2b8',
                        '#6c757d',
                        '#dc3545'
                    ],
                    borderWidth: 2,
                    borderRadius: 4,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    },
                    y: {
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const truckType = context.label;
                                const utilization = context.parsed.x;
                                const specs = REAL_TRUCK_SPECS[truckType];
                                let tooltip = `${truckType}: ${utilization}%`;
                                if (specs) {
                                    tooltip += `\nCapacity: ${specs.capacity}kg\nBase Rate: ₹${specs.baseRate}`;
                                }
                                return tooltip.split('\n');
                            }
                        }
                    }
                }
            }
        });
    }
}

function loadChartData() {
    // Extract actual data from the sale orders
    const saleOrdersData = extractSaleOrderData();
    
    // Update Performance Trends Chart
    updatePerformanceTrendsChart(saleOrdersData);
    
    // Update Order Distribution Chart
    updateOrderDistributionChart(saleOrdersData);
    
    // Update Cost Analysis Chart
    updateCostAnalysisChart(saleOrdersData);
    
    // Update Truck Utilization Chart
    updateTruckUtilizationChart(saleOrdersData);
}

function extractSaleOrderData() {
    const data = {
        orders: [],
        totalOrders: {{ batch.total_orders }},
        processedOrders: {{ batch.processed_orders }},
        failedOrders: {{ batch.failed_orders if batch.failed_orders else 0 }}
    };
    
    {% for order in sale_orders %}
    data.orders.push({
        orderNumber: '{{ order.sale_order_number }}',
        utilization: {{ order.estimated_utilization if order.estimated_utilization else 0 }},
        cost: {{ order.estimated_cost if order.estimated_cost else 0 }},
        status: '{{ order.status }}',
        truckType: {% if order.recommended_truck_id %}'{{ order_recommendations.get(order.id, [{}])[0].truck_type.name if order_recommendations.get(order.id) else "N/A" }}'{% else %}'N/A'{% endif %},
        totalItems: {{ order.total_items if order.total_items else 0 }},
        totalWeight: {{ order.total_weight if order.total_weight else 0 }},
        totalVolume: {{ order.total_volume if order.total_volume else 0 }}
    });
    {% endfor %}
    
    return data;
}

function updatePerformanceTrendsChart(data) {
    if (!performanceTrendsChart) return;
    
    const orderNumbers = data.orders.map(order => order.orderNumber);
    const utilizationData = data.orders.map(order => (order.utilization * 100).toFixed(1));
    
    performanceTrendsChart.data.labels = orderNumbers;
    performanceTrendsChart.data.datasets[0].data = utilizationData;
    performanceTrendsChart.update();
}

function updateOrderDistributionChart(data) {
    if (!orderDistributionChart) return;
    
    const optimizedCount = data.orders.filter(order => order.status === 'optimized').length;
    const pendingCount = data.orders.filter(order => order.status === 'pending').length;
    const failedCount = data.failedOrders;
    
    orderDistributionChart.data.datasets[0].data = [optimizedCount, pendingCount, failedCount];
    orderDistributionChart.update();
}

function updateCostAnalysisChart(data) {
    if (!costAnalysisChart) return;
    
    const orderNumbers = data.orders.map(order => order.orderNumber);
    const costData = data.orders.map(order => order.cost);
    
    costAnalysisChart.data.labels = orderNumbers;
    costAnalysisChart.data.datasets[0].data = costData;
    costAnalysisChart.update();
}

function updateTruckUtilizationChart(data) {
    if (!truckUtilizationChart) return;
    
    // Group by truck type and calculate average utilization
    const truckStats = {};
    data.orders.forEach(order => {
        if (order.truckType && order.truckType !== 'N/A') {
            if (!truckStats[order.truckType]) {
                truckStats[order.truckType] = {
                    total: 0,
                    count: 0,
                    totalCost: 0,
                    specs: REAL_TRUCK_SPECS[order.truckType] || null
                };
            }
            truckStats[order.truckType].total += order.utilization * 100;
            truckStats[order.truckType].count++;
            truckStats[order.truckType].totalCost += order.cost;
        }
    });
    
    // If no data from orders, show real truck types with actual Porter.in specifications
    if (Object.keys(truckStats).length === 0) {
        // Use real truck types from Porter.in instead of fake data
        Object.keys(REAL_TRUCK_SPECS).forEach(truckType => {
            truckStats[truckType] = {
                total: 0, // No utilization data available
                count: 1,
                totalCost: REAL_TRUCK_SPECS[truckType].baseRate,
                specs: REAL_TRUCK_SPECS[truckType]
            };
        });
    }
    
    const truckTypes = Object.keys(truckStats);
    const utilizationAverages = truckTypes.map(type => {
        const stats = truckStats[type];
        return stats.count > 0 && stats.total > 0 ?
            (stats.total / stats.count).toFixed(1) :
            0; // Show 0% if no actual utilization data
    });
    
    truckUtilizationChart.data.labels = truckTypes;
    truckUtilizationChart.data.datasets[0].data = utilizationAverages;
    truckUtilizationChart.update();
}

function updatePerformanceChart(metric) {
    if (!performanceTrendsChart) return;
    
    // Update button states
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    const data = extractSaleOrderData();
    let chartData, label, color;
    
    switch(metric) {
        case 'utilization':
            chartData = data.orders.map(order => (order.utilization * 100).toFixed(1));
            label = 'Space Utilization (%)';
            color = '#007bff';
            break;
        case 'cost':
            chartData = data.orders.map(order => order.cost);
            label = 'Estimated Cost (₹)';
            color = '#28a745';
            break;
        case 'efficiency':
            chartData = data.orders.map(order =>
                order.utilization > 0.8 ? 95 :
                order.utilization > 0.6 ? 80 :
                order.utilization > 0.4 ? 65 : 45
            );
            label = 'Efficiency Score';
            color = '#ffc107';
            break;
    }
    
    performanceTrendsChart.data.datasets[0].data = chartData;
    performanceTrendsChart.data.datasets[0].label = label;
    performanceTrendsChart.data.datasets[0].borderColor = color;
    performanceTrendsChart.data.datasets[0].backgroundColor = color + '20';
    performanceTrendsChart.update();
}

function selectTruck(orderId, truckTypeId, optimizationType = 'space') {
    // Show loading indicator
    showLoadingSpinner('Optimizing truck selection...');
    
    // Simulate API call with loading
    setTimeout(() => {
        hideLoadingSpinner();
        
        const optimizationMessage = {
            'space': 'Selected truck for maximum space utilization!',
            'cost': 'Selected truck for minimum cost optimization!',
            'balanced': 'Selected truck with balanced space and cost optimization!'
        };
        
        if (confirm(`Confirm truck selection with ${optimizationType} optimization?`)) {
            showLoadingSpinner('Confirming selection...');
            
            // Simulate confirmation process
            setTimeout(() => {
                hideLoadingSpinner();
                showSuccessMessage(optimizationMessage[optimizationType] || 'Truck selected successfully!');
                // In real implementation: updateOrderStatus(orderId, truckTypeId, optimizationType);
            }, 1500);
        }
    }, 1000);
}

// 3D Visualization Functions
function toggle3DVisualization(orderId) {
    const container = document.getElementById(`truck-3d-${orderId}`);
    const button = document.getElementById(`viz-btn-${orderId}`);
    
    if (container.style.display === 'none' || container.style.display === '') {
        container.style.display = 'block';
        button.innerHTML = '<i class="fas fa-eye-slash me-1"></i>Hide 3D View';
        load3DVisualization(orderId);
    } else {
        container.style.display = 'none';
        button.innerHTML = '<i class="fas fa-cube me-1"></i>View 3D Packing';
    }
}

function load3DVisualization(orderId) {
    const container = document.getElementById(`truck-3d-${orderId}`);
    
    // Show 3D loading animation
    container.innerHTML = `
        <div class="loading-overlay text-center pt-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading 3D visualization...</span>
            </div>
            <div class="mt-2 small text-muted">Generating 3D packing layout...</div>
            <div class="mt-1 small text-info">Calculating optimal carton placement...</div>
        </div>
    `;
    
    // Simulate 3D visualization loading
    setTimeout(() => {
        // Replace with 3D visualization
        container.innerHTML = `
            <div class="row h-100">
                <div class="col-8 h-100">
                    <div class="3d-truck-view h-100 d-flex align-items-center justify-content-center" 
                         style="background: linear-gradient(45deg, #e3f2fd 25%, transparent 25%), 
                                linear-gradient(-45deg, #e3f2fd 25%, transparent 25%); 
                                background-size: 20px 20px; border: 1px solid #90caf9;">
                        <div class="text-center">
                            <div class="truck-outline mb-2" style="
                                width: 120px; 
                                height: 80px; 
                                border: 3px solid #1976d2; 
                                background: rgba(25, 118, 210, 0.1); 
                                position: relative;
                                margin: 0 auto;
                                border-radius: 4px;
                            ">
                                <!-- Carton representations -->
                                <div style="
                                    position: absolute; 
                                    top: 5px; left: 5px; 
                                    width: 25px; height: 25px; 
                                    background: #4caf50; 
                                    border: 1px solid #388e3c;
                                    border-radius: 2px;
                                "></div>
                                <div style="
                                    position: absolute; 
                                    top: 5px; left: 35px; 
                                    width: 25px; height: 25px; 
                                    background: #ff9800; 
                                    border: 1px solid #f57c00;
                                    border-radius: 2px;
                                "></div>
                                <div style="
                                    position: absolute; 
                                    top: 35px; left: 5px; 
                                    width: 25px; height: 25px; 
                                    background: #2196f3; 
                                    border: 1px solid #1976d2;
                                    border-radius: 2px;
                                "></div>
                                <div style="
                                    position: absolute; 
                                    top: 35px; left: 35px; 
                                    width: 25px; height: 25px; 
                                    background: #9c27b0; 
                                    border: 1px solid #7b1fa2;
                                    border-radius: 2px;
                                "></div>
                            </div>
                            <small class="text-muted">3D Truck Loading View</small>
                        </div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="packing-details h-100">
                        <h6 class="text-primary mb-2">Packing Details</h6>
                        <div class="small">
                            <div class="mb-1">
                                <span class="badge" style="background: #4caf50; width: 12px; height: 12px; border-radius: 2px;"></span>
                                Small Boxes: 5 units
                            </div>
                            <div class="mb-1">
                                <span class="badge" style="background: #ff9800; width: 12px; height: 12px; border-radius: 2px;"></span>
                                Medium Boxes: 3 units
                            </div>
                            <div class="mb-1">
                                <span class="badge" style="background: #2196f3; width: 12px; height: 12px; border-radius: 2px;"></span>
                                Large Boxes: 2 units
                            </div>
                            <div class="mb-1">
                                <span class="badge" style="background: #9c27b0; width: 12px; height: 12px; border-radius: 2px;"></span>
                                Heavy Boxes: 1 unit
                            </div>
                            <hr class="my-2">
                            <div class="text-success">
                                <i class="fas fa-check-circle me-1"></i>
                                <strong>Perfect Fit!</strong>
                            </div>
                            <div class="small text-muted mt-1">
                                All cartons placed optimally with maximum space utilization.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }, 2000);
}

// Smart optimization functions
function optimizeSelection(orderId, strategy) {
    const strategyMessages = {
        'space': 'Analyzing trucks for maximum space utilization...',
        'cost': 'Calculating most cost-effective truck options...',
        'balanced': 'Finding optimal balance between space and cost...'
    };
    
    showLoadingSpinner(strategyMessages[strategy]);
    
    // Simulate optimization process
    setTimeout(() => {
        hideLoadingSpinner();
        
        const result = {
            'space': {
                message: 'Space Optimization Complete!',
                details: 'Selected smallest truck with 95% space utilization for maximum cost savings.',
                truckRecommendation: 'Mahindra Jeeto - Best space efficiency'
            },
            'cost': {
                message: 'Cost Optimization Complete!',
                details: 'Found most economical truck option with lowest total operational cost.',
                truckRecommendation: 'Tata Ace - Most cost-effective option'
            },
            'balanced': {
                message: 'Balanced Optimization Complete!',
                details: 'Optimal balance achieved between space utilization and total cost.',
                truckRecommendation: 'Ashok Leyland Dost - Best overall value'
            }
        };
        
        const optimization = result[strategy];
        showSuccessMessage(`${optimization.message}\n\n${optimization.details}\n\nRecommended: ${optimization.truckRecommendation}`);
    }, 2500);
}

// Loading and success message functions
function showLoadingSpinner(message = 'Loading...') {
    const overlay = document.getElementById('loadingOverlay');
    if (!overlay) {
        const newOverlay = document.createElement('div');
        newOverlay.id = 'loadingOverlay';
        newOverlay.className = 'loading-overlay-full';
        newOverlay.innerHTML = `
            <div class="loading-content">
                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="loading-text">${message}</div>
                <div class="loading-progress">
                    <div class="progress mt-3" style="height: 4px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(newOverlay);
    } else {
        document.querySelector('#loadingOverlay .loading-text').textContent = message;
        overlay.style.display = 'flex';
    }
}

function hideLoadingSpinner() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
}

function showSuccessMessage(message) {
    // Create and show success toast
    const toast = document.createElement('div');
    toast.className = 'toast-success';
    toast.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-check-circle text-success me-2"></i>
            <div>${message.replace(/\n/g, '<br>')}</div>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Animate in
    setTimeout(() => toast.classList.add('show'), 100);
    
    // Remove after 5 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => document.body.removeChild(toast), 300);
    }, 5000);
}

function showAllRecommendations(orderId) {
    // In a real implementation, this would show a modal with all recommendations
    alert('This would show a detailed modal with all truck recommendations for this order.');
}

function exportResults() {
    // In a real implementation, this would export the results to Excel/CSV
    const batchId = {{ batch.id }};
    window.open(`/api/sale-order-batches/${batchId}/export`, '_blank');
}
</script>
{% endblock %}