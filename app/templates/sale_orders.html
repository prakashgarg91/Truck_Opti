{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <div class="card shadow mb-4">
    <div class="card-header bg-success text-white">
      <h4 class="mb-0"><i class="fas fa-file-upload me-2"></i>Sale Order Truck Selection</h4>
      <p class="mb-0 mt-2"><small class="text-light">üìã Upload Excel/CSV file with sale orders to get best truck recommendations for each order</small></p>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <h5>Upload Sale Orders</h5>
          <form method="post" enctype="multipart/form-data" id="saleOrderUploadForm">
            <div class="mb-3">
              <label for="batch_name" class="form-label">Batch Name</label>
              <input type="text" class="form-control" id="batch_name" name="batch_name" 
                     placeholder="Enter batch name (optional)" 
                     value="Sale_Orders_{{ current_time.strftime('%Y-%m-%d_%H-%M') }}">
            </div>
            
            <div class="mb-3">
              <label for="file" class="form-label">Select File</label>
              <input type="file" class="form-control" id="file" name="file" 
                     accept=".xlsx,.csv" required>
              <div class="form-text">
                <i class="fas fa-info-circle text-info"></i>
                Supported formats: Excel (.xlsx) or CSV (.csv)
              </div>
            </div>

            <!-- New Optimization Options -->
            <div class="mb-3">
              <label class="form-label">üéØ Optimization Strategy</label>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="optimization_mode" value="cost_saving" id="costSaving" checked>
                <label class="form-check-label" for="costSaving">
                  <strong>üí∞ Cost Saving</strong> - Minimize total transportation cost
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="optimization_mode" value="space_utilization" id="spaceUtil">
                <label class="form-check-label" for="spaceUtil">
                  <strong>üì¶ Space Utilization</strong> - Maximize truck space usage
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="optimization_mode" value="balanced" id="balanced">
                <label class="form-check-label" for="balanced">
                  <strong>‚öñÔ∏è Balanced</strong> - Optimize both cost and space
                </label>
              </div>
            </div>

            <div class="mb-3">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="enable_consolidation" id="enableConsolidation" checked>
                <label class="form-check-label" for="enableConsolidation">
                  <strong>üöö Enable Order Consolidation</strong><br>
                  <small class="text-muted">Combine multiple orders into single trucks for maximum cost savings</small>
                </label>
              </div>
            </div>

            <!-- Stress Test Options -->
            <div class="mb-3">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="stress_test_mode" id="stressTestMode">
                <label class="form-check-label" for="stressTestMode">
                  <strong>‚ö° Stress Test Mode</strong><br>
                  <small class="text-muted">Enable enhanced processing for large datasets (lakhs of cartons)</small>
                </label>
              </div>
            </div>
            
            <button type="submit" class="btn btn-success btn-lg" id="uploadBtn">
              <i class="fas fa-upload me-1"></i>Upload and Process
            </button>

            <button type="button" class="btn btn-warning ms-2" id="stressTestBtn" onclick="runStressTest()">
              <i class="fas fa-bolt me-1"></i>Run Stress Test
            </button>
          </form>
        </div>
        
        <div class="col-md-6">
          <h5>File Format Requirements</h5>
          <div class="alert alert-info">
            <strong>Required Columns:</strong>
            <ul class="mb-2">
              <li><code>sale_order_number</code> - Unique order identifier</li>
              <li><code>carton_name</code> - Carton type name (must match existing cartons)</li>
              <li><code>carton_code</code> - Carton type code</li>
              <li><code>quantity</code> - Number of cartons</li>
            </ul>
            
            <strong>Optional Columns:</strong>
            <ul class="mb-0">
              <li><code>customer_name</code> - Customer name</li>
              <li><code>delivery_address</code> - Delivery location</li>
              <li><code>order_date</code> - Order date</li>
            </ul>
          </div>
          
          <div class="mt-3">
            <a href="#" class="btn btn-outline-primary btn-sm" onclick="downloadSampleFile()">
              <i class="fas fa-download me-1"></i>Download Sample File
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Batches -->
  {% if recent_batches %}
  <div class="card shadow">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Processing Batches</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="table-light">
            <tr>
              <th>Batch Name</th>
              <th>File</th>
              <th>Orders</th>
              <th>Status</th>
              <th>Processing Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for batch in recent_batches %}
            <tr>
              <td>
                <strong>{{ batch.batch_name }}</strong>
              </td>
              <td>
                <small class="text-muted">{{ batch.filename }}</small>
              </td>
              <td>
                <div class="d-flex align-items-center">
                  <span class="badge bg-secondary me-2">{{ batch.total_orders }}</span>
                  {% if batch.processed_orders %}
                    <small class="text-success">‚úì {{ batch.processed_orders }} processed</small>
                  {% endif %}
                  {% if batch.failed_orders > 0 %}
                    <small class="text-danger">‚úó {{ batch.failed_orders }} failed</small>
                  {% endif %}
                </div>
              </td>
              <td>
                {% if batch.status == 'completed' %}
                  <span class="badge bg-success">Completed</span>
                {% elif batch.status == 'processing' %}
                  <span class="badge bg-warning">Processing</span>
                {% elif batch.status == 'completed_with_errors' %}
                  <span class="badge bg-warning">Completed with Errors</span>
                {% else %}
                  <span class="badge bg-danger">Failed</span>
                {% endif %}
              </td>
              <td>
                <small>{{ batch.date_created.strftime('%Y-%m-%d %H:%M') }}</small>
              </td>
              <td>
                <a href="{{ url_for('main.sale_order_results', batch_id=batch.id) }}" 
                   class="btn btn-outline-primary btn-sm">
                  <i class="fas fa-eye me-1"></i>View Results
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('saleOrderUploadForm');
    const uploadBtn = document.getElementById('uploadBtn');
    const fileInput = document.getElementById('file');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!fileInput.files[0]) {
            alert('Please select a file to upload');
            return;
        }
        
        const file = fileInput.files[0];
        const validTypes = ['.xlsx', '.csv'];
        const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
        const stressTestMode = document.getElementById('stressTestMode').checked;
        
        if (!validTypes.includes(fileExtension)) {
            e.preventDefault();
            alert('Please upload a valid Excel (.xlsx) or CSV (.csv) file');
            return;
        }
        
        // Show enhanced processing state with appropriate loader
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
        
        if (stressTestMode || file.size > 1024 * 1024) { // If stress test mode or file > 1MB
            // Use stress test progress loader
            progressLoader.startStressTest(100000, 'Processing Large Dataset');
        } else {
            // Use regular progress loader
            progressLoader.startRealisticSim('Processing Sale Orders', 8);
        }
        
        // Submit the form with enhanced form data
        const formData = new FormData(form);
        
        fetch(form.action || window.location.href, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.redirected) {
                progressLoader.complete("Processing complete! Redirecting to results...");
                setTimeout(() => {
                    window.location.href = response.url;
                }, 1500);
            } else if (response.ok) {
                return response.text();
            } else {
                throw new Error('Upload failed');
            }
        })
        .then(html => {
            if (html) {
                progressLoader.complete("Processing complete!");
                setTimeout(() => {
                    document.body.innerHTML = html;
                }, 1500);
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            progressLoader.hide();
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<i class="fas fa-upload me-1"></i>Upload and Process';
            alert('An error occurred during processing. Please try again.');
        });
    });
});

function downloadSampleFile() {
    // Create sample CSV data with carton types
    const sampleData = `sale_order_number,carton_name,carton_code,quantity,customer_name,delivery_address,order_date
SO001,Small Box,SB001,5,ABC Electronics,123 Business St Mumbai,2025-08-10
SO001,Medium Box,MB001,3,ABC Electronics,123 Business St Mumbai,2025-08-10
SO002,Large Box,LB001,8,XYZ Corporation,456 Corporate Ave Delhi,2025-08-10
SO002,Heavy Box,HB001,4,XYZ Corporation,456 Corporate Ave Delhi,2025-08-10
SO003,Small Box,SB001,15,Tech Solutions Ltd,789 Technology Park Bangalore,2025-08-10
SO003,Medium Box,MB001,10,Tech Solutions Ltd,789 Technology Park Bangalore,2025-08-10`;
    
    const blob = new Blob([sampleData], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = 'sale_orders_sample.csv';
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
}

function runStressTest() {
    // Generate large dataset for stress testing
    const stressTestBtn = document.getElementById('stressTestBtn');
    stressTestBtn.disabled = true;
    stressTestBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Running...';
    
    // Start stress test visualization
    progressLoader.startStressTest(250000, "Stress Testing TruckOpti Engine");
    
    // Simulate stress test processing
    setTimeout(() => {
        // Generate sample large dataset
        let csvData = 'sale_order_number,carton_name,carton_code,quantity,customer_name,delivery_address,order_date\n';
        
        const cartonTypes = [
            {name: 'Small Box', code: 'SB001'},
            {name: 'Medium Box', code: 'MB001'},
            {name: 'Large Box', code: 'LB001'},
            {name: 'Heavy Box', code: 'HB001'},
            {name: 'Extra Large', code: 'XL001'}
        ];
        
        const cities = ['Mumbai', 'Delhi', 'Bangalore', 'Chennai', 'Hyderabad', 'Pune', 'Kolkata'];
        
        // Generate 1000 orders with multiple items each (simulating lakhs of cartons)
        for (let i = 1; i <= 1000; i++) {
            const orderNum = `STRESS-${String(i).padStart(4, '0')}`;
            const city = cities[Math.floor(Math.random() * cities.length)];
            const numItems = Math.floor(Math.random() * 5) + 1; // 1-5 items per order
            
            for (let j = 0; j < numItems; j++) {
                const carton = cartonTypes[Math.floor(Math.random() * cartonTypes.length)];
                const quantity = Math.floor(Math.random() * 50) + 1; // 1-50 cartons per item
                
                csvData += `${orderNum},${carton.name},${carton.code},${quantity},Stress Test Customer ${i},${i*100} Test Street ${city},2025-08-11\n`;
            }
        }
        
        // Create and download the stress test file
        const blob = new Blob([csvData], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = 'stress_test_orders.csv';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // Complete stress test
        progressLoader.complete("Stress test complete! File downloaded successfully.");
        
        setTimeout(() => {
            stressTestBtn.disabled = false;
            stressTestBtn.innerHTML = '<i class="fas fa-bolt me-1"></i>Run Stress Test';
            
            alert('Stress test file generated successfully!\n\n' +
                  'üìä Generated 1000+ orders with multiple items each\n' +
                  'üöö File contains thousands of cartons for testing\n' +
                  '‚ö° Enable "Stress Test Mode" when uploading this file\n\n' +
                  'The file has been downloaded to your computer.');
        }, 2000);
        
    }, 5000); // Simulate 5 seconds of stress test processing
}
</script>
{% endblock %}