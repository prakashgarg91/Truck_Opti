{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <div class="card shadow mb-4">
    <div class="card-header bg-primary text-white">
      <h4 class="mb-0"><i class="bi bi-lightbulb"></i> Recommend Truck for Cartons</h4>
    </div>
    <div class="card-body">
      <form method="post" id="cartonForm">
        <div id="cartonRows">
          <div class="row mb-2 carton-row align-items-end">
            <div class="col-md-6">
              <label class="form-label">Carton Type <i class="bi bi-info-circle" title="Select the type of carton"></i></label>
              <select name="carton_type_1" class="form-select carton-type-select" required>
                <option value="" disabled selected>Select Carton Type</option>
                {% for carton in cartons %}
                <option value="{{ carton.id }}" data-size="{{ carton.length }}x{{ carton.width }}x{{ carton.height }}">
                  {{ carton.name }} ({{ carton.length }}x{{ carton.width }}x{{ carton.height }} cm)
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Quantity</label>
              <input type="number" name="carton_qty_1" class="form-control" min="1" placeholder="Quantity" required>
            </div>
            <div class="col-md-3">
              <button type="button" class="btn btn-danger remove-row" style="display:none">Remove</button>
            </div>
          </div>
        </div>
        <div class="d-flex gap-2 mb-3">
          <button type="button" class="btn btn-outline-secondary" id="addRow"><i class="bi bi-plus-lg"></i> Add Carton</button>
          <button type="submit" class="btn btn-success"><i class="bi bi-search"></i> Recommend Truck</button>
        </div>
      </form>
    </div>
  </div>

  {% if recommended %}
  <div class="card shadow">
    <div class="card-header bg-info text-white">
      <h5 class="mb-0"><i class="bi bi-truck"></i> Recommended Trucks</h5>
    </div>
    <div class="card-body">
      <table class="table table-bordered table-hover">
        <thead class="table-light">
          <tr>
            <th>Truck</th>
            <th>Utilization</th>
            <th>Total Cost</th>
            <th>Fitted Items</th>
          </tr>
        </thead>
        <tbody>
          {% for r in recommended %}
          <tr>
            <td>{{ r.bin_name }}</td>
            <td>{{ (r.utilization * 100)|round(2) }}%</td>
            <td>â‚¹{{ r.total_cost|round(2) }}</td>
            <td>{{ r.fitted_items|length }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}
</div>
<!-- Results now shown in card above -->
{% endblock %}
{% block scripts %}
<script>
let rowCount = 1;
document.getElementById('addRow').onclick = function() {
  rowCount++;
  const row = document.createElement('div');
  row.className = 'row mb-2 carton-row';
  row.innerHTML = `
    <div class="col-md-6">
      <select name="carton_type_${rowCount}" class="form-select carton-type-select" required>
        <option value="" disabled selected>Select Carton Type</option>
        {% for carton in cartons %}
        <option value="{{ carton.id }}" data-size="{{ carton.length }}x{{ carton.width }}x{{ carton.height }}">
          {{ carton.name }} ({{ carton.length }}x{{ carton.width }}x{{ carton.height }} cm)
        </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <input type="number" name="carton_qty_${rowCount}" class="form-control" min="1" placeholder="Quantity" required>
    </div>
    <div class="col-md-3">
      <button type="button" class="btn btn-danger remove-row">Remove</button>
    </div>
  `;
  document.getElementById('cartonRows').appendChild(row);
  updateRemoveButtons();
};

function updateRemoveButtons() {
  const rows = document.querySelectorAll('.carton-row');
  rows.forEach((row, idx) => {
    const btn = row.querySelector('.remove-row');
    btn.style.display = rows.length > 1 ? '' : 'none';
    btn.onclick = function() {
      row.remove();
      updateRemoveButtons();
    };
  });
}
updateRemoveButtons();
</script>
{% endblock %}
