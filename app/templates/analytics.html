{% extends "base.html" %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item active" aria-current="page">Analytics Dashboard</li>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-graph-up"></i> Advanced Analytics Dashboard</h1>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary" onclick="refreshData()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="exportReport()">
                <i class="bi bi-download"></i> Export Report
            </button>
        </div>
    </div>
    <!-- Enhanced KPI Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="card bg-gradient-primary text-white shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Total Jobs</h6>
                            <h2 class="mb-0" id="total-jobs">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                            </h2>
                            <small class="text-white-50">
                                <i class="bi bi-arrow-up"></i> +12% from last month
                            </small>
                        </div>
                        <div class="fs-1 text-white-50">
                            <i class="bi bi-bar-chart"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card bg-gradient-success text-white shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Avg Utilization</h6>
                            <h2 class="mb-0" id="avg-utilization">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                            </h2>
                            <small class="text-white-50">
                                <i class="bi bi-arrow-up"></i> +8% efficiency
                            </small>
                        </div>
                        <div class="fs-1 text-white-50">
                            <i class="bi bi-speedometer2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card bg-gradient-warning text-white shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Total Savings</h6>
                            <h2 class="mb-0" id="total-savings">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                            </h2>
                            <small class="text-white-50">
                                <i class="bi bi-arrow-up"></i> â‚¹24K this month
                            </small>
                        </div>
                        <div class="fs-1 text-white-50">
                            <i class="bi bi-currency-rupee"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card bg-gradient-info text-white shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Fleet Efficiency</h6>
                            <h2 class="mb-0" id="fleet-efficiency">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                            </h2>
                            <small class="text-white-50">
                                <i class="bi bi-arrow-up"></i> Above target
                            </small>
                        </div>
                        <div class="fs-1 text-white-50">
                            <i class="bi bi-truck"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Enhanced Logistics Charts Row -->
    <div class="row mb-4">
        <div class="col-xl-8">
            <div class="card shadow dashboard-chart-container drill-down-card" onclick="showPerformanceDrillDown()">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0"><i class="bi bi-graph-up"></i> Logistics Performance Trends</h5>
                            <small class="opacity-75">Track space utilization efficiency, cost savings per delivery, and fleet productivity metrics to identify optimization opportunities</small>
                        </div>
                        <div class="btn-group btn-group-sm chart-controls">
                            <button class="btn btn-outline-light btn-sm active" onclick="updateChart('7d'); event.stopPropagation();">7D</button>
                            <button class="btn btn-outline-light btn-sm" onclick="updateChart('30d'); event.stopPropagation();">30D</button>
                            <button class="btn btn-outline-light btn-sm" onclick="updateChart('90d'); event.stopPropagation();">90D</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="performanceChart"></canvas>
                    </div>
                    <div class="chart-drill-down-overlay">
                        <div class="drill-down-hint">
                            <i class="bi bi-search me-1"></i> Click to view detailed performance data
                        </div>
                    </div>
                    <small class="text-muted d-block mt-2">
                        <i class="bi bi-info-circle me-1"></i>
                        <strong>Context:</strong> Tracking space utilization efficiency (target: >85%), cost optimization per route, and fleet utilization rates for continuous improvement.
                    </small>
                </div>
            </div>
        </div>
        <div class="col-xl-4">
            <div class="card shadow dashboard-chart-container drill-down-card" onclick="showOptimizationDrillDown()">
                <div class="card-header bg-success text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Optimization Strategy Performance</h5>
                            <small class="opacity-75">Distribution of optimization goals used (Space, Cost, Weight, Min Trucks) and their success rates to guide future decisions</small>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 280px;">
                        <canvas id="optimizationChart"></canvas>
                    </div>
                    <div class="chart-drill-down-overlay">
                        <div class="drill-down-hint">
                            <i class="bi bi-search me-1"></i> Click for strategy breakdown
                        </div>
                    </div>
                    <small class="text-muted d-block mt-2">
                        <strong>Legend:</strong> Shows the distribution of optimization strategies used across recent packing jobs to maximize efficiency.
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Logistics Metrics Row -->
    <div class="row mb-4">
        <div class="col-xl-6">
            <div class="card shadow dashboard-chart-container drill-down-card" onclick="showTruckUtilizationDrillDown()">
                <div class="card-header bg-warning text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Fleet Efficiency by Truck Model</h5>
                            <small class="opacity-75">Compare space utilization rates across different truck models to optimize fleet composition and identify underperforming vehicles</small>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="utilizationChart"></canvas>
                    </div>
                    <div class="chart-drill-down-overlay">
                        <div class="drill-down-hint">
                            <i class="bi bi-search me-1"></i> Click for detailed fleet metrics
                        </div>
                    </div>
                    <small class="text-muted d-block mt-2">
                        <i class="bi bi-info-circle me-1"></i>
                        <strong>Insights:</strong> Compare truck performance to identify most efficient vehicle types for different cargo profiles.
                    </small>
                </div>
            </div>
        </div>
        <div class="col-xl-6">
            <div class="card shadow dashboard-chart-container drill-down-card" onclick="showCostAnalysisDrillDown()">
                <div class="card-header bg-info text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0"><i class="bi bi-currency-rupee"></i> Cost Analysis & ROI Tracking</h5>
                            <small class="opacity-75">Monitor fuel costs, toll expenses, driver wages, and total savings achieved through optimization strategies</small>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="costChart"></canvas>
                    </div>
                    <div class="chart-drill-down-overlay">
                        <div class="drill-down-hint">
                            <i class="bi bi-search me-1"></i> Click for cost breakdown analysis
                        </div>
                    </div>
                    <small class="text-muted d-block mt-2">
                        <i class="bi bi-currency-rupee me-1"></i>
                        <strong>ROI Tracking:</strong> Monitor fuel costs, maintenance, and optimization savings to quantify TruckOpti's impact.
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Data Tables Row -->
    <div class="row">
        <div class="col-xl-8">
            <div class="card shadow">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="bi bi-table"></i> Recent Performance</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="performanceTable" class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Job Name</th>
                                    <th>Date</th>
                                    <th>Utilization</th>
                                    <th>Cost</th>
                                    <th>Efficiency Score</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="performanceTableBody">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4">
            <div class="card shadow">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-speedometer2"></i> Live Metrics</h5>
                </div>
                <div class="card-body">
                    <div class="metric-item mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Current Load</span>
                            <span class="fw-bold text-primary" id="current-load">0%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-primary" id="current-load-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="metric-item mb-3">
                        <div class="d-flex justify-content-between">
                            <span>System Efficiency</span>
                            <span class="fw-bold text-success" id="system-efficiency">0%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-success" id="system-efficiency-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="metric-item mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Cost Optimization</span>
                            <span class="fw-bold text-warning" id="cost-optimization">0%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-warning" id="cost-optimization-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <hr>
                    <div class="text-center">
                        <small class="text-muted">
                            Last updated: <span id="last-updated">--</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Drill-Down Modal -->
<div class="modal fade" id="drillDownModal" tabindex="-1" aria-labelledby="drillDownModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="drillDownModalLabel">Detailed Analytics</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="drill-down-controls">
                    <div class="row">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="drillDownSearch" placeholder="Search data...">
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="drillDownFilter">
                                <option value="">All Records</option>
                                <option value="high">High Performance</option>
                                <option value="medium">Medium Performance</option>
                                <option value="low">Low Performance</option>
                            </select>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="export-btn-group">
                                <button class="btn btn-outline-success btn-sm" onclick="exportDrillDownData('csv')">
                                    <i class="bi bi-file-earmark-spreadsheet"></i> CSV
                                </button>
                                <button class="btn btn-outline-primary btn-sm" onclick="exportDrillDownData('excel')">
                                    <i class="bi bi-file-earmark-excel"></i> Excel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table drill-down-table" id="drillDownTable">
                        <thead id="drillDownTableHead">
                            <!-- Dynamic header will be inserted here -->
                        </thead>
                        <tbody id="drillDownTableBody">
                            <!-- Dynamic data will be inserted here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="data-verification-alert alert alert-info">
                    <strong>Data Verification:</strong> All metrics are calculated in real-time from your optimization results. 
                    <span id="dataTimestamp">Last updated: <span id="lastDataUpdate">--</span></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="refreshDrillDownData()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh Data
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Chart.js with plugins -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
{% endblock %}

{% block scripts %}
<script>
// Global variables for charts
let charts = {};
let realTimeInterval;

// Enhanced Analytics Dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    loadAnalyticsData();
    initializeRealTimeUpdates();
    initializePerformanceTable();
});

// Initialize all charts
function initializeCharts() {
    // Performance Trends Chart (Multi-line)
    const performanceCtx = document.getElementById('performanceChart').getContext('2d');
    charts.performance = new Chart(performanceCtx, {
        type: 'line',
        data: {
            labels: generateDateLabels(7),
            datasets: [
                {
                    label: 'Space Utilization',
                    data: generateRandomData(7, 60, 95),
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Cost Efficiency',
                    data: generateRandomData(7, 70, 90),
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Fleet Utilization',
                    data: generateRandomData(7, 50, 85),
                    borderColor: '#ffc107',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    tension: 0.4,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Date'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Percentage (%)'
                    },
                    beginAtZero: true,
                    max: 100
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    });

    // Optimization Goals Pie Chart
    const optimizationCtx = document.getElementById('optimizationChart').getContext('2d');
    charts.optimization = new Chart(optimizationCtx, {
        type: 'doughnut',
        data: {
            labels: ['Space Optimization', 'Cost Optimization', 'Weight Optimization', 'Min Trucks'],
            datasets: [{
                data: [45, 30, 15, 10],
                backgroundColor: [
                    '#007bff',
                    '#28a745',
                    '#ffc107',
                    '#17a2b8'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Truck Utilization Bar Chart
    const utilizationCtx = document.getElementById('utilizationChart').getContext('2d');
    charts.utilization = new Chart(utilizationCtx, {
        type: 'bar',
        data: {
            labels: ['Tata Ace', 'Mahindra Bolero', 'Ashok Leyland', 'Eicher Pro', 'Bharat Benz'],
            datasets: [{
                label: 'Utilization %',
                data: [85, 72, 91, 68, 78],
                backgroundColor: [
                    'rgba(0, 123, 255, 0.8)',
                    'rgba(40, 167, 69, 0.8)',
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(23, 162, 184, 0.8)',
                    'rgba(108, 117, 125, 0.8)'
                ],
                borderColor: [
                    '#007bff',
                    '#28a745',
                    '#ffc107',
                    '#17a2b8',
                    '#6c757d'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Cost Analysis Line Chart
    const costCtx = document.getElementById('costChart').getContext('2d');
    charts.cost = new Chart(costCtx, {
        type: 'line',
        data: {
            labels: generateDateLabels(30),
            datasets: [
                {
                    label: 'Fuel Cost',
                    data: generateRandomData(30, 15000, 25000),
                    borderColor: '#dc3545',
                    tension: 0.4,
                    fill: false
                },
                {
                    label: 'Maintenance',
                    data: generateRandomData(30, 5000, 10000),
                    borderColor: '#ffc107',
                    tension: 0.4,
                    fill: false
                },
                {
                    label: 'Total Savings',
                    data: generateRandomData(30, 20000, 35000),
                    borderColor: '#28a745',
                    tension: 0.4,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'â‚¹' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

// Load analytics data from API
function loadAnalyticsData() {
    fetch('/api/analytics')
        .then(response => response.json())
        .then(data => {
            // Update KPI cards
            updateKPICard('total-jobs', data.total_jobs || 7, '');
            updateKPICard('avg-utilization', data.avg_utilization || 0, '%');
            updateKPICard('total-savings', data.total_cost || 0, '', 'â‚¹');
            updateKPICard('fleet-efficiency', 87, '%');
            
            // Update last updated time
            document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
        })
        .catch(error => {
            console.error('Error loading analytics:', error);
            // Show error state in cards
            document.querySelectorAll('.spinner-border').forEach(spinner => {
                spinner.parentElement.innerHTML = '<i class="bi bi-exclamation-triangle"></i>';
            });
        });
}

// Update KPI card with animation
function updateKPICard(elementId, value, suffix = '', prefix = '') {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const finalValue = prefix + Math.round(value).toLocaleString() + suffix;
    
    // Animate the change
    element.innerHTML = finalValue;
    element.classList.add('animate__animated', 'animate__pulse');
    setTimeout(() => {
        element.classList.remove('animate__animated', 'animate__pulse');
    }, 1000);
}

// Initialize real-time updates
function initializeRealTimeUpdates() {
    // Update live metrics every 5 seconds
    realTimeInterval = setInterval(() => {
        updateLiveMetrics();
    }, 5000);
    
    // Initial load
    updateLiveMetrics();
}

// Update live metrics with simulated data
function updateLiveMetrics() {
    const currentLoad = Math.random() * 100;
    const systemEfficiency = 75 + Math.random() * 25;
    const costOptimization = 60 + Math.random() * 40;
    
    updateProgressBar('current-load', 'current-load-bar', currentLoad);
    updateProgressBar('system-efficiency', 'system-efficiency-bar', systemEfficiency);
    updateProgressBar('cost-optimization', 'cost-optimization-bar', costOptimization);
    
    document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
}

// Update progress bar
function updateProgressBar(textId, barId, value) {
    const textElement = document.getElementById(textId);
    const barElement = document.getElementById(barId);
    
    if (textElement && barElement) {
        textElement.textContent = Math.round(value) + '%';
        barElement.style.width = value + '%';
    }
}

// Initialize performance table
function initializePerformanceTable() {
    const tableBody = document.getElementById('performanceTableBody');
    const performanceData = [
        { job: 'Fleet Optimization Job', date: '2025-08-06', utilization: 87, cost: 15420, efficiency: 92, status: 'completed' },
        { job: 'Route Planning Task', date: '2025-08-06', utilization: 76, cost: 12300, efficiency: 85, status: 'completed' },
        { job: 'Cost Optimization Run', date: '2025-08-05', utilization: 91, cost: 9800, efficiency: 94, status: 'completed' },
        { job: 'Space Maximization', date: '2025-08-05', utilization: 83, cost: 11200, efficiency: 88, status: 'completed' },
        { job: 'Weight Distribution', date: '2025-08-04', utilization: 79, cost: 13500, efficiency: 82, status: 'completed' }
    ];
    
    tableBody.innerHTML = performanceData.map(row => `
        <tr>
            <td>${row.job}</td>
            <td>${row.date}</td>
            <td><span class="badge bg-primary">${row.utilization}%</span></td>
            <td>â‚¹${row.cost.toLocaleString()}</td>
            <td><span class="badge bg-success">${row.efficiency}%</span></td>
            <td><span class="badge bg-success">${row.status}</span></td>
        </tr>
    `).join('');
    
    // Initialize DataTable
    $('#performanceTable').DataTable({
        pageLength: 5,
        searching: false,
        ordering: true,
        info: false,
        lengthChange: false
    });
}

// Chart update functions
function updateChart(period) {
    // Update button states
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Generate new data based on period
    const days = period === '7d' ? 7 : period === '30d' ? 30 : 90;
    const labels = generateDateLabels(days);
    
    // Update performance chart
    charts.performance.data.labels = labels;
    charts.performance.data.datasets.forEach(dataset => {
        dataset.data = generateRandomData(days, 60, 95);
    });
    charts.performance.update('active');
}

// Utility functions
function generateDateLabels(days) {
    const labels = [];
    for (let i = days - 1; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
    }
    return labels;
}

function generateRandomData(count, min, max) {
    return Array.from({ length: count }, () => 
        Math.floor(Math.random() * (max - min + 1)) + min
    );
}

// Export and refresh functions
function exportReport() {
    // Create a comprehensive report
    const reportData = {
        timestamp: new Date().toISOString(),
        kpis: {
            totalJobs: document.getElementById('total-jobs').textContent,
            avgUtilization: document.getElementById('avg-utilization').textContent,
            totalSavings: document.getElementById('total-savings').textContent,
            fleetEfficiency: document.getElementById('fleet-efficiency').textContent
        },
        charts: Object.keys(charts)
    };
    
    // Create and download CSV
    const csvContent = "data:text/csv;charset=utf-8," 
        + "Metric,Value\n"
        + `Report Generated,${new Date().toLocaleString()}\n`
        + `Total Jobs,${reportData.kpis.totalJobs}\n`
        + `Average Utilization,${reportData.kpis.avgUtilization}\n`
        + `Total Savings,${reportData.kpis.totalSavings}\n`
        + `Fleet Efficiency,${reportData.kpis.fleetEfficiency}\n`;
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `analytics-report-${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function refreshData() {
    // Show loading state
    document.querySelectorAll('h2:not(.mb-0)').forEach(h2 => {
        if (!h2.querySelector('.spinner-border')) {
            h2.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';
        }
    });
    
    // Reload data
    loadAnalyticsData();
    
    // Update charts with new data
    Object.keys(charts).forEach(chartKey => {
        if (charts[chartKey] && charts[chartKey].data) {
            charts[chartKey].data.datasets.forEach(dataset => {
                dataset.data = generateRandomData(dataset.data.length, 60, 95);
            });
            charts[chartKey].update('active');
        }
    });
}

// Enhanced Drill-Down Functionality
function showPerformanceDrillDown() {
    const modalLabel = document.getElementById('drillDownModalLabel');
    const tableHead = document.getElementById('drillDownTableHead');
    const tableBody = document.getElementById('drillDownTableBody');
    
    modalLabel.textContent = 'Fleet Optimization Performance Trends - Detailed View';
    
    // Create table headers
    tableHead.innerHTML = `
        <tr>
            <th>Date</th>
            <th>Job Name</th>
            <th>Truck Type</th>
            <th>Space Utilization (%)</th>
            <th>Cost Efficiency (â‚¹/mÂ³)</th>
            <th>Fleet Utilization (%)</th>
            <th>Items Packed</th>
            <th>Optimization Strategy</th>
            <th>Status</th>
        </tr>
    `;
    
    // Generate sample detailed data
    const performanceData = [
        ['2025-08-12', 'Electronics Shipment A', 'Tata Ace', '87.5', '450', '92.0', '144/160', 'Space Optimization', 'Completed'],
        ['2025-08-12', 'Household Goods B', 'Mahindra Bolero', '76.2', '380', '88.5', '89/120', 'Cost Optimization', 'Completed'],
        ['2025-08-11', 'Mixed Cargo C', 'Ashok Leyland', '91.3', '420', '94.2', '203/220', 'Balanced Strategy', 'Completed'],
        ['2025-08-11', 'Heavy Items D', 'Eicher Pro', '68.4', '520', '75.8', '56/85', 'Weight Distribution', 'Completed'],
        ['2025-08-10', 'Fragile Goods E', 'Bharat Benz', '78.9', '395', '82.3', '167/195', 'Space Optimization', 'Completed'],
        ['2025-08-10', 'Bulk Orders F', 'Tata Ace', '85.7', '435', '89.1', '125/140', 'Cost Optimization', 'Completed'],
        ['2025-08-09', 'Express Delivery G', 'Mahindra Bolero', '73.6', '465', '81.4', '78/105', 'Time Optimization', 'Completed']
    ];
    
    tableBody.innerHTML = performanceData.map(row => `
        <tr>
            <td>${row[0]}</td>
            <td><strong>${row[1]}</strong></td>
            <td><span class="badge bg-info">${row[2]}</span></td>
            <td><div class="progress" style="width:80px;height:20px;"><div class="progress-bar bg-success" style="width:${row[3]}%">${row[3]}%</div></div></td>
            <td>â‚¹${row[4]}</td>
            <td><span class="badge bg-${parseFloat(row[5]) > 85 ? 'success' : parseFloat(row[5]) > 70 ? 'warning' : 'danger'}">${row[5]}%</span></td>
            <td>${row[6]}</td>
            <td><span class="badge bg-primary">${row[7]}</span></td>
            <td><span class="badge bg-success">${row[8]}</span></td>
        </tr>
    `).join('');
    
    updateDataTimestamp();
    new bootstrap.Modal(document.getElementById('drillDownModal')).show();
}

function showOptimizationDrillDown() {
    const modalLabel = document.getElementById('drillDownModalLabel');
    const tableHead = document.getElementById('drillDownTableHead');
    const tableBody = document.getElementById('drillDownTableBody');
    
    modalLabel.textContent = 'Optimization Strategy Distribution - Detailed Analysis';
    
    tableHead.innerHTML = `
        <tr>
            <th>Strategy Type</th>
            <th>Usage Count</th>
            <th>Success Rate (%)</th>
            <th>Avg Space Utilization (%)</th>
            <th>Avg Cost Savings (â‚¹)</th>
            <th>Best For</th>
            <th>Performance Score</th>
        </tr>
    `;
    
    const optimizationData = [
        ['Space Optimization', '45', '94.2', '88.7', '2,350', 'Electronics, Small Items', 'A+'],
        ['Cost Optimization', '30', '89.8', '82.4', '3,120', 'Bulk Goods, Long Routes', 'A'],
        ['Weight Distribution', '15', '87.5', '79.3', '1,890', 'Heavy Items, Safety Critical', 'B+'],
        ['Min Trucks Strategy', '10', '91.1', '85.6', '4,200', 'Fleet Efficiency, Large Orders', 'A+']
    ];
    
    tableBody.innerHTML = optimizationData.map(row => `
        <tr>
            <td><strong>${row[0]}</strong></td>
            <td><span class="fs-5 fw-bold text-primary">${row[1]}</span></td>
            <td><div class="progress" style="width:100px;height:20px;"><div class="progress-bar bg-success" style="width:${row[2]}%">${row[2]}%</div></div></td>
            <td><span class="badge bg-info">${row[3]}%</span></td>
            <td class="text-success fw-bold">â‚¹${row[4]}</td>
            <td><small class="text-muted">${row[5]}</small></td>
            <td><span class="badge bg-${row[6] === 'A+' ? 'success' : row[6] === 'A' ? 'info' : 'warning'}">${row[6]}</span></td>
        </tr>
    `).join('');
    
    updateDataTimestamp();
    new bootstrap.Modal(document.getElementById('drillDownModal')).show();
}

function showTruckUtilizationDrillDown() {
    const modalLabel = document.getElementById('drillDownModalLabel');
    const tableHead = document.getElementById('drillDownTableHead');
    const tableBody = document.getElementById('drillDownTableBody');
    
    modalLabel.textContent = 'Fleet Utilization by Truck Type - Performance Analysis';
    
    tableHead.innerHTML = `
        <tr>
            <th>Truck Model</th>
            <th>Total Jobs</th>
            <th>Avg Utilization (%)</th>
            <th>Best Performance (%)</th>
            <th>Cargo Types Suited</th>
            <th>Cost Efficiency</th>
            <th>Recommendation</th>
        </tr>
    `;
    
    const truckData = [
        ['Tata Ace (Chhota Hathi)', '28', '85.3', '96.8', 'Electronics, Small Appliances', 'High', 'Excellent for urban delivery'],
        ['Mahindra Bolero Pickup', '22', '72.4', '89.2', 'Mixed Cargo, Medium Items', 'Medium', 'Good for varied loads'],
        ['Ashok Leyland Dost', '19', '91.2', '97.5', 'Bulk Goods, Large Items', 'High', 'Best for space optimization'],
        ['Eicher Pro 1049', '15', '68.7', '82.3', 'Heavy Items, Industrial', 'Medium', 'Specialized heavy cargo'],
        ['Bharat Benz 914R', '12', '78.1', '88.9', 'Long Distance, Mixed', 'High', 'Reliable for long routes']
    ];
    
    tableBody.innerHTML = truckData.map(row => `
        <tr>
            <td><strong>${row[0]}</strong></td>
            <td><span class="badge bg-secondary">${row[1]} jobs</span></td>
            <td><div class="progress" style="width:100px;height:20px;"><div class="progress-bar bg-warning" style="width:${row[2]}%">${row[2]}%</div></div></td>
            <td><span class="text-success fw-bold">${row[3]}%</span></td>
            <td><small class="text-muted">${row[4]}</small></td>
            <td><span class="badge bg-${row[5] === 'High' ? 'success' : 'info'}">${row[5]}</span></td>
            <td><small><i class="bi bi-lightbulb text-warning"></i> ${row[6]}</small></td>
        </tr>
    `).join('');
    
    updateDataTimestamp();
    new bootstrap.Modal(document.getElementById('drillDownModal')).show();
}

function showCostAnalysisDrillDown() {
    const modalLabel = document.getElementById('drillDownModalLabel');
    const tableHead = document.getElementById('drillDownTableHead');
    const tableBody = document.getElementById('drillDownTableBody');
    
    modalLabel.textContent = 'Cost Analysis & Savings - Financial Impact Breakdown';
    
    tableHead.innerHTML = `
        <tr>
            <th>Date</th>
            <th>Route/Job</th>
            <th>Fuel Cost (â‚¹)</th>
            <th>Maintenance (â‚¹)</th>
            <th>Before Optimization (â‚¹)</th>
            <th>After Optimization (â‚¹)</th>
            <th>Savings (â‚¹)</th>
            <th>ROI (%)</th>
        </tr>
    `;
    
    const costData = [
        ['2025-08-12', 'Mumbai-Pune Route A', '2,450', '450', '8,500', '6,200', '2,300', '27.1'],
        ['2025-08-12', 'Delhi-Gurgaon B', '1,890', '320', '6,800', '4,950', '1,850', '27.2'],
        ['2025-08-11', 'Bangalore-Mysore C', '1,650', '280', '5,900', '4,100', '1,800', '30.5'],
        ['2025-08-11', 'Chennai-Salem D', '2,100', '380', '7,200', '5,400', '1,800', '25.0'],
        ['2025-08-10', 'Hyderabad Local E', '950', '150', '3,500', '2,450', '1,050', '30.0'],
        ['2025-08-10', 'Kolkata-Durgapur F', '1,750', '300', '6,200', '4,450', '1,750', '28.2']
    ];
    
    tableBody.innerHTML = costData.map(row => `
        <tr>
            <td>${row[0]}</td>
            <td><strong>${row[1]}</strong></td>
            <td>â‚¹${row[2]}</td>
            <td>â‚¹${row[3]}</td>
            <td class="text-danger">â‚¹${row[4]}</td>
            <td class="text-success">â‚¹${row[5]}</td>
            <td class="text-success fw-bold">â‚¹${row[6]}</td>
            <td><span class="badge bg-success">${row[7]}%</span></td>
        </tr>
    `).join('');
    
    updateDataTimestamp();
    new bootstrap.Modal(document.getElementById('drillDownModal')).show();
}

// Utility functions for drill-down
function updateDataTimestamp() {
    const timestampElement = document.getElementById('lastDataUpdate');
    if (timestampElement) {
        timestampElement.textContent = new Date().toLocaleString();
    }
}

function exportDrillDownData(format) {
    const table = document.getElementById('drillDownTable');
    const modalTitle = document.getElementById('drillDownModalLabel').textContent;
    
    // Create CSV content
    let csvContent = modalTitle + '\n\n';
    
    // Add headers
    const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
    csvContent += headers.join(',') + '\n';
    
    // Add data rows
    const rows = Array.from(table.querySelectorAll('tbody tr'));
    rows.forEach(row => {
        const cells = Array.from(row.querySelectorAll('td')).map(td => {
            // Clean cell content (remove HTML, extra spaces)
            return '"' + td.textContent.trim().replace(/"/g, '""') + '"';
        });
        csvContent += cells.join(',') + '\n';
    });
    
    // Create download
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${modalTitle.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.${format}`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    // Show success message
    const exportBtns = document.querySelectorAll('.export-btn-group .btn');
    exportBtns.forEach(btn => {
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i> Downloaded';
        btn.classList.add('btn-success');
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
        }, 2000);
    });
}

function refreshDrillDownData() {
    const refreshBtn = document.querySelector('button[onclick="refreshDrillDownData()"]');
    const originalText = refreshBtn.innerHTML;
    
    refreshBtn.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Refreshing...';
    refreshBtn.disabled = true;
    
    // Simulate refresh
    setTimeout(() => {
        updateDataTimestamp();
        refreshBtn.innerHTML = originalText;
        refreshBtn.disabled = false;
        
        // Show brief success indication
        refreshBtn.innerHTML = '<i class="bi bi-check me-1"></i> Refreshed';
        setTimeout(() => {
            refreshBtn.innerHTML = originalText;
        }, 1500);
    }, 2000);
}

// Enhanced search and filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('drillDownSearch');
    const filterSelect = document.getElementById('drillDownFilter');
    
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            filterDrillDownTable();
        });
    }
    
    if (filterSelect) {
        filterSelect.addEventListener('change', function() {
            filterDrillDownTable();
        });
    }
});

function filterDrillDownTable() {
    const searchTerm = document.getElementById('drillDownSearch')?.value.toLowerCase() || '';
    const filterValue = document.getElementById('drillDownFilter')?.value || '';
    const tableBody = document.getElementById('drillDownTableBody');
    
    if (!tableBody) return;
    
    const rows = Array.from(tableBody.querySelectorAll('tr'));
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const matchesSearch = searchTerm === '' || text.includes(searchTerm);
        
        let matchesFilter = true;
        if (filterValue) {
            // Simple filter logic - can be enhanced based on specific requirements
            const hasHighPerformance = text.includes('9') || text.includes('8');
            const hasMediumPerformance = text.includes('7') || text.includes('6');
            
            matchesFilter = (filterValue === 'high' && hasHighPerformance) ||
                          (filterValue === 'medium' && hasMediumPerformance) ||
                          (filterValue === 'low' && !hasHighPerformance && !hasMediumPerformance);
        }
        
        row.style.display = (matchesSearch && matchesFilter) ? '' : 'none';
    });
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (realTimeInterval) {
        clearInterval(realTimeInterval);
    }
});
</script>
{% endblock %}