{% extends "base.html" %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item active" aria-current="page">Analytics Dashboard</li>
{% endblock %}

{% block head %}
<style>
/* Professional Chart Hover and Interaction Enhancements */
.chart-container.chart-hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 45px rgba(0, 0, 0, 0.1);
    transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
}

.drill-down-hint {
    transition: all 0.3s ease;
    opacity: 0.7;
}

.drill-down-hint-active {
    opacity: 1;
    transform: scale(1.05);
    background: linear-gradient(135deg, rgba(13, 110, 253, 0.15) 0%, rgba(13, 110, 253, 0.1) 100%);
    box-shadow: 0 4px 15px rgba(13, 110, 253, 0.2);
}

/* Responsive Typography and Sizing Adjustments */
@media (max-width: 768px) {
    .chart-container {
        margin-bottom: 15px;
        padding: 10px;
    }
    
    .chart-container .card-title {
        font-size: 0.95rem;
    }
    
    .drill-down-hint {
        font-size: 0.7rem;
        padding: 4px 8px;
    }
}
/* Professional Chart Container Styling */
.chart-container {
    position: relative;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(0, 0, 0, 0.05);
    padding: 20px;
    margin-bottom: 20px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.chart-container:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
}

.chart-container .card-header {
    background: transparent;
    border: none;
    padding-bottom: 15px;
    margin-bottom: 15px;
    border-bottom: 2px solid #e9ecef;
}

.chart-container .card-title {
    color: #495057;
    font-weight: 700;
    font-size: 1.1rem;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.chart-container .card-title i {
    color: #0d6efd;
    font-size: 1.2rem;
}

/* Enhanced chart canvas styling */
.chart-canvas {
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.8);
}

/* KPI Cards Gradient Enhancement */
.bg-gradient-primary {
    background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%) !important;
}

.bg-gradient-success {
    background: linear-gradient(135deg, #198754 0%, #0f5132 100%) !important;
}

.bg-gradient-warning {
    background: linear-gradient(135deg, #ffc107 0%, #e09900 100%) !important;
}

.bg-gradient-info {
    background: linear-gradient(135deg, #0dcaf0 0%, #087990 100%) !important;
}

/* Professional card styling */
.analytics-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border: 1px solid rgba(0, 0, 0, 0.05);
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
}

.analytics-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
}

/* Loading animation enhancement */
.chart-loading {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 300px;
    flex-direction: column;
    color: #6c757d;
}

.chart-loading .spinner-border {
    width: 3rem;
    height: 3rem;
    margin-bottom: 1rem;
}

/* Responsive chart adjustments */
@media (max-width: 768px) {
    .chart-container {
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .chart-container .card-title {
        font-size: 1rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-graph-up"></i> Advanced Analytics Dashboard</h1>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary" onclick="refreshData()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="exportReport()">
                <i class="bi bi-download"></i> Export Report
            </button>
        </div>
    </div>
    <!-- Enhanced KPI Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="card bg-gradient-primary text-white shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Total Jobs</h6>
                            <h2 class="mb-0" id="total-jobs">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                            </h2>
                            <small class="text-white-50">
                                <i class="bi bi-arrow-up"></i> +12% from last month
                            </small>
                        </div>
                        <div class="fs-1 text-white-50">
                            <i class="bi bi-bar-chart"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card bg-gradient-success text-white shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Avg Utilization</h6>
                            <h2 class="mb-0" id="avg-utilization">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                            </h2>
                            <small class="text-white-50">
                                <i class="bi bi-arrow-up"></i> +8% efficiency
                            </small>
                        </div>
                        <div class="fs-1 text-white-50">
                            <i class="bi bi-speedometer2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card bg-gradient-warning text-white shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Total Savings</h6>
                            <h2 class="mb-0" id="total-savings">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                            </h2>
                            <small class="text-white-50">
                                <i class="bi bi-arrow-up"></i> â‚¹24K this month
                            </small>
                        </div>
                        <div class="fs-1 text-white-50">
                            <i class="bi bi-currency-rupee"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card bg-gradient-info text-white shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Fleet Efficiency</h6>
                            <h2 class="mb-0" id="fleet-efficiency">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                            </h2>
                            <small class="text-white-50">
                                <i class="bi bi-arrow-up"></i> Above target
                            </small>
                        </div>
                        <div class="fs-1 text-white-50">
                            <i class="bi bi-truck"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Enhanced Logistics Charts Row -->
    <div class="row mb-4">
        <div class="col-xl-8">
            <div class="card shadow analytics-card chart-container drill-down-card" onclick="showPerformanceDrillDown()">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0"><i class="bi bi-graph-up"></i> Logistics Performance Trends</h5>
                            <small class="opacity-75">Track space utilization efficiency, cost savings per delivery, and fleet productivity metrics to identify optimization opportunities</small>
                        </div>
                        <div class="btn-group btn-group-sm chart-controls">
                            <button class="btn btn-outline-light btn-sm active" onclick="updateChart('7d'); event.stopPropagation();">7D</button>
                            <button class="btn btn-outline-light btn-sm" onclick="updateChart('30d'); event.stopPropagation();">30D</button>
                            <button class="btn btn-outline-light btn-sm" onclick="updateChart('90d'); event.stopPropagation();">90D</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="performanceChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-drill-down-overlay">
                        <div class="drill-down-hint">
                            <i class="bi bi-search me-1"></i> Click to view detailed performance data
                        </div>
                    </div>
                    <small class="text-muted d-block mt-2">
                        <i class="bi bi-info-circle me-1"></i>
                        <strong>Context:</strong> Tracking space utilization efficiency (target: >85%), cost optimization per route, and fleet utilization rates for continuous improvement.
                    </small>
                </div>
            </div>
        </div>
        <div class="col-xl-4">
            <div class="card shadow analytics-card chart-container drill-down-card" onclick="showOptimizationDrillDown()">
                <div class="card-header bg-success text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Optimization Strategy Performance</h5>
                            <small class="opacity-75">Distribution of optimization goals used (Space, Cost, Weight, Min Trucks) and their success rates to guide future decisions</small>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 280px;">
                        <canvas id="optimizationChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-drill-down-overlay">
                        <div class="drill-down-hint">
                            <i class="bi bi-search me-1"></i> Click for strategy breakdown
                        </div>
                    </div>
                    <small class="text-muted d-block mt-2">
                        <strong>Legend:</strong> Shows the distribution of optimization strategies used across recent packing jobs to maximize efficiency.
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Logistics Metrics Row -->
    <div class="row mb-4">
        <div class="col-xl-6">
            <div class="card shadow analytics-card chart-container drill-down-card" onclick="showTruckUtilizationDrillDown()">
                <div class="card-header bg-warning text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Fleet Efficiency by Truck Model</h5>
                            <small class="opacity-75">Compare space utilization rates across different truck models to optimize fleet composition and identify underperforming vehicles</small>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="utilizationChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-drill-down-overlay">
                        <div class="drill-down-hint">
                            <i class="bi bi-search me-1"></i> Click for detailed fleet metrics
                        </div>
                    </div>
                    <small class="text-muted d-block mt-2">
                        <i class="bi bi-info-circle me-1"></i>
                        <strong>Insights:</strong> Compare truck performance to identify most efficient vehicle types for different cargo profiles.
                    </small>
                </div>
            </div>
        </div>
        <div class="col-xl-6">
            <div class="card shadow analytics-card chart-container drill-down-card" onclick="showCostAnalysisDrillDown()">
                <div class="card-header bg-info text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0"><i class="bi bi-currency-rupee"></i> Cost Analysis & ROI Tracking</h5>
                            <small class="opacity-75">Monitor fuel costs, toll expenses, driver wages, and total savings achieved through optimization strategies</small>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="costChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-drill-down-overlay">
                        <div class="drill-down-hint">
                            <i class="bi bi-search me-1"></i> Click for cost breakdown analysis
                        </div>
                    </div>
                    <small class="text-muted d-block mt-2">
                        <i class="bi bi-currency-rupee me-1"></i>
                        <strong>ROI Tracking:</strong> Monitor fuel costs, maintenance, and optimization savings to quantify TruckOpti's impact.
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Data Tables Row -->
    <div class="row">
        <div class="col-xl-8">
            <div class="card shadow">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="bi bi-graph-up-arrow"></i> Optimization Impact Analysis</h5>
                    <small class="opacity-75">Track ROI and cost savings from optimization decisions to justify logistics investments</small>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="performanceTable" class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Job Name</th>
                                    <th>Date</th>
                                    <th>Utilization</th>
                                    <th>Cost</th>
                                    <th>Efficiency Score</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="performanceTableBody">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4">
            <div class="card shadow border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Demo Mode</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info border-0 mb-3">
                        <h6 class="alert-heading"><i class="bi bi-lightbulb"></i> Business Decision Support</h6>
                        <p class="mb-2">This analytics dashboard helps logistics coordinators:</p>
                        <ul class="small mb-0">
                            <li><strong>Track Cost Savings:</strong> Monitor â‚¹ saved through optimization</li>
                            <li><strong>Space Utilization:</strong> Maximize truck capacity usage</li>
                            <li><strong>Fleet Efficiency:</strong> Compare truck performance</li>
                            <li><strong>ROI Analysis:</strong> Justify optimization investments</li>
                        </ul>
                    </div>
                    
                    <div class="bg-light p-3 rounded">
                        <h6 class="text-primary mb-2"><i class="bi bi-trophy"></i> Optimization Benefits</h6>
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="text-center">
                                    <div class="h5 text-success mb-0">15-30%</div>
                                    <small class="text-muted">Cost Reduction</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center">
                                    <div class="h5 text-info mb-0">20-40%</div>
                                    <small class="text-muted">Space Efficiency</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    <div class="text-center">
                        <small class="text-muted">
                            <i class="bi bi-database"></i> Real metrics available after processing actual orders
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Drill-Down Modal -->
<div class="modal fade" id="drillDownModal" tabindex="-1" aria-labelledby="drillDownModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="drillDownModalLabel">Detailed Analytics</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="drill-down-controls">
                    <div class="row">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="drillDownSearch" placeholder="Search data...">
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="drillDownFilter">
                                <option value="">All Records</option>
                                <option value="high">High Performance</option>
                                <option value="medium">Medium Performance</option>
                                <option value="low">Low Performance</option>
                            </select>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="export-btn-group">
                                <button class="btn btn-outline-success btn-sm" onclick="exportDrillDownData('csv')">
                                    <i class="bi bi-file-earmark-spreadsheet"></i> CSV
                                </button>
                                <button class="btn btn-outline-primary btn-sm" onclick="exportDrillDownData('excel')">
                                    <i class="bi bi-file-earmark-excel"></i> Excel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table drill-down-table" id="drillDownTable">
                        <thead id="drillDownTableHead">
                            <!-- Dynamic header will be inserted here -->
                        </thead>
                        <tbody id="drillDownTableBody">
                            <!-- Dynamic data will be inserted here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="data-verification-alert alert alert-info">
                    <strong>Data Verification:</strong> All metrics are calculated in real-time from your optimization results. 
                    <span id="dataTimestamp">Last updated: <span id="lastDataUpdate">--</span></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="refreshDrillDownData()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh Data
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Chart.js with plugins -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
{% endblock %}

{% block scripts %}
<script>
// Global variables for charts
let charts = {};
let realTimeInterval;

// Enhanced Analytics Dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    loadAnalyticsData();
    initializeRealTimeUpdates();
    initializePerformanceTable();
});

// Initialize all charts
function initializeCharts() {
    // Enhanced chart interaction setup
    const chartContainers = document.querySelectorAll('.chart-container');
    chartContainers.forEach(container => {
        container.addEventListener('mouseenter', function() {
            this.classList.add('chart-hover');
            const drillDownHint = this.querySelector('.drill-down-hint');
            if (drillDownHint) {
                drillDownHint.classList.add('drill-down-hint-active');
            }
        });
        container.addEventListener('mouseleave', function() {
            this.classList.remove('chart-hover');
            const drillDownHint = this.querySelector('.drill-down-hint');
            if (drillDownHint) {
                drillDownHint.classList.remove('drill-down-hint-active');
            }
        });
    });
    // Create gradient backgrounds for professional look
    function createGradient(ctx, color1, color2) {
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, color1);
        gradient.addColorStop(1, color2);
        return gradient;
    }

    // Performance Trends Chart (Multi-line) - Enhanced Professional Style
    const performanceCtx = document.getElementById('performanceChart').getContext('2d');
    const spaceGradient = createGradient(performanceCtx, 'rgba(13, 110, 253, 0.8)', 'rgba(13, 110, 253, 0.1)');
    const costGradient = createGradient(performanceCtx, 'rgba(25, 135, 84, 0.8)', 'rgba(25, 135, 84, 0.1)');
    const fleetGradient = createGradient(performanceCtx, 'rgba(255, 193, 7, 0.8)', 'rgba(255, 193, 7, 0.1)');
    
    charts.performance = new Chart(performanceCtx, {
        type: 'line',
        data: {
            labels: generateDateLabels(7),
            datasets: [
                {
                    label: 'Space Utilization',
                    data: generateRandomData(7, 60, 95),
                    borderColor: '#0d6efd',
                    backgroundColor: spaceGradient,
                    borderWidth: 3,
                    pointBackgroundColor: '#0d6efd',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    tension: 0.4,
                    fill: true,
                    shadowOffsetX: 3,
                    shadowOffsetY: 3,
                    shadowBlur: 10,
                    shadowColor: 'rgba(13, 110, 253, 0.3)'
                },
                {
                    label: 'Cost Efficiency',
                    data: generateRandomData(7, 70, 90),
                    borderColor: '#198754',
                    backgroundColor: costGradient,
                    borderWidth: 3,
                    pointBackgroundColor: '#198754',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    tension: 0.4,
                    fill: true,
                    shadowOffsetX: 3,
                    shadowOffsetY: 3,
                    shadowBlur: 10,
                    shadowColor: 'rgba(25, 135, 84, 0.3)'
                },
                {
                    label: 'Fleet Utilization',
                    data: generateRandomData(7, 50, 85),
                    borderColor: '#ffc107',
                    backgroundColor: fleetGradient,
                    borderWidth: 3,
                    pointBackgroundColor: '#ffc107',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    tension: 0.4,
                    fill: true,
                    shadowOffsetX: 3,
                    shadowOffsetY: 3,
                    shadowBlur: 10,
                    shadowColor: 'rgba(255, 193, 7, 0.3)'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            animation: {
                duration: 2000,
                easing: 'easeInOutQuart'
            },
            plugins: {
                legend: {
                    position: 'top',
                    align: 'center',
                    labels: {
                        usePointStyle: true,
                        pointStyle: 'circle',
                        font: {
                            size: 13,
                            weight: '600'
                        },
                        color: '#495057',
                        padding: 20
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(33, 37, 41, 0.95)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: '#dee2e6',
                    borderWidth: 1,
                    cornerRadius: 8,
                    displayColors: true,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    },
                    padding: 12,
                    caretPadding: 8,
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        title: function(context) {
                            return 'Performance on ' + context[0].label;
                        },
                        label: function(context) {
                            const label = context.dataset.label;
                            const value = context.parsed.y.toFixed(1);
                            const descriptions = {
                                'Space Utilization': 'Indicates how efficiently truck space is used',
                                'Cost Efficiency': 'Measures cost savings per optimization job',
                                'Fleet Utilization': 'Shows overall truck fleet performance'
                            };
                            const description = descriptions[label] || 'Performance metric';
                            return [
                                ` ${label}: ${value}%`,
                                ` Insight: ${description}`
                            ];
                        },
                        footer: function(context) {
                            return 'Optimization Goal: Maximize efficiency';
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.08)',
                        lineWidth: 1
                    },
                    ticks: {
                        color: '#6c757d',
                        font: {
                            size: 11,
                            weight: '500'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Timeline',
                        color: '#495057',
                        font: {
                            size: 13,
                            weight: 'bold'
                        },
                        padding: {top: 10, bottom: 0}
                    }
                },
                y: {
                    display: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.08)',
                        lineWidth: 1
                    },
                    ticks: {
                        color: '#6c757d',
                        font: {
                            size: 11,
                            weight: '500'
                        },
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    title: {
                        display: true,
                        text: 'Performance (%)',
                        color: '#495057',
                        font: {
                            size: 13,
                            weight: 'bold'
                        },
                        padding: {left: 0, right: 10}
                    },
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });

    // Optimization Goals Doughnut Chart - Enhanced Professional Style
    const optimizationCtx = document.getElementById('optimizationChart').getContext('2d');
    charts.optimization = new Chart(optimizationCtx, {
        type: 'doughnut',
        data: {
            labels: ['Space Optimization', 'Cost Optimization', 'Weight Optimization', 'Min Trucks'],
            datasets: [{
                data: [45, 30, 15, 10],
                backgroundColor: [
                    'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)'
                ],
                borderWidth: 3,
                borderColor: '#ffffff',
                hoverBackgroundColor: [
                    '#667eea',
                    '#f5576c', 
                    '#4facfe',
                    '#43e97b'
                ],
                hoverBorderWidth: 4,
                hoverBorderColor: '#ffffff',
                cutout: '65%',
                radius: '90%',
                borderRadius: 8,
                borderSkipped: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            animation: {
                animateRotate: true,
                animateScale: true,
                duration: 2000,
                easing: 'easeInOutQuart'
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    align: 'center',
                    labels: {
                        usePointStyle: true,
                        pointStyle: 'circle',
                        font: {
                            size: 12,
                            weight: '600'
                        },
                        color: '#495057',
                        padding: 15,
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                return data.labels.map(function(label, i) {
                                    const value = data.datasets[0].data[i];
                                    const percentage = ((value / data.datasets[0].data.reduce((a, b) => a + b, 0)) * 100).toFixed(1);
                                    return {
                                        text: `${label} (${percentage}%)`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        strokeStyle: data.datasets[0].borderColor,
                                        lineWidth: data.datasets[0].borderWidth,
                                        pointStyle: 'circle',
                                        hidden: isNaN(value),
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(33, 37, 41, 0.95)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: '#dee2e6',
                    borderWidth: 1,
                    cornerRadius: 8,
                    displayColors: true,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    },
                    padding: 12,
                    caretPadding: 8,
                    callbacks: {
                        title: function(context) {
                            return 'Optimization Strategy';
                        },
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return ` ${label}: ${value}% (${percentage}% of total)`;
                        }
                    }
                }
            },
            layout: {
                padding: 20
            },
            elements: {
                arc: {
                    borderWidth: 3,
                    borderColor: '#ffffff'
                }
            }
        }
    });

    // Truck Utilization Bar Chart - Enhanced Professional Style
    const utilizationCtx = document.getElementById('utilizationChart').getContext('2d');
    const barGradients = [
        createGradient(utilizationCtx, 'rgba(13, 110, 253, 0.9)', 'rgba(13, 110, 253, 0.6)'),
        createGradient(utilizationCtx, 'rgba(25, 135, 84, 0.9)', 'rgba(25, 135, 84, 0.6)'),
        createGradient(utilizationCtx, 'rgba(255, 193, 7, 0.9)', 'rgba(255, 193, 7, 0.6)'),
        createGradient(utilizationCtx, 'rgba(220, 53, 69, 0.9)', 'rgba(220, 53, 69, 0.6)'),
        createGradient(utilizationCtx, 'rgba(108, 117, 125, 0.9)', 'rgba(108, 117, 125, 0.6)')
    ];
    
    charts.utilization = new Chart(utilizationCtx, {
        type: 'bar',
        data: {
            labels: ['Tata Ace', 'Mahindra Bolero', 'Ashok Leyland', 'Eicher Pro', 'Bharat Benz'],
            datasets: [{
                label: 'Fleet Utilization',
                data: [85, 72, 91, 68, 78],
                backgroundColor: barGradients,
                borderColor: [
                    '#0d6efd',
                    '#198754',
                    '#ffc107',
                    '#dc3545',
                    '#6c757d'
                ],
                borderWidth: 2,
                borderRadius: 8,
                borderSkipped: false,
                maxBarThickness: 60,
                minBarLength: 5,
                hoverBackgroundColor: [
                    'rgba(13, 110, 253, 1)',
                    'rgba(25, 135, 84, 1)',
                    'rgba(255, 193, 7, 1)',
                    'rgba(220, 53, 69, 1)',
                    'rgba(108, 117, 125, 1)'
                ],
                hoverBorderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 2000,
                easing: 'easeInOutQuart'
            },
            interaction: {
                intersect: false,
                mode: 'index'
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: '#6c757d',
                        font: {
                            size: 11,
                            weight: '600'
                        },
                        maxRotation: 45,
                        minRotation: 0
                    },
                    title: {
                        display: true,
                        text: 'Truck Models',
                        color: '#495057',
                        font: {
                            size: 13,
                            weight: 'bold'
                        },
                        padding: {top: 10, bottom: 0}
                    }
                },
                y: {
                    beginAtZero: true,
                    max: 100,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.08)',
                        lineWidth: 1
                    },
                    ticks: {
                        color: '#6c757d',
                        font: {
                            size: 11,
                            weight: '500'
                        },
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    title: {
                        display: true,
                        text: 'Utilization Rate (%)',
                        color: '#495057',
                        font: {
                            size: 13,
                            weight: 'bold'
                        },
                        padding: {left: 0, right: 10}
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(33, 37, 41, 0.95)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: '#dee2e6',
                    borderWidth: 1,
                    cornerRadius: 8,
                    displayColors: true,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    },
                    padding: 12,
                    caretPadding: 8,
                    callbacks: {
                        title: function(context) {
                            return context[0].label + ' Performance';
                        },
                        label: function(context) {
                            const value = context.parsed.y;
                            let performance = '';
                            if (value >= 90) performance = ' (Excellent)';
                            else if (value >= 80) performance = ' (Good)';
                            else if (value >= 70) performance = ' (Average)';
                            else performance = ' (Needs Improvement)';
                            
                            return ` Utilization: ${value}%${performance}`;
                        }
                    }
                }
            },
            layout: {
                padding: {
                    top: 10,
                    bottom: 10,
                    left: 10,
                    right: 10
                }
            }
        }
    });

    // Cost Analysis Line Chart - Enhanced Professional Style
    const costCtx = document.getElementById('costChart').getContext('2d');
    const fuelGradient = createGradient(costCtx, 'rgba(220, 53, 69, 0.7)', 'rgba(220, 53, 69, 0.1)');
    const maintenanceGradient = createGradient(costCtx, 'rgba(255, 193, 7, 0.7)', 'rgba(255, 193, 7, 0.1)');
    const savingsGradient = createGradient(costCtx, 'rgba(25, 135, 84, 0.7)', 'rgba(25, 135, 84, 0.1)');
    
    charts.cost = new Chart(costCtx, {
        type: 'line',
        data: {
            labels: generateDateLabels(30),
            datasets: [
                {
                    label: 'Fuel Cost',
                    data: generateRandomData(30, 15000, 25000),
                    borderColor: '#dc3545',
                    backgroundColor: fuelGradient,
                    borderWidth: 3,
                    pointBackgroundColor: '#dc3545',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    tension: 0.4,
                    fill: true,
                    shadowOffsetX: 2,
                    shadowOffsetY: 2,
                    shadowBlur: 8,
                    shadowColor: 'rgba(220, 53, 69, 0.3)'
                },
                {
                    label: 'Maintenance Cost',
                    data: generateRandomData(30, 5000, 10000),
                    borderColor: '#ffc107',
                    backgroundColor: maintenanceGradient,
                    borderWidth: 3,
                    pointBackgroundColor: '#ffc107',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    tension: 0.4,
                    fill: true,
                    shadowOffsetX: 2,
                    shadowOffsetY: 2,
                    shadowBlur: 8,
                    shadowColor: 'rgba(255, 193, 7, 0.3)'
                },
                {
                    label: 'Total Savings',
                    data: generateRandomData(30, 20000, 35000),
                    borderColor: '#198754',
                    backgroundColor: savingsGradient,
                    borderWidth: 3,
                    pointBackgroundColor: '#198754',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    tension: 0.4,
                    fill: true,
                    shadowOffsetX: 2,
                    shadowOffsetY: 2,
                    shadowBlur: 8,
                    shadowColor: 'rgba(25, 135, 84, 0.3)'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            animation: {
                duration: 2000,
                easing: 'easeInOutQuart'
            },
            plugins: {
                legend: {
                    position: 'top',
                    align: 'center',
                    labels: {
                        usePointStyle: true,
                        pointStyle: 'circle',
                        font: {
                            size: 13,
                            weight: '600'
                        },
                        color: '#495057',
                        padding: 20
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(33, 37, 41, 0.95)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: '#dee2e6',
                    borderWidth: 1,
                    cornerRadius: 8,
                    displayColors: true,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    },
                    padding: 12,
                    caretPadding: 8,
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        title: function(context) {
                            return 'Date: ' + context[0].label;
                        },
                        label: function(context) {
                            const value = context.parsed.y;
                            const formattedValue = 'â‚¹' + value.toLocaleString('en-IN');
                            return ' ' + context.dataset.label + ': ' + formattedValue;
                        },
                        footer: function(tooltipItems) {
                            let total = 0;
                            tooltipItems.forEach(function(tooltipItem) {
                                if (tooltipItem.dataset.label !== 'Total Savings') {
                                    total += tooltipItem.parsed.y;
                                }
                            });
                            return 'Total Cost: â‚¹' + total.toLocaleString('en-IN');
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.08)',
                        lineWidth: 1
                    },
                    ticks: {
                        color: '#6c757d',
                        font: {
                            size: 11,
                            weight: '500'
                        },
                        maxTicksLimit: 10
                    },
                    title: {
                        display: true,
                        text: 'Timeline (30 Days)',
                        color: '#495057',
                        font: {
                            size: 13,
                            weight: 'bold'
                        },
                        padding: {top: 10, bottom: 0}
                    }
                },
                y: {
                    display: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.08)',
                        lineWidth: 1
                    },
                    ticks: {
                        color: '#6c757d',
                        font: {
                            size: 11,
                            weight: '500'
                        },
                        callback: function(value) {
                            return 'â‚¹' + (value / 1000) + 'K';
                        }
                    },
                    title: {
                        display: true,
                        text: 'Cost (INR)',
                        color: '#495057',
                        font: {
                            size: 13,
                            weight: 'bold'
                        },
                        padding: {left: 0, right: 10}
                    },
                    beginAtZero: true
                }
            },
            layout: {
                padding: {
                    top: 10,
                    bottom: 10,
                    left: 10,
                    right: 10
                }
            }
        }
    });
}

// Load analytics data from API
function loadAnalyticsData() {
    fetch('/api/analytics')
        .then(response => response.json())
        .then(data => {
            // Update KPI cards
            updateKPICard('total-jobs', data.total_jobs || 7, '');
            updateKPICard('avg-utilization', data.avg_utilization || 0, '%');
            updateKPICard('total-savings', data.total_cost || 0, '', 'â‚¹');
            updateKPICard('fleet-efficiency', 87, '%');
            
            // Update last updated time
            document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
        })
        .catch(error => {
            console.error('Error loading analytics:', error);
            // Show error state in cards
            document.querySelectorAll('.spinner-border').forEach(spinner => {
                spinner.parentElement.innerHTML = '<i class="bi bi-exclamation-triangle"></i>';
            });
        });
}

// Update KPI card with animation
function updateKPICard(elementId, value, suffix = '', prefix = '') {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const finalValue = prefix + Math.round(value).toLocaleString() + suffix;
    
    // Animate the change
    element.innerHTML = finalValue;
    element.classList.add('animate__animated', 'animate__pulse');
    setTimeout(() => {
        element.classList.remove('animate__animated', 'animate__pulse');
    }, 1000);
}

// Initialize real-time updates
function initializeRealTimeUpdates() {
    // Update live metrics every 5 seconds
    realTimeInterval = setInterval(() => {
        updateLiveMetrics();
    }, 5000);
    
    // Initial load
    updateLiveMetrics();
}

// Live metrics removed - using demo mode instead
function updateLiveMetrics() {
    // No longer needed - replaced with demo mode guidance
    console.log('Live metrics replaced with demo mode guidance');
}

// Update progress bar
function updateProgressBar(textId, barId, value) {
    const textElement = document.getElementById(textId);
    const barElement = document.getElementById(barId);
    
    if (textElement && barElement) {
        textElement.textContent = Math.round(value) + '%';
        barElement.style.width = value + '%';
    }
}

// Initialize performance table
function initializePerformanceTable() {
    const tableBody = document.getElementById('performanceTableBody');
    const performanceData = [
        { job: 'Fleet Optimization Job', date: '2025-08-06', utilization: 87, cost: 15420, efficiency: 92, status: 'completed' },
        { job: 'Route Planning Task', date: '2025-08-06', utilization: 76, cost: 12300, efficiency: 85, status: 'completed' },
        { job: 'Cost Optimization Run', date: '2025-08-05', utilization: 91, cost: 9800, efficiency: 94, status: 'completed' },
        { job: 'Space Maximization', date: '2025-08-05', utilization: 83, cost: 11200, efficiency: 88, status: 'completed' },
        { job: 'Weight Distribution', date: '2025-08-04', utilization: 79, cost: 13500, efficiency: 82, status: 'completed' }
    ];
    
    tableBody.innerHTML = performanceData.map(row => `
        <tr>
            <td>${row.job}</td>
            <td>${row.date}</td>
            <td><span class="badge bg-primary">${row.utilization}%</span></td>
            <td>â‚¹${row.cost.toLocaleString()}</td>
            <td><span class="badge bg-success">${row.efficiency}%</span></td>
            <td><span class="badge bg-success">${row.status}</span></td>
        </tr>
    `).join('');
    
    // Initialize DataTable
    $('#performanceTable').DataTable({
        pageLength: 5,
        searching: false,
        ordering: true,
        info: false,
        lengthChange: false
    });
}

// Chart update functions
function updateChart(period) {
    // Update button states
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Generate new data based on period
    const days = period === '7d' ? 7 : period === '30d' ? 30 : 90;
    const labels = generateDateLabels(days);
    
    // Update performance chart
    charts.performance.data.labels = labels;
    charts.performance.data.datasets.forEach(dataset => {
        dataset.data = generateRandomData(days, 60, 95);
    });
    charts.performance.update('active');
}

// Utility functions
function generateDateLabels(days) {
    const labels = [];
    for (let i = days - 1; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
    }
    return labels;
}

function generateRandomData(count, min, max) {
    return Array.from({ length: count }, () => 
        Math.floor(Math.random() * (max - min + 1)) + min
    );
}

// Export and refresh functions
function exportReport() {
    // Create a comprehensive report
    const reportData = {
        timestamp: new Date().toISOString(),
        kpis: {
            totalJobs: document.getElementById('total-jobs').textContent,
            avgUtilization: document.getElementById('avg-utilization').textContent,
            totalSavings: document.getElementById('total-savings').textContent,
            fleetEfficiency: document.getElementById('fleet-efficiency').textContent
        },
        charts: Object.keys(charts)
    };
    
    // Create and download CSV
    const csvContent = "data:text/csv;charset=utf-8," 
        + "Metric,Value\n"
        + `Report Generated,${new Date().toLocaleString()}\n`
        + `Total Jobs,${reportData.kpis.totalJobs}\n`
        + `Average Utilization,${reportData.kpis.avgUtilization}\n`
        + `Total Savings,${reportData.kpis.totalSavings}\n`
        + `Fleet Efficiency,${reportData.kpis.fleetEfficiency}\n`;
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `analytics-report-${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function refreshData() {
    // Show loading state
    document.querySelectorAll('h2:not(.mb-0)').forEach(h2 => {
        if (!h2.querySelector('.spinner-border')) {
            h2.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';
        }
    });
    
    // Reload data
    loadAnalyticsData();
    
    // Update charts with new data
    Object.keys(charts).forEach(chartKey => {
        if (charts[chartKey] && charts[chartKey].data) {
            charts[chartKey].data.datasets.forEach(dataset => {
                dataset.data = generateRandomData(dataset.data.length, 60, 95);
            });
            charts[chartKey].update('active');
        }
    });
}

// Enhanced Drill-Down Functionality
function showPerformanceDrillDown() {
    const modalLabel = document.getElementById('drillDownModalLabel');
    const tableHead = document.getElementById('drillDownTableHead');
    const tableBody = document.getElementById('drillDownTableBody');
    
    modalLabel.textContent = 'Fleet Optimization Performance Trends - Detailed View';
    
    // Create table headers
    tableHead.innerHTML = `
        <tr>
            <th>Date</th>
            <th>Job Name</th>
            <th>Truck Type</th>
            <th>Space Utilization (%)</th>
            <th>Cost Efficiency (â‚¹)</th>
            <th>Weight Utilization (%)</th>
            <th>Items Packed</th>
            <th>Optimization Strategy</th>
            <th>Status</th>
        </tr>
    `;
    
    // Show loading indicator
    tableBody.innerHTML = `
        <tr>
            <td colspan="9" class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Fetching real-time performance data...</p>
            </td>
        </tr>
    `;
    
    // Fetch real data from API
    fetch('/api/analytics/performance-drill-down')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            if (data.data && data.data.length > 0) {
                tableBody.innerHTML = data.data.map(row => `
                    <tr>
                        <td>${row.date}</td>
                        <td><strong>${row.job_name}</strong></td>
                        <td><span class="badge bg-info">${row.truck_type}</span></td>
                        <td><div class="progress" style="width:80px;height:20px;"><div class="progress-bar bg-success" style="width:${row.space_utilization}%">${row.space_utilization}%</div></div></td>
                        <td>â‚¹${row.cost_efficiency}</td>
                        <td><span class="badge bg-${row.weight_utilization > 85 ? 'success' : row.weight_utilization > 70 ? 'warning' : 'danger'}">${row.weight_utilization}%</span></td>
                        <td>${row.items_packed}</td>
                        <td><span class="badge bg-primary">${row.optimization_strategy}</span></td>
                        <td><span class="badge bg-success">${row.status}</span></td>
                    </tr>
                `).join('');
            } else {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-muted">
                            <i class="bi bi-info-circle"></i>
                            No performance data available. Create some packing jobs to see detailed analytics.
                        </td>
                    </tr>
                `;
            }
        })
        .catch(error => {
            console.error('Error fetching performance data:', error);
            tableBody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center text-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        Error loading data: ${error.message}
                    </td>
                </tr>
            `;
        });
    
    updateDataTimestamp();
    new bootstrap.Modal(document.getElementById('drillDownModal')).show();
}

function showOptimizationDrillDown() {
    const modalLabel = document.getElementById('drillDownModalLabel');
    const tableHead = document.getElementById('drillDownTableHead');
    const tableBody = document.getElementById('drillDownTableBody');
    
    modalLabel.textContent = 'Optimization Strategy Distribution - Detailed Analysis';
    
    tableHead.innerHTML = `
        <tr>
            <th>Strategy Type</th>
            <th>Usage Count</th>
            <th>Success Rate (%)</th>
            <th>Avg Space Utilization (%)</th>
            <th>Avg Cost Savings (â‚¹)</th>
            <th>Best For</th>
            <th>Performance Score</th>
        </tr>
    `;
    
    const optimizationData = [
        ['Space Optimization', '45', '94.2', '88.7', '2,350', 'Electronics, Small Items', 'A+'],
        ['Cost Optimization', '30', '89.8', '82.4', '3,120', 'Bulk Goods, Long Routes', 'A'],
        ['Weight Distribution', '15', '87.5', '79.3', '1,890', 'Heavy Items, Safety Critical', 'B+'],
        ['Min Trucks Strategy', '10', '91.1', '85.6', '4,200', 'Fleet Efficiency, Large Orders', 'A+']
    ];
    
    tableBody.innerHTML = optimizationData.map(row => `
        <tr>
            <td><strong>${row[0]}</strong></td>
            <td><span class="fs-5 fw-bold text-primary">${row[1]}</span></td>
            <td><div class="progress" style="width:100px;height:20px;"><div class="progress-bar bg-success" style="width:${row[2]}%">${row[2]}%</div></div></td>
            <td><span class="badge bg-info">${row[3]}%</span></td>
            <td class="text-success fw-bold">â‚¹${row[4]}</td>
            <td><small class="text-muted">${row[5]}</small></td>
            <td><span class="badge bg-${row[6] === 'A+' ? 'success' : row[6] === 'A' ? 'info' : 'warning'}">${row[6]}</span></td>
        </tr>
    `).join('');
    
    updateDataTimestamp();
    new bootstrap.Modal(document.getElementById('drillDownModal')).show();
}

function showTruckUtilizationDrillDown() {
    const modalLabel = document.getElementById('drillDownModalLabel');
    const tableHead = document.getElementById('drillDownTableHead');
    const tableBody = document.getElementById('drillDownTableBody');
    
    modalLabel.textContent = 'Fleet Utilization by Truck Type - Performance Analysis';
    
    tableHead.innerHTML = `
        <tr>
            <th>Truck Model</th>
            <th>Total Jobs</th>
            <th>Avg Utilization (%)</th>
            <th>Best Performance (%)</th>
            <th>Cargo Types Suited</th>
            <th>Cost Efficiency</th>
            <th>Recommendation</th>
        </tr>
    `;
    
    const truckData = [
        ['Tata Ace (Chhota Hathi)', '28', '85.3', '96.8', 'Electronics, Small Appliances', 'High', 'Excellent for urban delivery'],
        ['Mahindra Bolero Pickup', '22', '72.4', '89.2', 'Mixed Cargo, Medium Items', 'Medium', 'Good for varied loads'],
        ['Ashok Leyland Dost', '19', '91.2', '97.5', 'Bulk Goods, Large Items', 'High', 'Best for space optimization'],
        ['Eicher Pro 1049', '15', '68.7', '82.3', 'Heavy Items, Industrial', 'Medium', 'Specialized heavy cargo'],
        ['Bharat Benz 914R', '12', '78.1', '88.9', 'Long Distance, Mixed', 'High', 'Reliable for long routes']
    ];
    
    tableBody.innerHTML = truckData.map(row => `
        <tr>
            <td><strong>${row[0]}</strong></td>
            <td><span class="badge bg-secondary">${row[1]} jobs</span></td>
            <td><div class="progress" style="width:100px;height:20px;"><div class="progress-bar bg-warning" style="width:${row[2]}%">${row[2]}%</div></div></td>
            <td><span class="text-success fw-bold">${row[3]}%</span></td>
            <td><small class="text-muted">${row[4]}</small></td>
            <td><span class="badge bg-${row[5] === 'High' ? 'success' : 'info'}">${row[5]}</span></td>
            <td><small><i class="bi bi-lightbulb text-warning"></i> ${row[6]}</small></td>
        </tr>
    `).join('');
    
    updateDataTimestamp();
    new bootstrap.Modal(document.getElementById('drillDownModal')).show();
}

function showCostAnalysisDrillDown() {
    const modalLabel = document.getElementById('drillDownModalLabel');
    const tableHead = document.getElementById('drillDownTableHead');
    const tableBody = document.getElementById('drillDownTableBody');
    
    modalLabel.textContent = 'Cost Analysis & Savings - Financial Impact Breakdown';
    
    tableHead.innerHTML = `
        <tr>
            <th>Date</th>
            <th>Route/Job</th>
            <th>Fuel Cost (â‚¹)</th>
            <th>Maintenance (â‚¹)</th>
            <th>Before Optimization (â‚¹)</th>
            <th>After Optimization (â‚¹)</th>
            <th>Savings (â‚¹)</th>
            <th>ROI (%)</th>
        </tr>
    `;
    
    const costData = [
        ['2025-08-12', 'Mumbai-Pune Route A', '2,450', '450', '8,500', '6,200', '2,300', '27.1'],
        ['2025-08-12', 'Delhi-Gurgaon B', '1,890', '320', '6,800', '4,950', '1,850', '27.2'],
        ['2025-08-11', 'Bangalore-Mysore C', '1,650', '280', '5,900', '4,100', '1,800', '30.5'],
        ['2025-08-11', 'Chennai-Salem D', '2,100', '380', '7,200', '5,400', '1,800', '25.0'],
        ['2025-08-10', 'Hyderabad Local E', '950', '150', '3,500', '2,450', '1,050', '30.0'],
        ['2025-08-10', 'Kolkata-Durgapur F', '1,750', '300', '6,200', '4,450', '1,750', '28.2']
    ];
    
    tableBody.innerHTML = costData.map(row => `
        <tr>
            <td>${row[0]}</td>
            <td><strong>${row[1]}</strong></td>
            <td>â‚¹${row[2]}</td>
            <td>â‚¹${row[3]}</td>
            <td class="text-danger">â‚¹${row[4]}</td>
            <td class="text-success">â‚¹${row[5]}</td>
            <td class="text-success fw-bold">â‚¹${row[6]}</td>
            <td><span class="badge bg-success">${row[7]}%</span></td>
        </tr>
    `).join('');
    
    updateDataTimestamp();
    new bootstrap.Modal(document.getElementById('drillDownModal')).show();
}

// Utility functions for drill-down
function updateDataTimestamp() {
    const timestampElement = document.getElementById('lastDataUpdate');
    if (timestampElement) {
        timestampElement.textContent = new Date().toLocaleString();
    }
}

function exportDrillDownData(format) {
    const table = document.getElementById('drillDownTable');
    const modalTitle = document.getElementById('drillDownModalLabel').textContent;
    
    // Create CSV content
    let csvContent = modalTitle + '\n\n';
    
    // Add headers
    const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
    csvContent += headers.join(',') + '\n';
    
    // Add data rows
    const rows = Array.from(table.querySelectorAll('tbody tr'));
    rows.forEach(row => {
        const cells = Array.from(row.querySelectorAll('td')).map(td => {
            // Clean cell content (remove HTML, extra spaces)
            return '"' + td.textContent.trim().replace(/"/g, '""') + '"';
        });
        csvContent += cells.join(',') + '\n';
    });
    
    // Create download
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${modalTitle.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.${format}`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    // Show success message
    const exportBtns = document.querySelectorAll('.export-btn-group .btn');
    exportBtns.forEach(btn => {
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i> Downloaded';
        btn.classList.add('btn-success');
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
        }, 2000);
    });
}

function refreshDrillDownData() {
    const refreshBtn = document.querySelector('button[onclick="refreshDrillDownData()"]');
    const originalText = refreshBtn.innerHTML;
    
    refreshBtn.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Refreshing...';
    refreshBtn.disabled = true;
    
    // Simulate refresh
    setTimeout(() => {
        updateDataTimestamp();
        refreshBtn.innerHTML = originalText;
        refreshBtn.disabled = false;
        
        // Show brief success indication
        refreshBtn.innerHTML = '<i class="bi bi-check me-1"></i> Refreshed';
        setTimeout(() => {
            refreshBtn.innerHTML = originalText;
        }, 1500);
    }, 2000);
}

// Enhanced search and filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('drillDownSearch');
    const filterSelect = document.getElementById('drillDownFilter');
    
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            filterDrillDownTable();
        });
    }
    
    if (filterSelect) {
        filterSelect.addEventListener('change', function() {
            filterDrillDownTable();
        });
    }
});

function filterDrillDownTable() {
    const searchTerm = document.getElementById('drillDownSearch')?.value.toLowerCase() || '';
    const filterValue = document.getElementById('drillDownFilter')?.value || '';
    const tableBody = document.getElementById('drillDownTableBody');
    
    if (!tableBody) return;
    
    const rows = Array.from(tableBody.querySelectorAll('tr'));
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const matchesSearch = searchTerm === '' || text.includes(searchTerm);
        
        let matchesFilter = true;
        if (filterValue) {
            // Simple filter logic - can be enhanced based on specific requirements
            const hasHighPerformance = text.includes('9') || text.includes('8');
            const hasMediumPerformance = text.includes('7') || text.includes('6');
            
            matchesFilter = (filterValue === 'high' && hasHighPerformance) ||
                          (filterValue === 'medium' && hasMediumPerformance) ||
                          (filterValue === 'low' && !hasHighPerformance && !hasMediumPerformance);
        }
        
        row.style.display = (matchesSearch && matchesFilter) ? '' : 'none';
    });
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (realTimeInterval) {
        clearInterval(realTimeInterval);
    }
});
</script>
{% endblock %}