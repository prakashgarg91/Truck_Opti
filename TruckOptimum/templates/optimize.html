{% extends "base.html" %}

{% block title %}TruckOptimum - Optimize Loading{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">Smart Truck Recommendation System</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-box-seam"></i> Your Carton Inventory</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Specify how many cartons you have of each type, and we'll recommend the optimal truck size.</p>
                        
                        <form id="recommendForm">
                            <div class="mb-3">
                                <label class="form-label"><strong>Available Cartons:</strong></label>
                                <div class="row">
                                    {% for carton in cartons %}
                                    <div class="col-12 mb-3">
                                        <div class="input-group">
                                            <span class="input-group-text bg-primary text-white">
                                                <i class="bi bi-box"></i>
                                            </span>
                                            <span class="input-group-text"><strong>{{ carton[1] }}</strong></span>
                                            <input type="number" class="form-control" id="quantity{{ carton[0] }}" min="0" max="1000" value="0" placeholder="Quantity">
                                            <span class="input-group-text">
                                                <small class="text-muted">{{ carton[2] }}×{{ carton[3] }}×{{ carton[4] }}m, {{ carton[5] }}kg</small>
                                            </span>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="bi bi-truck"></i> Recommend Truck Size
                                </button>
                                <small class="text-muted text-center">
                                    Get intelligent truck recommendations based on your carton inventory
                                </small>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-truck"></i> Recommended Truck Size</h5>
                    </div>
                    <div class="card-body">
                        <div id="results" class="text-muted text-center">
                            <div class="py-4">
                                <i class="bi bi-arrow-left text-primary" style="font-size: 2rem;"></i>
                                <p class="mt-3">Enter your carton quantities and click "Recommend Truck Size" to get intelligent recommendations.</p>
                            </div>
                        </div>
                        <div id="loading" class="d-none text-center">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Analyzing...</span>
                            </div>
                            <p class="mt-2">Analyzing your cartons with advanced 3D algorithms...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function getCartonRequirements() {
    const requirements = [];
    const cartonIds = [1, 2, 3]; // Small Box, Medium Box, Large Box
    
    for (const cartonId of cartonIds) {
        const quantity = parseInt(document.getElementById(`quantity${cartonId}`).value) || 0;
        if (quantity > 0) {
            requirements.push({
                carton_id: cartonId,
                quantity: quantity
            });
        }
    }
    
    return requirements;
}

document.getElementById('recommendForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const cartonRequirements = getCartonRequirements();
    
    if (cartonRequirements.length === 0) {
        alert('Please specify at least one carton quantity greater than 0');
        return;
    }
    
    const totalCartons = cartonRequirements.reduce((sum, req) => sum + req.quantity, 0);
    
    // Show loading
    document.getElementById('results').classList.add('d-none');
    document.getElementById('loading').classList.remove('d-none');
    document.getElementById('loading').innerHTML = `
        <div class="spinner-border text-success" role="status">
            <span class="visually-hidden">Analyzing...</span>
        </div>
        <p class="mt-2">Analyzing ${totalCartons} cartons with advanced 3D algorithms...</p>
    `;
    
    try {
        const response = await fetch('/api/recommend-trucks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                carton_requirements: cartonRequirements
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showTruckRecommendations(data);
        } else {
            showError(data.error || 'Recommendation failed');
        }
        
    } catch (error) {
        showError('Request failed: ' + error.message);
    }
    
    // Hide loading
    document.getElementById('loading').classList.add('d-none');
    document.getElementById('results').classList.remove('d-none');
});

function showTruckRecommendations(data) {
    const resultDiv = document.getElementById('results');
    
    let cartonInfo = `${data.carton_count} cartons`;
    if (data.carton_summary && data.carton_summary.requirements) {
        const reqDetails = data.carton_summary.requirements
            .map(req => `${req.quantity}×${getCartonName(req.carton_id)}`)
            .join(', ');
        cartonInfo = `${data.carton_count} cartons (${reqDetails})`;
    }
    
    let recommendationHtml = '';
    
    if (data.recommendations.length === 0) {
        recommendationHtml = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>No Suitable Trucks Found</strong><br>
                Your carton inventory exceeds the capacity of available trucks.
            </div>
        `;
    } else {
        const bestRecommendation = data.recommendations[0];
        const statusColor = bestRecommendation.fits_all ? 'success' : 'warning';
        const statusText = bestRecommendation.fits_all ? 'Perfect Match!' : 'Best Available';
        const statusIcon = bestRecommendation.fits_all ? 'check-circle-fill' : 'exclamation-triangle-fill';
        
        recommendationHtml = `
            <div class="alert alert-${statusColor} text-center mb-4">
                <i class="bi bi-${statusIcon}" style="font-size: 2rem;"></i>
                <h5 class="mt-2 mb-1">${statusText}</h5>
                <strong>Recommended: ${bestRecommendation.truck_name}</strong>
            </div>
            
            <div class="card border-${statusColor}">
                <div class="card-header bg-${statusColor} text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-truck"></i> ${bestRecommendation.truck_name}
                        <span class="badge bg-light text-dark float-end">Score: ${bestRecommendation.recommendation_score}/100</span>
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-3">
                        <div class="col-3">
                            <div class="h4 text-primary">${bestRecommendation.volume_utilization}%</div>
                            <small class="text-muted">Volume Used</small>
                        </div>
                        <div class="col-3">
                            <div class="h4 text-warning">${bestRecommendation.weight_utilization}%</div>
                            <small class="text-muted">Weight Used</small>
                        </div>
                        <div class="col-3">
                            <div class="h4 text-success">${bestRecommendation.stability_score}%</div>
                            <small class="text-muted">Stability</small>
                        </div>
                        <div class="col-3">
                            <div class="h4 text-info">${bestRecommendation.packed_cartons}/${bestRecommendation.packed_cartons + bestRecommendation.unpacked_cartons}</div>
                            <small class="text-muted">Cartons Fit</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small>Volume Utilization</small>
                            <small>${bestRecommendation.volume_utilization}%</small>
                        </div>
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar" style="width: ${bestRecommendation.volume_utilization}%"></div>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-1">
                            <small>Weight Utilization</small>
                            <small>${bestRecommendation.weight_utilization}%</small>
                        </div>
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar bg-warning" style="width: ${bestRecommendation.weight_utilization}%"></div>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-1">
                            <small>Load Stability</small>
                            <small>${bestRecommendation.stability_score}%</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" style="width: ${bestRecommendation.stability_score}%"></div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">
                                <strong>Assessment:</strong> ${bestRecommendation.recommendation}<br>
                                <strong>Algorithm:</strong> ${bestRecommendation.algorithm}<br>
                                <strong>Analysis Time:</strong> ${data.processing_time}
                            </small>
                        </div>
                        <div class="col-6 text-end">
                            <small class="text-muted">
                                <strong>Total Cartons:</strong> ${cartonInfo}<br>
                                <strong>Trucks Analyzed:</strong> ${data.total_trucks_analyzed}<br>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Show other alternatives if available
        if (data.recommendations.length > 1) {
            recommendationHtml += `
                <div class="mt-3">
                    <h6>Alternative Options:</h6>
            `;
            
            data.recommendations.slice(1, 3).forEach((rec, index) => {
                const altBadgeClass = rec.fits_all ? 'bg-success' : 'bg-warning';
                recommendationHtml += `
                    <div class="card card-body mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${rec.truck_name}</strong> 
                                <span class="badge ${altBadgeClass}">${rec.fits_all ? 'All Fit' : 'Partial'}</span>
                            </div>
                            <div class="text-end">
                                <small>Vol: ${rec.volume_utilization}% | Weight: ${rec.weight_utilization}% | Score: ${rec.recommendation_score}/100</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            recommendationHtml += `</div>`;
        }
    }
    
    resultDiv.innerHTML = recommendationHtml;
}

function getCartonName(cartonId) {
    const cartonNames = {1: 'Small Box', 2: 'Medium Box', 3: 'Large Box'};
    return cartonNames[cartonId] || `Carton ${cartonId}`;
}

function showError(message) {
    document.getElementById('results').innerHTML = `
        <div class="alert alert-danger">
            <strong>Error:</strong> ${message}
        </div>
    `;
}
</script>
{% endblock %}