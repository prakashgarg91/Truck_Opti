{% extends "base.html" %}

{% block title %}TruckOptimum - Optimize Loading{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">Smart Truck Recommendation System</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-box-seam"></i> Your Carton Inventory</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Specify how many cartons you have of each type, and we'll recommend the optimal truck size.</p>
                        
                        <form id="recommendForm">
                            <div class="mb-3">
                                <label class="form-label"><strong>Available Cartons:</strong></label>
                                <div class="row">
                                    {% for carton in cartons %}
                                    <div class="col-12 mb-3">
                                        <div class="input-group">
                                            <span class="input-group-text bg-primary text-white">
                                                <i class="bi bi-box"></i>
                                            </span>
                                            <span class="input-group-text"><strong>{{ carton[1] }}</strong></span>
                                            <input type="number" class="form-control" id="quantity{{ carton[0] }}" min="0" max="1000" value="0" placeholder="Quantity">
                                            <span class="input-group-text">
                                                <small class="text-muted">{{ carton[2] }}×{{ carton[3] }}×{{ carton[4] }}m, {{ carton[5] }}kg</small>
                                            </span>
                                        </div>
                                    </div>
                                    {% endfor %}
                                    
                                    <!-- Add New Carton Type Option -->
                                    <div class="col-12 mb-3">
                                        <div class="card border-info">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0 text-info">
                                                    <i class="bi bi-plus-circle"></i> Add New Carton Type
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <button type="button" class="btn btn-outline-info btn-sm w-100" data-bs-toggle="modal" data-bs-target="#addCartonModal">
                                                    <i class="bi bi-plus"></i> Create Custom Carton Type
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="bi bi-truck"></i> Recommend Truck Size
                                </button>
                                <small class="text-muted text-center">
                                    Get intelligent truck recommendations based on your carton inventory
                                </small>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-truck"></i> Recommended Truck Size</h5>
                    </div>
                    <div class="card-body">
                        <div id="results" class="text-muted text-center">
                            <div class="py-4">
                                <i class="bi bi-arrow-left text-primary" style="font-size: 2rem;"></i>
                                <p class="mt-3">Enter your carton quantities and click "Recommend Truck Size" to get intelligent recommendations.</p>
                            </div>
                        </div>
                        <div id="loading" class="d-none text-center">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Analyzing...</span>
                            </div>
                            <p class="mt-2">Analyzing your cartons with advanced 3D algorithms...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function getCartonRequirements() {
    const requirements = [];
    
    // Get all carton quantity inputs dynamically
    const cartonInputs = document.querySelectorAll('input[id^="quantity"]');
    
    for (const input of cartonInputs) {
        const cartonId = parseInt(input.id.replace('quantity', ''));
        const quantity = parseInt(input.value) || 0;
        
        if (quantity > 0) {
            requirements.push({
                carton_id: cartonId,
                quantity: quantity
            });
        }
    }
    
    return requirements;
}

document.getElementById('recommendForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const cartonRequirements = getCartonRequirements();
    
    if (cartonRequirements.length === 0) {
        alert('Please specify at least one carton quantity greater than 0');
        return;
    }
    
    const totalCartons = cartonRequirements.reduce((sum, req) => sum + req.quantity, 0);
    
    // Show loading
    document.getElementById('results').classList.add('d-none');
    document.getElementById('loading').classList.remove('d-none');
    document.getElementById('loading').innerHTML = `
        <div class="spinner-border text-success" role="status">
            <span class="visually-hidden">Analyzing...</span>
        </div>
        <p class="mt-2">Analyzing ${totalCartons} cartons with advanced 3D algorithms...</p>
    `;
    
    try {
        const response = await fetch('/api/recommend-trucks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                carton_requirements: cartonRequirements
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showTruckRecommendations(data);
        } else {
            showError(data.error || 'Recommendation failed');
        }
        
    } catch (error) {
        showError('Request failed: ' + error.message);
    }
    
    // Hide loading
    document.getElementById('loading').classList.add('d-none');
    document.getElementById('results').classList.remove('d-none');
});

function showTruckRecommendations(data) {
    const resultDiv = document.getElementById('results');
    
    let cartonInfo = `${data.carton_count} cartons`;
    if (data.carton_summary && data.carton_summary.requirements) {
        const reqDetails = data.carton_summary.requirements
            .map(req => `${req.quantity}×${getCartonName(req.carton_id)}`)
            .join(', ');
        cartonInfo = `${data.carton_count} cartons (${reqDetails})`;
    }
    
    let recommendationHtml = '';
    
    if (data.recommendations.length === 0) {
        recommendationHtml = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>No Suitable Trucks Found</strong><br>
                Your carton inventory exceeds the capacity of available trucks.
            </div>
        `;
    } else {
        const bestRecommendation = data.recommendations[0];
        const statusColor = bestRecommendation.fits_all ? 'success' : 'warning';
        const statusText = bestRecommendation.fits_all ? 'Perfect Match!' : 'Best Available';
        const statusIcon = bestRecommendation.fits_all ? 'check-circle-fill' : 'exclamation-triangle-fill';
        
        recommendationHtml = `
            <div class="alert alert-${statusColor} text-center mb-4">
                <i class="bi bi-${statusIcon}" style="font-size: 2rem;"></i>
                <h5 class="mt-2 mb-1">${statusText}</h5>
                <strong>Recommended: ${bestRecommendation.truck_name}</strong>
            </div>
            
            <div class="card border-${statusColor}">
                <div class="card-header bg-${statusColor} text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-truck"></i> ${bestRecommendation.truck_name}
                        <span class="badge bg-light text-dark float-end">Score: ${bestRecommendation.recommendation_score}/100</span>
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-3">
                        <div class="col-3">
                            <div class="h4 text-primary">${bestRecommendation.volume_utilization}%</div>
                            <small class="text-muted">Volume Used</small>
                        </div>
                        <div class="col-3">
                            <div class="h4 text-warning">${bestRecommendation.weight_utilization}%</div>
                            <small class="text-muted">Weight Used</small>
                        </div>
                        <div class="col-3">
                            <div class="h4 text-success">${bestRecommendation.stability_score}%</div>
                            <small class="text-muted">Stability</small>
                        </div>
                        <div class="col-3">
                            <div class="h4 text-info">${bestRecommendation.packed_cartons}/${bestRecommendation.packed_cartons + bestRecommendation.unpacked_cartons}</div>
                            <small class="text-muted">Cartons Fit</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small>Volume Utilization</small>
                            <small>${bestRecommendation.volume_utilization}%</small>
                        </div>
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar" style="width: ${bestRecommendation.volume_utilization}%"></div>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-1">
                            <small>Weight Utilization</small>
                            <small>${bestRecommendation.weight_utilization}%</small>
                        </div>
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar bg-warning" style="width: ${bestRecommendation.weight_utilization}%"></div>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-1">
                            <small>Load Stability</small>
                            <small>${bestRecommendation.stability_score}%</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" style="width: ${bestRecommendation.stability_score}%"></div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">
                                <strong>Assessment:</strong> ${bestRecommendation.recommendation}<br>
                                <strong>Algorithm:</strong> ${bestRecommendation.algorithm}<br>
                                <strong>Analysis Time:</strong> ${data.processing_time}
                            </small>
                        </div>
                        <div class="col-6 text-end">
                            <small class="text-muted">
                                <strong>Total Cartons:</strong> ${cartonInfo}<br>
                                <strong>Trucks Analyzed:</strong> ${data.total_trucks_analyzed}<br>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Show other alternatives if available
        if (data.recommendations.length > 1) {
            recommendationHtml += `
                <div class="mt-3">
                    <h6>Alternative Options:</h6>
            `;
            
            data.recommendations.slice(1, 3).forEach((rec, index) => {
                const altBadgeClass = rec.fits_all ? 'bg-success' : 'bg-warning';
                recommendationHtml += `
                    <div class="card card-body mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${rec.truck_name}</strong> 
                                <span class="badge ${altBadgeClass}">${rec.fits_all ? 'All Fit' : 'Partial'}</span>
                            </div>
                            <div class="text-end">
                                <small>Vol: ${rec.volume_utilization}% | Weight: ${rec.weight_utilization}% | Score: ${rec.recommendation_score}/100</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            recommendationHtml += `</div>`;
        }
    }
    
    resultDiv.innerHTML = recommendationHtml;
}

function getCartonName(cartonId) {
    const cartonNames = {1: 'Small Box', 2: 'Medium Box', 3: 'Large Box'};
    return cartonNames[cartonId] || `Carton ${cartonId}`;
}

function showError(message) {
    document.getElementById('results').innerHTML = `
        <div class="alert alert-danger">
            <strong>Error:</strong> ${message}
        </div>
    `;
}

// Add New Carton Type Modal functionality
document.getElementById('addCartonForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const cartonData = {
        name: formData.get('name'),
        length: parseFloat(formData.get('length')),
        width: parseFloat(formData.get('width')),
        height: parseFloat(formData.get('height')),
        weight: parseFloat(formData.get('weight')),
        quantity: parseInt(formData.get('quantity')) || 1
    };
    
    try {
        const response = await fetch('/api/cartons', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(cartonData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addCartonModal'));
            modal.hide();
            
            // Show success message
            showToast('Carton type created successfully!', 'success');
            
            // Refresh the page to show the new carton type
            setTimeout(() => {
                window.location.reload();
            }, 1000);
            
        } else {
            showToast('Failed to create carton type: ' + result.error, 'error');
        }
        
    } catch (error) {
        showToast('Request failed: ' + error.message, 'error');
    }
});

function showToast(message, type) {
    const toastHtml = `
        <div class="toast align-items-center text-bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i> ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', toastHtml);
    const toastElement = document.body.lastElementChild;
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    // Remove toast element after it's hidden
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}
</script>

<!-- Add Carton Type Modal -->
<div class="modal fade" id="addCartonModal" tabindex="-1" aria-labelledby="addCartonModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCartonModalLabel">
                    <i class="bi bi-plus-circle text-info"></i> Add New Carton Type
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addCartonForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="cartonName" class="form-label">Carton Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="cartonName" name="name" required placeholder="e.g., Heavy Package, Electronics Box">
                            <div class="form-text">Give your carton type a descriptive name</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="cartonLength" class="form-label">Length (m) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="cartonLength" name="length" step="0.1" min="0.1" max="10" required placeholder="1.5">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="cartonWidth" class="form-label">Width (m) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="cartonWidth" name="width" step="0.1" min="0.1" max="10" required placeholder="1.0">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="cartonHeight" class="form-label">Height (m) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="cartonHeight" name="height" step="0.1" min="0.1" max="10" required placeholder="0.8">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="cartonWeight" class="form-label">Weight (kg) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="cartonWeight" name="weight" step="0.1" min="0.1" max="1000" required placeholder="25.0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="cartonQuantity" class="form-label">Default Quantity</label>
                            <input type="number" class="form-control" id="cartonQuantity" name="quantity" min="1" max="1000" value="1" placeholder="1">
                            <div class="form-text">How many of these do you typically have?</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Volume Calculation:</strong> <span id="volumePreview">Enter dimensions to see volume</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-info">
                        <i class="bi bi-plus-circle"></i> Add Carton Type
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Real-time volume calculation
document.addEventListener('input', function(e) {
    if (['cartonLength', 'cartonWidth', 'cartonHeight'].includes(e.target.id)) {
        const length = parseFloat(document.getElementById('cartonLength').value) || 0;
        const width = parseFloat(document.getElementById('cartonWidth').value) || 0;
        const height = parseFloat(document.getElementById('cartonHeight').value) || 0;
        
        if (length > 0 && width > 0 && height > 0) {
            const volume = length * width * height;
            document.getElementById('volumePreview').textContent = `Volume: ${volume.toFixed(3)} m³`;
        } else {
            document.getElementById('volumePreview').textContent = 'Enter dimensions to see volume';
        }
    }
});
</script>
{% endblock %}