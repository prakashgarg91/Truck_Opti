{% extends "base.html" %}

{% block title %}TruckOptimum - Optimize Loading{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">Smart Truck Recommendation System</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-box-seam"></i> Your Carton Inventory</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Specify how many cartons you have of each type, and we'll recommend the optimal truck size.</p>
                        
                        <form id="recommendForm">
                            <!-- Carton Selection for Truck Recommendation -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <label class="form-label mb-0"><strong><i class="bi bi-box"></i> Selected Cartons for Recommendation:</strong></label>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addCartonToRecommendationModal">
                                            <i class="bi bi-plus-circle"></i> Add Carton
                                        </button>
                                        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#bulkUploadCartonModal">
                                            <i class="bi bi-upload"></i> Bulk Upload CSV
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="clearAllCartons()">
                                            <i class="bi bi-trash"></i> Clear All
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Selected Cartons Display -->
                                <div id="selectedCartonsContainer">
                                    <div id="emptyCartonMessage" class="alert alert-info text-center">
                                        <i class="bi bi-info-circle"></i>
                                        <h6>No cartons selected for recommendation</h6>
                                        <p class="mb-2">Add cartons to get intelligent truck recommendations.</p>
                                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addCartonToRecommendationModal">
                                            <i class="bi bi-plus"></i> Add Your First Carton
                                        </button>
                                    </div>
                                    
                                    <div id="selectedCartonsList"></div>
                                </div>
                                
                                <!-- Selected Cartons Summary -->
                                <div id="selectedCartonsSummary" class="mt-3 d-none">
                                    <div class="card border-success">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0 text-success">
                                                <i class="bi bi-check-circle"></i> Selected Cartons Summary
                                            </h6>
                                        </div>
                                        <div class="card-body py-2">
                                            <div id="selectedCartonsList"></div>
                                            <div class="row mt-2">
                                                <div class="col">
                                                    <small class="text-muted">Total Cartons</small>
                                                    <div><strong id="totalCartons">0</strong></div>
                                                </div>
                                                <div class="col">
                                                    <small class="text-muted">Total Volume</small>
                                                    <div><strong id="totalVolume">0.00m¬≥</strong></div>
                                                </div>
                                                <div class="col">
                                                    <small class="text-muted">Total Weight</small>
                                                    <div><strong id="totalWeight">0.00kg</strong></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Algorithm Selection Section -->
                            <div class="card border-info mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0 text-info">
                                        <i class="bi bi-cpu"></i> Advanced 3D Packing Algorithm
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="algorithmSelect" class="form-label">Choose Algorithm:</label>
                                            <select id="algorithmSelect" name="algorithm" class="form-select">
                                                <option value="auto">üöÄ Auto-Select Best Algorithm</option>
                                                <option value="skyline_bl">Skyline Bottom Left (Fast)</option>
                                                <option value="genetic">Genetic Algorithm (High Quality)</option>
                                                <option value="extreme_points">Extreme Points (Tight Packing)</option>
                                                <option value="simulated_annealing">Simulated Annealing (Optimized)</option>
                                                <option value="branch_bound">Branch & Bound (Optimal)</option>
                                                <option value="hybrid_genetic">Hybrid Genetic (Best Quality)</option>
                                                <option value="tabu_search">Tabu Search (Memory-Based)</option>
                                                <option value="ant_colony">Ant Colony (Swarm Intelligence)</option>
                                                <option value="particle_swarm">Particle Swarm (Population-Based)</option>
                                                <option value="deep_rl">Deep Reinforcement Learning (AI)</option>
                                            </select>
                                            <div class="form-text">Advanced algorithms provide better packing efficiency</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Algorithm Info:</label>
                                            <div id="algorithmInfo" class="alert alert-info">
                                                <small id="algorithmDescription">Auto-select will choose the best performing algorithm for your specific carton configuration.</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="compareAlgorithms" name="compare_algorithms">
                                        <label class="form-check-label" for="compareAlgorithms">
                                            <i class="bi bi-bar-chart"></i> Compare Multiple Algorithms
                                        </label>
                                        <div class="form-text">Get comparison results from multiple algorithms (takes longer but more insights)</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="bi bi-truck"></i> Recommend Truck Size
                                </button>
                                <small class="text-muted text-center">
                                    Get intelligent truck recommendations with advanced 3D packing algorithms
                                </small>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-truck"></i> Recommended Truck Size</h5>
                    </div>
                    <div class="card-body">
                        <div id="results" class="text-muted text-center">
                            <div class="py-4">
                                <i class="bi bi-arrow-left text-primary" style="font-size: 2rem;"></i>
                                <p class="mt-3">Enter your carton quantities and click "Recommend Truck Size" to get intelligent recommendations.</p>
                            </div>
                        </div>
                        <div id="loading" class="d-none text-center">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Analyzing...</span>
                            </div>
                            <p class="mt-2">Analyzing your cartons with advanced 3D algorithms...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Advanced Algorithm Information System
const algorithmInfo = {
    auto: {
        name: "Auto-Select Best Algorithm",
        description: "Intelligent algorithm selection based on your carton configuration. Automatically chooses the optimal packing algorithm for maximum efficiency.",
        efficiency: "95-98%",
        speed: "Fast",
        icon: "üöÄ"
    },
    skyline_bl: {
        name: "Skyline Bottom Left",
        description: "Fast, efficient algorithm that places cartons using the skyline principle. Excellent for quick results with good space utilization.",
        efficiency: "85-90%",
        speed: "Very Fast",
        icon: "‚ö°"
    },
    genetic: {
        name: "Genetic Algorithm",
        description: "Advanced evolutionary algorithm that evolves packing solutions over generations. Provides superior quality results for complex scenarios.",
        efficiency: "92-96%",
        speed: "Medium",
        icon: "üß¨"
    },
    extreme_points: {
        name: "Extreme Points Algorithm",
        description: "Precision packing algorithm that identifies optimal placement points. Excellent for tight packing and maximum space utilization.",
        efficiency: "90-94%",
        speed: "Fast",
        icon: "üéØ"
    },
    simulated_annealing: {
        name: "Simulated Annealing",
        description: "Physics-inspired optimization that gradually improves solutions. Great for avoiding local minima and finding global optimum.",
        efficiency: "88-93%",
        speed: "Medium",
        icon: "üî•"
    },
    branch_bound: {
        name: "Branch & Bound",
        description: "Systematic search algorithm that guarantees optimal solutions. Provides mathematically proven best packing arrangements.",
        efficiency: "96-100%",
        speed: "Slow",
        icon: "üå≥"
    },
    hybrid_genetic: {
        name: "Hybrid Genetic Algorithm",
        description: "Combines genetic algorithms with local search improvements. Delivers the highest quality results for complex packing challenges.",
        efficiency: "94-98%",
        speed: "Medium-Slow",
        icon: "üî¨"
    },
    tabu_search: {
        name: "Tabu Search",
        description: "Memory-based search algorithm that avoids previously explored solutions. Excellent for large-scale packing optimization.",
        efficiency: "89-93%",
        speed: "Medium",
        icon: "üß†"
    },
    ant_colony: {
        name: "Ant Colony Optimization",
        description: "Swarm intelligence inspired by ant foraging behavior. Builds solutions through collective intelligence and pheromone trails.",
        efficiency: "87-91%",
        speed: "Medium",
        icon: "üêú"
    },
    particle_swarm: {
        name: "Particle Swarm Optimization",
        description: "Population-based optimization inspired by bird flocking. Explores solution space through collective particle movement.",
        efficiency: "86-90%",
        speed: "Fast",
        icon: "ü¶ã"
    },
    deep_rl: {
        name: "Deep Reinforcement Learning",
        description: "AI-powered algorithm that learns optimal packing strategies through neural networks. Cutting-edge technology for intelligent packing.",
        efficiency: "90-95%",
        speed: "Medium",
        icon: "ü§ñ"
    }
};

// Algorithm selection handler with professional UI updates
document.addEventListener('DOMContentLoaded', function() {
    const algorithmSelect = document.getElementById('algorithmSelect');
    const algorithmDescription = document.getElementById('algorithmDescription');
    const algorithmInfoCard = document.getElementById('algorithmInfo');
    
    if (algorithmSelect && algorithmDescription) {
        // Initialize with default selection
        updateAlgorithmInfo(algorithmSelect.value);
        
        // Update on selection change
        algorithmSelect.addEventListener('change', function() {
            updateAlgorithmInfo(this.value);
        });
    }
});

function updateAlgorithmInfo(algorithmType) {
    const info = algorithmInfo[algorithmType];
    if (info) {
        const description = document.getElementById('algorithmDescription');
        const infoCard = document.getElementById('algorithmInfo');
        
        if (description && infoCard) {
            description.innerHTML = `
                <strong>${info.icon} ${info.name}</strong><br>
                <small>${info.description}</small><br>
                <div class="mt-2">
                    <span class="badge bg-success me-1">Efficiency: ${info.efficiency}</span>
                    <span class="badge bg-primary">Speed: ${info.speed}</span>
                </div>
            `;
        }
    }
}

// Selected Cartons Management for Truck Recommendation
let selectedCartons = [];

// Add carton to recommendation list
function addCartonToRecommendation(cartonId, cartonName, dimensions, weight, volume, quantity) {
    // Check if carton already exists
    const existingIndex = selectedCartons.findIndex(c => c.id === cartonId);
    
    if (existingIndex !== -1) {
        // Update existing carton quantity
        selectedCartons[existingIndex].quantity = parseInt(quantity);
    } else {
        // Add new carton
        selectedCartons.push({
            id: cartonId,
            name: cartonName,
            dimensions: dimensions,
            weight: weight,
            volume: volume,
            quantity: parseInt(quantity)
        });
    }
    
    updateSelectedCartonsDisplay();
}

// Update the display of selected cartons
function updateSelectedCartonsDisplay() {
    const container = document.getElementById('selectedCartonsContainer');
    const emptyMessage = document.getElementById('emptyCartonMessage');
    const listContainer = document.getElementById('selectedCartonsList');
    
    if (selectedCartons.length === 0) {
        emptyMessage.style.display = 'block';
        listContainer.innerHTML = '';
        return;
    }
    
    emptyMessage.style.display = 'none';
    
    let listHtml = '';
    let totalCartons = 0;
    let totalVolume = 0;
    let totalWeight = 0;
    
    selectedCartons.forEach((carton, index) => {
        totalCartons += carton.quantity;
        totalVolume += carton.volume * carton.quantity;
        totalWeight += carton.weight * carton.quantity;
        
        listHtml += `
            <div class="card mb-2 border-success" data-carton-index="${index}">
                <div class="card-body py-2">
                    <div class="row align-items-center">
                        <div class="col-md-5">
                            <div class="d-flex align-items-center">
                                <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                                    <i class="bi bi-box" style="font-size: 14px;"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">${carton.name}</h6>
                                    <small class="text-muted">${carton.dimensions}, ${carton.weight}kg</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Quantity</small>
                            <input type="number" class="form-control form-control-sm" 
                                   value="${carton.quantity}" min="1" max="10000" 
                                   onchange="updateCartonQuantity(${index}, this.value)">
                        </div>
                        <div class="col-md-3">
                            <div class="row text-center">
                                <div class="col">
                                    <small class="text-muted d-block">Volume</small>
                                    <span class="badge bg-light text-dark">${carton.volume.toFixed(2)}m¬≥</span>
                                </div>
                                <div class="col">
                                    <small class="text-muted d-block">Total</small>
                                    <span class="badge bg-info">${(carton.volume * carton.quantity).toFixed(2)}m¬≥</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-1">
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeCartonFromRecommendation(${index})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    // Add summary
    listHtml += `
        <div class="card border-primary mt-3">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i class="bi bi-calculator"></i> Recommendation Summary</h6>
            </div>
            <div class="card-body py-2">
                <div class="row text-center">
                    <div class="col">
                        <small class="text-muted d-block">Total Cartons</small>
                        <strong>${totalCartons}</strong>
                    </div>
                    <div class="col">
                        <small class="text-muted d-block">Total Volume</small>
                        <strong>${totalVolume.toFixed(2)}m¬≥</strong>
                    </div>
                    <div class="col">
                        <small class="text-muted d-block">Total Weight</small>
                        <strong>${totalWeight.toFixed(2)}kg</strong>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    listContainer.innerHTML = listHtml;
}

// Update carton quantity
function updateCartonQuantity(index, newQuantity) {
    if (selectedCartons[index]) {
        selectedCartons[index].quantity = parseInt(newQuantity) || 1;
        updateSelectedCartonsDisplay();
    }
}

// Remove carton from recommendation
function removeCartonFromRecommendation(index) {
    if (confirm('Remove this carton from the recommendation?')) {
        selectedCartons.splice(index, 1);
        updateSelectedCartonsDisplay();
    }
}

// Clear all cartons
function clearAllCartons() {
    if (confirm('Remove all cartons from the recommendation?')) {
        selectedCartons = [];
        updateSelectedCartonsDisplay();
    }
}

function getCartonRequirements() {
    const requirements = [];
    
    // Get requirements from selected cartons
    selectedCartons.forEach(carton => {
        if (carton.quantity > 0) {
            requirements.push({
                carton_id: carton.id,
                quantity: carton.quantity
            });
        }
    });
    
    return requirements;
}

document.getElementById('recommendForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const cartonRequirements = getCartonRequirements();
    
    if (cartonRequirements.length === 0) {
        alert('Please add cartons to get truck recommendations');
        return;
    }
    
    const totalCartons = cartonRequirements.reduce((sum, req) => sum + req.quantity, 0);
    
    // Show loading
    document.getElementById('results').classList.add('d-none');
    document.getElementById('loading').classList.remove('d-none');
    document.getElementById('loading').innerHTML = `
        <div class="spinner-border text-success" role="status">
            <span class="visually-hidden">Analyzing...</span>
        </div>
        <p class="mt-2">Analyzing ${totalCartons} cartons with advanced 3D algorithms...</p>
    `;
    
    try {
        const response = await fetch('/api/recommend-trucks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                carton_requirements: cartonRequirements,
                algorithm: document.getElementById('algorithmSelect') ? document.getElementById('algorithmSelect').value : 'auto',
                compare_algorithms: document.getElementById('compareAlgorithms') ? document.getElementById('compareAlgorithms').checked : false
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showTruckRecommendations(data);
        } else {
            showError(data.error || 'Recommendation failed');
        }
        
    } catch (error) {
        showError('Request failed: ' + error.message);
    }
    
    // Hide loading
    document.getElementById('loading').classList.add('d-none');
    document.getElementById('results').classList.remove('d-none');
});

function showTruckRecommendations(data) {
    const resultDiv = document.getElementById('results');
    
    let cartonInfo = `${data.carton_count} cartons`;
    if (data.carton_summary && data.carton_summary.requirements) {
        const reqDetails = data.carton_summary.requirements
            .map(req => `${req.quantity}√ó${getCartonName(req.carton_id)}`)
            .join(', ');
        cartonInfo = `${data.carton_count} cartons (${reqDetails})`;
    }
    
    let recommendationHtml = '';
    
    if (data.recommendations.length === 0) {
        recommendationHtml = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>No Suitable Trucks Found</strong><br>
                Your carton inventory exceeds the capacity of available trucks.
            </div>
        `;
    } else {
        const bestRecommendation = data.recommendations[0];
        const statusColor = bestRecommendation.fits_all ? 'success' : 'warning';
        const statusText = bestRecommendation.fits_all ? 'Perfect Match!' : 'Best Available';
        const statusIcon = bestRecommendation.fits_all ? 'check-circle-fill' : 'exclamation-triangle-fill';
        
        recommendationHtml = `
            <div class="alert alert-${statusColor} text-center mb-4">
                <i class="bi bi-${statusIcon}" style="font-size: 2rem;"></i>
                <h5 class="mt-2 mb-1">${statusText}</h5>
                <strong>Recommended: ${bestRecommendation.truck_name}</strong>
            </div>
            
            <div class="card border-${statusColor}">
                <div class="card-header bg-${statusColor} text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-truck"></i> ${bestRecommendation.truck_name}
                        <span class="badge bg-light text-dark float-end">Score: ${bestRecommendation.recommendation_score}/100</span>
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-3">
                        <div class="col-3">
                            <div class="h4 text-primary">${bestRecommendation.volume_utilization}%</div>
                            <small class="text-muted">Volume Used</small>
                        </div>
                        <div class="col-3">
                            <div class="h4 text-warning">${bestRecommendation.weight_utilization}%</div>
                            <small class="text-muted">Weight Used</small>
                        </div>
                        <div class="col-3">
                            <div class="h4 text-success">${bestRecommendation.stability_score}%</div>
                            <small class="text-muted">Stability</small>
                        </div>
                        <div class="col-3">
                            <div class="h4 text-info">${bestRecommendation.packed_cartons}/${bestRecommendation.packed_cartons + bestRecommendation.unpacked_cartons}</div>
                            <small class="text-muted">Cartons Fit</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small>Volume Utilization</small>
                            <small>${bestRecommendation.volume_utilization}%</small>
                        </div>
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar" style="width: ${bestRecommendation.volume_utilization}%"></div>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-1">
                            <small>Weight Utilization</small>
                            <small>${bestRecommendation.weight_utilization}%</small>
                        </div>
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar bg-warning" style="width: ${bestRecommendation.weight_utilization}%"></div>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-1">
                            <small>Load Stability</small>
                            <small>${bestRecommendation.stability_score}%</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" style="width: ${bestRecommendation.stability_score}%"></div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">
                                <strong>Assessment:</strong> ${bestRecommendation.recommendation}<br>
                                <strong>Algorithm:</strong> ${bestRecommendation.algorithm}<br>
                                <strong>Analysis Time:</strong> ${data.processing_time}
                            </small>
                        </div>
                        <div class="col-6 text-end">
                            <small class="text-muted">
                                <strong>Total Cartons:</strong> ${cartonInfo}<br>
                                <strong>Trucks Analyzed:</strong> ${data.total_trucks_analyzed}<br>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Show other alternatives if available
        if (data.recommendations.length > 1) {
            recommendationHtml += `
                <div class="mt-3">
                    <h6>Alternative Options:</h6>
            `;
            
            data.recommendations.slice(1, 3).forEach((rec, index) => {
                const altBadgeClass = rec.fits_all ? 'bg-success' : 'bg-warning';
                recommendationHtml += `
                    <div class="card card-body mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${rec.truck_name}</strong> 
                                <span class="badge ${altBadgeClass}">${rec.fits_all ? 'All Fit' : 'Partial'}</span>
                            </div>
                            <div class="text-end">
                                <small>Vol: ${rec.volume_utilization}% | Weight: ${rec.weight_utilization}% | Score: ${rec.recommendation_score}/100</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            recommendationHtml += `</div>`;
        }
    }
    
    resultDiv.innerHTML = recommendationHtml;
}

function getCartonName(cartonId) {
    const cartonNames = {1: 'Small Box', 2: 'Medium Box', 3: 'Large Box'};
    return cartonNames[cartonId] || `Carton ${cartonId}`;
}

function showError(message) {
    document.getElementById('results').innerHTML = `
        <div class="alert alert-danger">
            <strong>Error:</strong> ${message}
        </div>
    `;
}

// Add New Carton Type Modal functionality
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('addCartonForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const cartonData = {
        name: formData.get('name'),
        length: parseFloat(formData.get('length')),
        width: parseFloat(formData.get('width')),
        height: parseFloat(formData.get('height')),
        weight: parseFloat(formData.get('weight')),
        quantity: parseInt(formData.get('quantity')) || 1
    };
    
    try {
        const response = await fetch('/api/cartons', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(cartonData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addCartonModal'));
            modal.hide();
            
            // Show success message
            showToast('Carton type created successfully!', 'success');
            
            // Refresh the page to show the new carton type
            setTimeout(() => {
                window.location.reload();
            }, 1000);
            
        } else {
            showToast('Failed to create carton type: ' + result.error, 'error');
        }
        
    } catch (error) {
        showToast('Request failed: ' + error.message, 'error');
    }
});

function showToast(message, type) {
    const toastHtml = `
        <div class="toast align-items-center text-bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i> ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', toastHtml);
    const toastElement = document.body.lastElementChild;
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    // Remove toast element after it's hidden
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}
}); // End of DOMContentLoaded
</script>

<!-- Add Carton Type Modal -->
<div class="modal fade" id="addCartonModal" tabindex="-1" aria-labelledby="addCartonModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCartonModalLabel">
                    <i class="bi bi-plus-circle text-info"></i> Add New Carton Type
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addCartonForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="cartonName" class="form-label">Carton Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="cartonName" name="name" required placeholder="e.g., Heavy Package, Electronics Box">
                            <div class="form-text">Give your carton type a descriptive name</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="cartonLength" class="form-label">Length (m) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="cartonLength" name="length" step="0.1" min="0.1" max="10" required placeholder="1.5">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="cartonWidth" class="form-label">Width (m) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="cartonWidth" name="width" step="0.1" min="0.1" max="10" required placeholder="1.0">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="cartonHeight" class="form-label">Height (m) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="cartonHeight" name="height" step="0.1" min="0.1" max="10" required placeholder="0.8">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="cartonWeight" class="form-label">Weight (kg) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="cartonWeight" name="weight" step="0.1" min="0.1" max="1000" required placeholder="25.0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="cartonQuantity" class="form-label">Default Quantity</label>
                            <input type="number" class="form-control" id="cartonQuantity" name="quantity" min="1" max="1000" value="1" placeholder="1">
                            <div class="form-text">How many of these do you typically have?</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Volume Calculation:</strong> <span id="volumePreview">Enter dimensions to see volume</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-info">
                        <i class="bi bi-plus-circle"></i> Add Carton Type
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Real-time volume calculation
document.addEventListener('input', function(e) {
    if (['cartonLength', 'cartonWidth', 'cartonHeight'].includes(e.target.id)) {
        const length = parseFloat(document.getElementById('cartonLength').value) || 0;
        const width = parseFloat(document.getElementById('cartonWidth').value) || 0;
        const height = parseFloat(document.getElementById('cartonHeight').value) || 0;
        
        if (length > 0 && width > 0 && height > 0) {
            const volume = length * width * height;
            document.getElementById('volumePreview').textContent = `Volume: ${volume.toFixed(3)} m¬≥`;
        } else {
            document.getElementById('volumePreview').textContent = 'Enter dimensions to see volume';
        }
    }
});

// Algorithm selection and information display
const algorithmInfo = {
    'auto': {
        name: 'Auto-Select Best Algorithm',
        description: 'Automatically chooses the best performing algorithm for your specific carton configuration.',
        complexity: 'Adaptive',
        bestFor: 'Optimal results without complexity'
    },
    'skyline_bl': {
        name: 'Skyline Bottom Left',
        description: 'Fast heuristic maintaining skyline profile for efficient placement.',
        complexity: 'O(n¬≤)',
        bestFor: 'General purpose, fast computation'
    },
    'genetic': {
        name: 'Genetic Algorithm',
        description: 'Evolutionary approach optimizing packing sequences through generations.',
        complexity: 'O(g*p*n)',
        bestFor: 'Complex optimization, high-quality solutions'
    },
    'extreme_points': {
        name: 'Extreme Points',
        description: 'Places items at extreme points of already packed items for tight packing.',
        complexity: 'O(n¬≤)',
        bestFor: 'Tight packing, irregular shapes'
    },
    'simulated_annealing': {
        name: 'Simulated Annealing',
        description: 'Temperature-based optimization that can escape local optima.',
        complexity: 'O(n*t)',
        bestFor: 'Avoiding local minima, quality solutions'
    },
    'branch_bound': {
        name: 'Branch and Bound',
        description: 'Systematic tree search with intelligent pruning for optimal solutions.',
        complexity: 'Exponential (pruned)',
        bestFor: 'Optimal solutions, smaller instances'
    },
    'hybrid_genetic': {
        name: 'Hybrid Genetic + Local Search',
        description: 'Combines genetic algorithm with local improvement for best results.',
        complexity: 'O(g*p*n*l)',
        bestFor: 'Best quality solutions, comprehensive search'
    },
    'tabu_search': {
        name: 'Tabu Search',
        description: 'Memory-based local search that avoids cycling through visited solutions.',
        complexity: 'O(n*iterations)',
        bestFor: 'Local improvement, memory-guided search'
    },
    'ant_colony': {
        name: 'Ant Colony Optimization',
        description: 'Swarm intelligence using pheromone trails to find optimal paths.',
        complexity: 'O(ants*iterations*n)',
        bestFor: 'Path optimization, distributed search'
    },
    'particle_swarm': {
        name: 'Particle Swarm Optimization',
        description: 'Population-based optimization mimicking bird flocking behavior.',
        complexity: 'O(particles*iterations*n)',
        bestFor: 'Continuous optimization adapted to discrete problems'
    },
    'deep_rl': {
        name: 'Deep Reinforcement Learning',
        description: 'Neural network that learns optimal packing policies through experience.',
        complexity: 'O(training) + O(inference)',
        bestFor: 'Adaptive learning, complex pattern recognition'
    }
};

document.addEventListener('DOMContentLoaded', function() {
    // Algorithm selection handler
    document.getElementById('algorithmSelect').addEventListener('change', function(e) {
        const selectedAlgorithm = e.target.value;
        const info = algorithmInfo[selectedAlgorithm];
        
        if (info) {
            document.getElementById('algorithmDescription').innerHTML = `
                <strong>${info.name}</strong><br>
                ${info.description}<br>
                <span class="text-muted">Complexity: ${info.complexity} | Best for: ${info.bestFor}</span>
            `;
        }
    });
});

// Load available cartons for selection modal
async function loadAvailableCartons() {
    try {
        const response = await fetch('/api/cartons');
        const data = await response.json();
        
        const select = document.getElementById('availableCartonSelect');
        select.innerHTML = '<option value="">-- Select a carton type --</option>';
        
        if (data.success && data.cartons) {
            // Get currently displayed cartons to avoid duplicates
            const displayedCartonIds = Array.from(document.querySelectorAll('.carton-selection-card')).map(card => 
                parseInt(card.dataset.cartonId)
            );
            
            data.cartons.forEach(carton => {
                // Only show cartons that aren't already in the selection
                if (!displayedCartonIds.includes(carton.id)) {
                    const option = document.createElement('option');
                    option.value = carton.id;
                    option.textContent = `${carton.name} (${carton.length}√ó${carton.width}√ó${carton.height}m, ${carton.weight}kg)`;
                    option.dataset.cartonData = JSON.stringify(carton);
                    select.appendChild(option);
                }
            });
        }
    } catch (error) {
        console.error('Error loading available cartons:', error);
    }
}

// Handle carton selection preview
document.getElementById('availableCartonSelect').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const preview = document.getElementById('selectedCartonPreview');
    
    if (selectedOption.value && selectedOption.dataset.cartonData) {
        const carton = JSON.parse(selectedOption.dataset.cartonData);
        const volume = (carton.length * carton.width * carton.height).toFixed(3);
        
        document.getElementById('cartonPreviewContent').innerHTML = `
            <div class="row">
                <div class="col-md-8">
                    <h6>${carton.name}</h6>
                    <p class="text-muted mb-1">Dimensions: ${carton.length} √ó ${carton.width} √ó ${carton.height} meters</p>
                    <p class="text-muted mb-0">Weight: ${carton.weight} kg | Volume: ${volume} m¬≥</p>
                </div>
                <div class="col-md-4 text-center">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto" style="width: 48px; height: 48px;">
                        <i class="bi bi-box"></i>
                    </div>
                </div>
            </div>
        `;
        preview.style.display = 'block';
    } else {
        preview.style.display = 'none';
    }
});

// Handle select carton form submission
document.getElementById('selectCartonForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const cartonId = document.getElementById('availableCartonSelect').value;
    const quantity = document.getElementById('initialQuantity').value || 10;
    
    if (!cartonId) {
        alert('Please select a carton type');
        return;
    }
    
    // Set the quantity for the selected carton
    const quantityInput = document.getElementById('quantity' + cartonId);
    if (quantityInput) {
        quantityInput.value = quantity;
        updateCartonSelection(cartonId);
    }
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('selectCartonModal'));
    modal.hide();
    
    // Refresh carton list to update display
    refreshCartonList();
});

// Add Carton to Recommendation Modal Handlers
document.getElementById('addCartonToRecommendationModal').addEventListener('show.bs.modal', async function() {
    try {
        const response = await fetch('/api/cartons');
        const data = await response.json();
        
        const select = document.getElementById('recommendationCartonSelect');
        select.innerHTML = '<option value="">-- Select a carton type --</option>';
        
        if (data.success && data.cartons) {
            data.cartons.forEach(carton => {
                const option = document.createElement('option');
                option.value = carton.id;
                option.textContent = `${carton.name} (${carton.length}√ó${carton.width}√ó${carton.height}m, ${carton.weight}kg)`;
                option.dataset.cartonData = JSON.stringify(carton);
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading cartons:', error);
    }
});

// Handle carton selection preview for recommendation
document.getElementById('recommendationCartonSelect').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const preview = document.getElementById('recommendationCartonPreview');
    
    if (selectedOption.value && selectedOption.dataset.cartonData) {
        const carton = JSON.parse(selectedOption.dataset.cartonData);
        const volume = (carton.length * carton.width * carton.height).toFixed(3);
        
        document.getElementById('recommendationCartonPreviewContent').innerHTML = `
            <div class="row">
                <div class="col-md-8">
                    <h6>${carton.name}</h6>
                    <p class="text-muted mb-1">Dimensions: ${carton.length} √ó ${carton.width} √ó ${carton.height} meters</p>
                    <p class="text-muted mb-0">Weight: ${carton.weight} kg | Volume: ${volume} m¬≥</p>
                </div>
                <div class="col-md-4 text-center">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto" style="width: 48px; height: 48px;">
                        <i class="bi bi-box"></i>
                    </div>
                </div>
            </div>
        `;
        preview.style.display = 'block';
    } else {
        preview.style.display = 'none';
    }
});

// Handle add carton to recommendation form submission
document.getElementById('addCartonToRecommendationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const cartonSelect = document.getElementById('recommendationCartonSelect');
    const quantityInput = document.getElementById('recommendationCartonQuantity');
    
    const cartonId = parseInt(cartonSelect.value);
    const quantity = parseInt(quantityInput.value);
    
    if (!cartonId || !quantity || quantity < 1) {
        alert('Please select a carton type and enter a valid quantity');
        return;
    }
    
    const selectedOption = cartonSelect.options[cartonSelect.selectedIndex];
    const cartonData = JSON.parse(selectedOption.dataset.cartonData);
    
    const dimensions = `${cartonData.length}√ó${cartonData.width}√ó${cartonData.height}m`;
    const volume = cartonData.length * cartonData.width * cartonData.height;
    
    addCartonToRecommendation(
        cartonId,
        cartonData.name,
        dimensions,
        cartonData.weight,
        volume,
        quantity
    );
    
    // Close modal and reset form
    const modal = bootstrap.Modal.getInstance(document.getElementById('addCartonToRecommendationModal'));
    modal.hide();
    
    // Reset form
    cartonSelect.value = '';
    quantityInput.value = '';
    document.getElementById('recommendationCartonPreview').style.display = 'none';
});

// Handle bulk upload carton form
document.getElementById('bulkUploadCartonForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const fileInput = document.getElementById('bulkCartonFile');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select a CSV or Excel file');
        return;
    }
    
    // Read and process the file
    const text = await file.text();
    const lines = text.split('\n');
    
    // Parse CSV
    const cartons = [];
    let errors = [];
    
    for (let i = 1; i < lines.length; i++) { // Skip header
        const line = lines[i].trim();
        if (line) {
            const parts = line.split(',');
            if (parts.length >= 2) {
                const cartonName = parts[0].trim();
                const quantity = parseInt(parts[1].trim());
                
                if (cartonName && quantity > 0) {
                    cartons.push({ name: cartonName, quantity: quantity });
                } else {
                    errors.push(`Line ${i + 1}: Invalid data`);
                }
            }
        }
    }
    
    if (cartons.length === 0) {
        alert('No valid carton data found in the file');
        return;
    }
    
    // Match cartons with existing inventory
    try {
        const response = await fetch('/api/cartons');
        const data = await response.json();
        
        if (data.success && data.cartons) {
            let addedCount = 0;
            
            cartons.forEach(csvCarton => {
                const matchedCarton = data.cartons.find(c => 
                    c.name.toLowerCase() === csvCarton.name.toLowerCase()
                );
                
                if (matchedCarton) {
                    const dimensions = `${matchedCarton.length}√ó${matchedCarton.width}√ó${matchedCarton.height}m`;
                    const volume = matchedCarton.length * matchedCarton.width * matchedCarton.height;
                    
                    addCartonToRecommendation(
                        matchedCarton.id,
                        matchedCarton.name,
                        dimensions,
                        matchedCarton.weight,
                        volume,
                        csvCarton.quantity
                    );
                    addedCount++;
                } else {
                    errors.push(`Carton "${csvCarton.name}" not found in inventory`);
                }
            });
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('bulkUploadCartonModal'));
            modal.hide();
            
            // Show results
            if (addedCount > 0) {
                alert(`Successfully added ${addedCount} carton types to recommendation.${errors.length > 0 ? '\\n\\nErrors:\\n' + errors.join('\\n') : ''}`);
            } else {
                alert('No cartons were added. Please check that carton names match your inventory.');
            }
            
            // Reset form
            fileInput.value = '';
            
        } else {
            alert('Failed to load carton inventory');
        }
    } catch (error) {
        alert('Error processing bulk upload: ' + error.message);
    }
});
</script>

<!-- Add Carton to Recommendation Modal -->
<div class="modal fade" id="addCartonToRecommendationModal" tabindex="-1" aria-labelledby="addCartonToRecommendationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCartonToRecommendationModalLabel">
                    <i class="bi bi-plus-circle text-success"></i> Add Carton to Truck Recommendation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addCartonToRecommendationForm">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Select a carton type and quantity for truck recommendation.
                    </div>
                    
                    <div class="mb-3">
                        <label for="recommendationCartonSelect" class="form-label">Choose Carton Type <span class="text-danger">*</span></label>
                        <select class="form-select" id="recommendationCartonSelect" required>
                            <option value="">-- Select a carton type --</option>
                        </select>
                        <div class="form-text">Select from your available carton inventory</div>
                    </div>
                    
                    <div class="mb-3" id="recommendationCartonPreview" style="display: none;">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="bi bi-box"></i> Selected Carton Details</h6>
                            </div>
                            <div class="card-body" id="recommendationCartonPreviewContent">
                                <!-- Carton details will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="recommendationCartonQuantity" class="form-label">Quantity <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="recommendationCartonQuantity" min="1" max="10000" placeholder="Enter quantity" required>
                        <div class="form-text">How many of this carton type do you need to pack?</div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> <strong>Don't see your carton type?</strong> 
                        Use the <a href="/cartons" class="alert-link">Carton Management</a> page to create new carton types first.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-plus"></i> Add to Recommendation
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Upload Carton CSV Modal -->
<div class="modal fade" id="bulkUploadCartonModal" tabindex="-1" aria-labelledby="bulkUploadCartonModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkUploadCartonModalLabel">
                    <i class="bi bi-upload text-primary"></i> Bulk Upload Carton Quantities for Recommendation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="bulkUploadCartonForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Upload a CSV file with carton types and quantities for truck recommendation.
                    </div>
                    
                    <div class="mb-3">
                        <label for="bulkCartonFile" class="form-label">CSV File <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" id="bulkCartonFile" accept=".csv,.xlsx,.xls" required>
                        <div class="form-text">Upload CSV or Excel file with carton quantities</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-info-circle"></i> CSV Format Required</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-2"><strong>CSV should have these columns:</strong></p>
                            <code>carton_name,quantity</code>
                            <br><br>
                            <p class="mb-2"><strong>Example:</strong></p>
                            <pre class="bg-light p-2 rounded">Small Box,25
Medium Box,15
Large Box,10
Heavy Package,5</pre>
                        </div>
                    </div>
                    
                    <div id="bulkUploadPreview" class="mt-3" style="display: none;">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="bi bi-check-circle"></i> Upload Preview</h6>
                            </div>
                            <div class="card-body" id="bulkUploadPreviewContent">
                                <!-- Preview content will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-upload"></i> Upload & Add to Recommendation
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}